                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <title>TRAC - Artist Portal</title>
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        /* BASIC RESET */
                        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Space Grotesk', sans-serif; }
                        body { 
                            background: #ffffff; 
                            color: #000000; 
                            line-height: 1.6; 
                            font-weight: 400;
                            min-height: 100vh;
                            margin: 0;
                            padding: 0;
                        }

                        /* HIDE EVERYTHING UNTIL JAVASCRIPT LOADS */
                        body { opacity: 0; }
                        body.loaded { opacity: 1; transition: opacity 0.2s ease; }

                        /* LOGIN STYLES */
                        #login-section { 
                            background: white; 
                            min-height: 100vh; 
                            display: grid; 
                            place-items: center; 
                            justify-content: center;
                            padding: 2rem; 
                        }
                        .login-container { width: 100%; max-width: 440px; }
                        .login-header { text-align: center; margin-bottom: 3rem; }
                        .login-header h1 { font-size: 2rem; font-weight: 500; margin-bottom: 0.75rem; letter-spacing: -0.02em; }
                        .login-header .tagline { color: #666; font-size: 1rem; font-weight: 400; }
                        .auth-form { background: white; border: 1px solid #e5e5e5; border-radius: 12px; padding: 2.5rem; }
                        .form-header { text-align: center; margin-bottom: 2.5rem; }
                        .form-header h2 { font-size: 1.25rem; font-weight: 500; margin-bottom: 0.5rem; }
                        .form-header p { color: #666; font-size: 0.9rem; }
                        .form-group { margin-bottom: 1rem; }
                        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 0.5rem; color: #333; font-weight: 500; }
                        .form-group input { width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; background: white; }
                        .form-group input:focus { outline: none; border-color: #000; }
                        .auth-button { width: 100%; background: #000; color: white; border: none; padding: 1rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; border-radius: 8px; margin-bottom: 1.5rem; }
                        .auth-button:hover { opacity: 0.9; }
                        .auth-button:disabled { opacity: 0.5; cursor: not-allowed; }
                        .auth-switch { text-align: center; padding-top: 1.5rem; border-top: 1px solid #f0f0f0; }
                        .auth-switch p { color: #666; font-size: 0.85rem; }
                        .auth-switch a { color: #000; text-decoration: underline; }
                        .message { margin: 1rem 0; padding: 0.875rem; border-radius: 8px; font-size: 0.85rem; text-align: center; }

                        /* DASHBOARD HEADER */
                        .gallery-header { background: white; border-bottom: 1px solid #e5e5e5; padding: 1rem 0; position: sticky; top: 0; z-index: 100; }
                        .header-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
                        .header-left { display: flex; align-items: center; gap: 3rem; }
                        .logo-container { background: #000000; border-radius: 12px; padding: 0.75rem 1.25rem; display: inline-flex; align-items: center; justify-content: center; }
                        .gallery-logo { font-size: 2.2rem; font-weight: 600; letter-spacing: -0.02em; color: #ffffff; margin: 0; line-height: 1; }
                        .gallery-nav { display: flex; gap: 2rem; }
                        .nav-item { text-decoration: none; color: #666; font-size: 0.85rem; font-weight: 400; transition: color 0.2s; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; }
                        .nav-item.active, .nav-item:hover { color: #000; }
                        .header-right { display: flex; gap: 1rem; }
                        .icon-button { background: none; border: none; padding: 0.5rem; cursor: pointer; color: #666; transition: color 0.2s; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
                        .icon-button:hover { color: #000; background: #f5f5f5; }

                        /* DASHBOARD CONTENT */
                        .gallery-main { padding: 0; }
                        .hero-section { padding: 3rem 0 2rem; text-align: center; }
                        .hero-container { max-width: 800px; margin: 0 auto; padding: 0 2rem; }
                        .hero-title { font-size: 2.25rem; font-weight: 500; margin-bottom: 0.75rem; letter-spacing: -0.02em; }
                        .hero-subtitle { font-size: 1rem; color: #666; font-weight: 400; }
                        .stats-section { padding: 2rem 0; border-bottom: 1px solid #e5e5e5; }
                        .stats-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; }
                        .stat-item { text-align: center; }
                        .stat-number { font-size: 2rem; font-weight: 400; margin-bottom: 0.5rem; letter-spacing: -0.02em; }
                        .stat-label { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; }
                        .artworks-section { padding: 4rem 0; }
                        .section-header { max-width: 1400px; margin: 0 auto 3rem; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
                        .section-title { font-size: 1.25rem; font-weight: 500; letter-spacing: -0.02em; }
                        .add-artwork-btn { background: #000; color: white; border: none; padding: 0.75rem 1.5rem; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; border-radius: 8px; }
                        .add-artwork-btn:hover { opacity: 0.9; }
                        .add-artwork-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                        .artworks-grid {
                            max-width: 1400px;
                            margin: 0 auto;
                            padding: 0 1rem;
                            display: grid;
                            gap: 1rem;
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                        }                        

                        /* Mobile styles */
                        @media (max-width: 768px) {
                            .artworks-grid {
                                grid-template-columns: 1fr;
                                padding: 0 0.5rem;
                                gap: 1.5rem;
                            }
                        }
                        .empty-state { grid-column: 1 / -1; text-align: center; padding: 4rem 2rem; }
                        .empty-icon { font-size: 3rem; margin-bottom: 1.5rem; }
                        .empty-state h4 { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem; }
                        .empty-state p { color: #666; margin-bottom: 2rem; font-size: 0.9rem; }
                        .cta-button { background: #000; color: white; border: none; padding: 1rem 2rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; border-radius: 8px; }
                        .cta-button:hover { opacity: 0.9; }
                        .cta-button:disabled { opacity: 0.5; cursor: not-allowed; }
                        .artwork-card { 
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                            margin-bottom: 0;
                            padding-bottom: 0;
                            transition: transform 0.2s ease;
                        }

                        .artwork-card:hover {
                            transform: translateY(-2px);
                        }

                        .artwork-info {
                            padding: 0;
                            max-width: 100%;
                            word-wrap: break-word;
                        }
                        .artwork-title { 
                            font-size: 0.8rem;
                            font-weight: 500; 
                            margin-bottom: 0.2rem; 
                        }
                        .artwork-details { 
                            color: #666; 
                            font-size: 0.7rem;
                            line-height: 1.2;
                            max-width: 100%;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        .artwork-details div {
                            max-width: 100%;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        .artwork-actions {
                            margin-top: 1rem;
                        }
                        .delete-btn {
                            background: none;
                            border: none;
                            color: #999;
                            font-size: 0.7rem;
                            cursor: pointer;
                            text-decoration: underline;
                            padding: 0;
                        }
                        .delete-btn:hover {
                            color: #ff4444;
                        }

                        /* Events Styles */
                        .event-card {
                            border: 1px solid #e5e5e5;
                            border-radius: 8px;
                            padding: 1.5rem;
                            background: white;
                            transition: box-shadow 0.2s ease;
                        }
                        .event-card:hover {
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        }
                        .event-date {
                            font-size: 0.8rem;
                            color: #666;
                            margin-bottom: 0.5rem;
                        }
                        .event-title {
                            font-size: 1rem;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                            color: #000;
                        }
                        .event-location {
                            font-size: 0.8rem;
                            color: #666;
                            margin-bottom: 0.75rem;
                        }
                        .event-description {
                            font-size: 0.8rem;
                            color: #333;
                            line-height: 1.4;
                            margin-bottom: 1rem;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                            max-width: 100%;
                        }
                        .event-actions {
                            display: flex;
                            gap: 0.5rem;
                            justify-content: flex-end;
                        }

                        /* Activity Section */
                        .activity-section { 
                            padding: 1.5rem 0; 
                            border-top: 1px solid #e5e5e5; 
                        }
                        .activity-list { 
                        }
                        .activity-item { 
                            display: flex; 
                            gap: 0.75rem; 
                            padding: 0.5rem 0; 
                            border-bottom: 1px solid #f0f0f0; 
                        }

                        .activity-dot { 
                            width: 6px; 
                            height: 6px; 
                            background: #000; 
                            border-radius: 50%; 
                            margin-top: 0.4rem; 
                            flex-shrink: 0; 
                        }

                        .activity-content p { 
                            margin-bottom: 0.2rem; 
                            font-size: 0.75rem; 
                            line-height: 1.3;
                            color: #333;
                        }

                        .activity-time { 
                            font-size: 0.65rem; 
                            color: #666; 
                        }

                        /* Timeline Filter Styles */
                        .timeline-filter {
                            background: #f5f5f5;
                            border: 1px solid #e5e5e5;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            font-size: 0.8rem;
                            cursor: pointer;
                            transition: all 0.2s;
                        }

                        .timeline-filter:hover {
                            background: #e5e5e5;
                        }

                        .timeline-filter.active {
                            background: #000;
                            color: white;
                            border-color: #000;
                        }

                        /* UPLOAD FORM */
                        .upload-form-container { max-width: 800px; margin: 0 auto 3rem; padding: 0 2rem; }
                        .upload-form { background: white; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; }
                        .upload-form .form-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; margin: 0; }
                        .upload-form .form-header h4 { font-size: 1.1rem; font-weight: 500; margin: 0; }
                        .close-form { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
                        .close-form:hover { color: #000; background: #f5f5f5; }
                        .form-body { padding: 2rem; }
                        .upload-zone { border: 2px dashed #d1d1d1; border-radius: 12px; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 2rem; background: #fafafa; }
                        .upload-zone:hover { border-color: #000; background: #f5f5f5; }
                        .upload-zone.dragover { border-color: #000; background: #f0f0f0; }
                        .upload-placeholder span { display: block; }
                        .upload-placeholder span:first-child { font-size: 1rem; margin-bottom: 0.5rem; font-weight: 500; }
                        .upload-subtitle { color: #666; font-size: 0.85rem; }
                        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
                        .form-actions { display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem 2rem; border-top: 1px solid #e5e5e5; background: #fafafa; }
                        .btn-secondary { background: transparent; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border-radius: 8px; }
                        .btn-secondary:hover { background: #f5f5f5; }
                        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
                        .btn-primary { background: #000; color: white; border: none; padding: 0.75rem 1.5rem; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; border-radius: 8px; }
                        .btn-primary:hover { opacity: 0.9; }
                        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
                        .image-preview { text-align: center; }
                        .image-preview img { max-width: 100%; max-height: 300px; }

                        /* PROFILE SETTINGS STYLES */
                        .form-section { margin-bottom: 2rem; }
                        .form-section h3 { font-size: 0.85rem; font-weight: 500; margin-bottom: 1rem; color: #000; text-transform: uppercase; letter-spacing: 0.05em; }
                        .terms-group { display: flex; align-items: flex-start; gap: 0.75rem; margin: 2rem 0; padding: 1rem 0; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }
                        .terms-group input[type="checkbox"] { margin-top: 0.2rem; }
                        .terms-group label { font-size: 0.85rem; color: #333; line-height: 1.4; }
                        .terms-group a { color: #000; text-decoration: underline; }
                        .social-platform-item { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #f0f0f0; border-radius: 8px; background: #fafafa; }

                        /* PORTFOLIO STYLES */
                        .portfolio-header { 
                            background: var(--bg-color, white);
                            border-bottom: 1px solid var(--border-color, #e5e5e5); 
                            padding: 1rem 0; 
                            position: sticky; 
                            top: 0; 
                            z-index: 100; 
                        }
                        .portfolio-header .header-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
                        .portfolio-header .header-left { display: flex; align-items: center; gap: 3rem; }
                        .portfolio-header .header-right { display: flex; gap: 2rem; align-items: center; }
                        .artist-name { font-size: 1.5rem; font-weight: 500; color: var(--text-color, #000000); }
                        .portfolio-nav { display: flex; gap: 2rem; }

                        /* Mobile navigation */
                        @media (max-width: 768px) {
                            .portfolio-nav {
                                gap: 1rem;
                                flex-wrap: wrap;
                                justify-content: center;
                            }
                            .portfolio-nav .nav-item {
                                font-size: 0.8rem;
                                padding: 0.5rem 1rem;
                                background: #f5f5f5;
                                border-radius: 6px;
                            }
                        }

                        /* PORTFOLIO LAYOUT CLASSES - FIXED & CLEANED */
                        .portfolio-layout.grid-classic {
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            gap: 2rem;
                            justify-content: center;
                            margin: 0 auto;
                            justify-items: center;
                        }

                        .portfolio-layout.grid-masonry {
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            grid-auto-rows: 10px;
                            gap: 2rem;
                            justify-content: center;
                            margin: 0 auto;
                            justify-items: center;
                        }

                        .portfolio-layout.grid-masonry .artwork-card {
                            grid-row-end: span 45;
                            text-align: center;
                        }

                        .portfolio-layout.grid-masonry .artwork-card:nth-child(odd) {
                            grid-row-end: span 40;
                        }

                        .portfolio-layout.grid-masonry .artwork-card:nth-child(3n) {
                            grid-row-end: span 50;
                        }

                        .portfolio-layout.stacked-minimal {
                            grid-template-columns: 1fr;
                            max-width: 900px;
                            margin: 0 auto;
                            gap: 4rem;
                        }

                        .portfolio-layout.stacked-minimal .artwork-card {
                            text-align: center;
                            padding: 3rem 0;
                            border-bottom: 1px solid var(--border-color, #e5e5e5);
                        }

                        .portfolio-layout.stacked-minimal .artwork-card:last-child {
                            border-bottom: none;
                        }

                        .portfolio-layout.stacked-minimal .artwork-image {
                            margin-bottom: 2rem;
                        }

                        .portfolio-layout.stacked-minimal .artwork-title {
                            font-size: 2rem;
                            margin-bottom: 1rem;
                        }

                        /* GUERRILLA MINIMAL */
                        .portfolio-layout.guerrilla-grid {
                            grid-template-columns: 1fr;
                            gap: 0;
                            margin: 0;
                            padding: 0;
                        }

                        .portfolio-layout.guerrilla-grid .artwork-card {
                            margin: 0;
                            border: none;
                            border-radius: 0;
                        }

                        .portfolio-layout.guerrilla-grid .artwork-image img {
                            width: 100%;
                            height: auto;
                            display: block;
                        }

                        /* ELEGANT GALLERY */
                        .portfolio-layout.gallery-spaced {
                            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                            gap: 4rem;
                            padding: 4rem;
                            max-width: 1400px;
                            margin: 0 auto;
                        }

                        .portfolio-layout.gallery-spaced .artwork-card {
                            padding: 2rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            background: var(--bg-color);
                        }

                        /* EXPERIMENTAL IMMERSIVE */
                        .portfolio-layout.immersive-stacked {
                            grid-template-columns: 1fr;
                            grid-auto-rows: 100vh;
                            gap: 0;
                            margin: 0;
                            padding: 0;
                        }

                        .portfolio-layout.immersive-stacked .artwork-card {
                            height: 100vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0;
                        }

                        .portfolio-layout.immersive-stacked .artwork-image img {
                            max-height: 90vh;
                            width: auto;
                            max-width: 90vw;
                        }

                        /* MONUMENTAL SCULPTURAL */
                        .portfolio-layout.monumental-asymmetric {
                            grid-template-columns: 2fr 1fr 1fr;
                            gap: 2rem;
                            grid-auto-rows: minmax(300px, auto);
                        }

                        .portfolio-layout.monumental-asymmetric .artwork-card:nth-child(3n+1) {
                            grid-column: 1 / 3;
                            grid-row: span 2;
                        }

                        .portfolio-layout.monumental-asymmetric .artwork-card:nth-child(3n+2) {
                            grid-column: 3 / 4;
                        }

                        .portfolio-layout.monumental-asymmetric .artwork-card:nth-child(3n+3) {
                            grid-column: 3 / 4;
                        }

                        /* HISTORICAL LAYERED */
                        .portfolio-layout.historical-overlap {
                            grid-template-columns: repeat(12, 1fr);
                            grid-auto-rows: minmax(200px, auto);
                            gap: 1rem;
                            grid-auto-flow: dense;
                        }

                        .portfolio-layout.historical-overlap .artwork-card:nth-child(odd) {
                            grid-column: span 6;
                            grid-row: span 2;
                        }

                        .portfolio-layout.historical-overlap .artwork-card:nth-child(even) {
                            grid-column: span 4;
                            grid-row: span 1;
                        }

                        .portfolio-layout.historical-overlap .artwork-card:nth-child(3n) {
                            grid-column: span 3;
                            transform: rotate(-1deg);
                        }

                        .portfolio-layout.historical-overlap .artwork-card:nth-child(4n) {
                            grid-column: span 3;
                            transform: rotate(1deg);
                        }

                        /* COLORFUL VIBRANT */
                        .portfolio-layout.vibrant-mosaic {
                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            grid-auto-rows: 200px;
                            gap: 0.5rem;
                        }

                        .portfolio-layout.vibrant-mosaic .artwork-card {
                            margin: 0;
                            border-radius: 0;
                            overflow: hidden;
                        }

                        .portfolio-layout.vibrant-mosaic .artwork-image img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        /* ABSTRACT EXPRESSIONIST */
                        .portfolio-layout.abstract-random {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 1rem;
                            justify-content: center;
                            padding: 2rem;
                        }

                        .portfolio-layout.abstract-random .artwork-card {
                            flex: 0 1 auto;
                            margin: 0;
                            transform: rotate(var(--rotation, 0deg));
                        }

                        .portfolio-layout.abstract-random .artwork-card:nth-child(odd) {
                            --rotation: -2deg;
                        }

                        .portfolio-layout.abstract-random .artwork-card:nth-child(even) {
                            --rotation: 1deg;
                        }

                        .portfolio-layout.abstract-random .artwork-card:nth-child(3n) {
                            --rotation: 3deg;
                        }

                        .portfolio-layout.abstract-random .artwork-image {
                            width: 280px;
                            height: 280px;
                        }

                        .portfolio-layout.abstract-random .artwork-image img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        /* STORYTELLING QUILT */
                        .portfolio-layout.quilt-narrative {
                            grid-template-columns: repeat(4, 1fr);
                            grid-template-rows: repeat(3, 300px);
                            gap: 1rem;
                        }

                        .portfolio-layout.quilt-narrative .artwork-card:nth-child(1) {
                            grid-column: 1 / 3;
                            grid-row: 1 / 3;
                        }

                        .portfolio-layout.quilt-narrative .artwork-card:nth-child(2) {
                            grid-column: 3 / 5;
                            grid-row: 1 / 2;
                        }

                        .portfolio-layout.quilt-narrative .artwork-card:nth-child(3) {
                            grid-column: 3 / 4;
                            grid-row: 2 / 3;
                        }

                        .portfolio-layout.quilt-narrative .artwork-card:nth-child(4) {
                            grid-column: 4 / 5;
                            grid-row: 2 / 4;
                        }

                        .portfolio-layout.quilt-narrative .artwork-image img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        /* CONTEMPORARY DIGITAL */
                        .portfolio-layout.digital-floating {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 2rem;
                            transform: rotate(-1deg);
                            padding: 3rem;
                        }

                        .portfolio-layout.digital-floating .artwork-card {
                            transform: rotate(var(--rotation, 0deg));
                            transition: transform 0.3s ease;
                        }

                        .portfolio-layout.digital-floating .artwork-card:nth-child(odd) {
                            --rotation: 1deg;
                        }

                        .portfolio-layout.digital-floating .artwork-card:nth-child(even) {
                            --rotation: -1deg;
                        }

                        .portfolio-layout.digital-floating .artwork-card:hover {
                            transform: rotate(0deg) scale(1.05);
                            z-index: 2;
                        }

                        /* POLITICAL ARCHIVAL */
                        .portfolio-layout.archival-dossier {
                            grid-template-columns: 1fr;
                            border: 1px solid var(--border-color);
                            padding: 3rem;
                            background: var(--bg-color);
                            margin: 2rem;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }

                        .portfolio-layout.archival-dossier .artwork-card {
                            border-bottom: 1px solid var(--border-color);
                            padding: 2rem 0;
                            margin: 0;
                        }

                        .portfolio-layout.archival-dossier .artwork-card:last-child {
                            border-bottom: none;
                        }

                        .portfolio-layout.archival-dossier .artwork-image {
                            max-width: 400px;
                            margin: 0 auto 1rem;
                        }

                        .portfolio-layout.card-modern .artwork-card {
                            background: var(--bg-color, white);
                            border: 2px solid var(--border-color, #e5e5e5);
                            border-radius: 16px;
                            padding: 2rem;
                            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                            transition: transform 0.3s ease, box-shadow 0.3s ease;
                            text-align: center;
                        }

                        .portfolio-layout.card-modern .artwork-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
                        }

                        .portfolio-layout.card-modern .artwork-info {
                            padding: 1.5rem 0 0 0;
                            border-top: 1px solid var(--border-color, #e5e5e5);
                        }

                        .portfolio-layout.magazine {
                            grid-template-columns: 1fr 1fr;
                            grid-template-areas: 
                                "featured featured"
                                "secondary secondary";
                            gap: 3rem;
                        }

                        .portfolio-layout.magazine .artwork-card:first-child {
                            grid-area: featured;
                        }

                        .portfolio-layout.magazine .artwork-card:first-child .artwork-image {
                            max-height: 70vh;
                        }

                        .portfolio-layout.magazine .artwork-card:first-child .artwork-title {
                            font-size: 2.5rem;
                            text-align: center;
                            margin: 2rem 0;
                        }

                        .portfolio-layout.portfolio-focused {
                            grid-template-columns: 1fr;
                            gap: 4rem;
                        }

                        .portfolio-layout.portfolio-focused .artwork-card:first-child {
                            min-height: 80vh;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            text-align: center;
                        }

                        .portfolio-layout.portfolio-focused .artwork-card:first-child .artwork-title {
                            font-size: 3rem;
                            margin: 3rem 0;
                        }

                        .portfolio-layout.portfolio-focused .artwork-card:not(:first-child) {
                            max-width: 600px;
                            margin: 0 auto;
                        }

                        /* PORTFOLIO SIZE CLASSES - FIXED */
                        .artworks-grid.small {
                            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                            gap: 1.5rem;
                        }

                        .artworks-grid.medium {
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                            gap: 2rem;
                        }

                        .artworks-grid.large {
                            grid-template-columns: repeat(auto-fill, minmax(370px, 1fr));
                            gap: 1rem;
                            grid-template-rows: auto auto;
                        }

                        /* Portfolio-specific size overrides */
                        #portfolioPage .artworks-grid.small {
                            gap: 4rem;
                        }

                        /* Natural image sizing */
                        .artwork-image {
                            width: auto;
                            max-width: 100%;
                            position: relative;
                            overflow: hidden;
                            margin-bottom: 0;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            background: #f5f5f5;
                            min-height: 200px;
                        }

                        .artwork-image img {
                            transition: opacity 0.3s ease;
                            opacity: 0;
                        }

                        .artwork-image img[src] {
                            opacity: 1;
                        }
                        
                        .artwork-image img {
                            width: auto;
                            max-width: 100%;
                            height: auto;
                            display: block;
                        }

                        /* Portfolio image enforcement */
                        #portfolioPage .artwork-image img {
                            width: 100%;
                            height: auto;
                            transition: opacity 0.3s ease;
                        }

                        #portfolioPage .artwork-image {
                            background: #f5f5f5;
                            min-height: 300px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }

                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }

                        .artwork-image img {
                            animation: fadeIn 0.5s ease-in-out;
                        }

                        /* Better loading states */
                        .artwork-image.loading {
                            background: linear-gradient(90deg, #f5f5f5 25%, #e8e8e8 50%, #f5f5f5 75%);
                            background-size: 200% 100%;
                            animation: loading 1.5s infinite;
                        }

                        @keyframes loading {
                            0% { background-position: 200% 0; }
                            100% { background-position: -200% 0; }
                        }

                        /* PORTFOLIO STYLE PRESETS */
                        #portfolioPage {
                            min-height: 100vh;
                            position: relative;
                            padding-bottom: 80px;
                        }

                        #portfolioPage {
                            --collection-title-size: 16px;
                            --collection-statement-size: 16px;
                        }

                        /* Style application bridge */
                        #portfolioPage.style-applied {
                            background: var(--bg-color, white);
                            color: var(--text-color, #000000);
                        }

                        /* ACCENT COLOR APPLICATIONS */
                        #portfolioPage.style-applied .portfolio-nav .nav-item.active,
                        #portfolioPage.style-applied .portfolio-nav .nav-item:hover {
                            color: var(--accent-color, #000000);
                        }

                        #portfolioPage.style-applied .section-title {
                            color: var(--titles-color, var(--text-color, #000000));
                            border-bottom: 2px solid var(--accent-color, #666666);
                        }

                        #portfolioPage.style-applied .artwork-title {
                            color: var(--artwork-details-color, var(--text-color, #333333));
                        }

                        .style-minimal-dark {
                            --bg-color: #000000;
                            --text-color: #ffffff;
                            --accent-color: #ff6b6b;
                            --border-color: #333333;
                        }

                        .style-gallery-bright {
                            --bg-color: #ffffff;
                            --text-color: #333333;
                            --accent-color: #000000;
                            --border-color: #e5e5e5;
                        }

                        .style-warm-modern {
                            --bg-color: #f8f4e9;
                            --text-color: #5a4a3a;
                            --accent-color: #8b7355;
                            --border-color: #e8e0d0;
                        }

                        .style-bold-minimal {
                            --bg-color: #1a1a1a;
                            --text-color: #ffffff;
                            --accent-color: #ff6b6b;
                            --border-color: #333333;
                        }

                        .style-guerrilla-minimal {
                            --bg-color: #0a0a0a;
                            --text-color: #ffffff;
                            --accent-color: #ff6b6b;
                            --border-color: #333333;
                        }

                        .style-elegant-gallery {
                            --bg-color: #f8f4e9;
                            --text-color: #5a4a3a;
                            --accent-color: #8b7355;
                            --border-color: #e8e0d0;
                        }

                        .style-experimental-immersive {
                            --bg-color: #1a1a2e;
                            --text-color: #e6f7ff;
                            --accent-color: #00d4ff;
                            --border-color: #2d3047;
                        }

                        .style-monumental-sculptural {
                            --bg-color: #2c2c2c;
                            --text-color: #ffffff;
                            --accent-color: #ffd700;
                            --border-color: #4a4a4a;
                        }

                        .style-historical-layered {
                            --bg-color: #f5f1e6;
                            --text-color: #3a2c1e;
                            --accent-color: #d4af37;
                            --border-color: #d4c4a8;
                        }

                        .style-colorful-vibrant {
                            --bg-color: #ffffff;
                            --text-color: #333333;
                            --accent-color: #ff4757;
                            --border-color: #e5e5e5;
                        }

                        .style-abstract-expressionist {
                            --bg-color: #1e1e1e;
                            --text-color: #fffaed;
                            --accent-color: #ff9500;
                            --border-color: #3a3a3a;
                        }

                        .style-storytelling-quilt {
                            --bg-color: #fff8e1;
                            --text-color: #5d4037;
                            --accent-color: #7b1fa2;
                            --border-color: #ffcc80;
                        }

                        .style-contemporary-digital {
                            --bg-color: #000000;
                            --text-color: #00ff9d;
                            --accent-color: #ff00ff;
                            --border-color: #333333;
                        }

                        .style-political-archival {
                            --bg-color: #ffffff;
                            --text-color: #000000;
                            --accent-color: #cc0000;
                            --border-color: #8b0000;
                        }

                        /* ACCENT COLOR VISUAL ELEMENTS */
                        #portfolioPage.style-applied footer {
                            border-top-color: var(--accent-color, #e5e5e5);
                        }

                        #portfolioPage.style-applied .portfolio-header {
                            border-bottom-color: var(--accent-color, #e5e5e5);
                        }

                        /* CV Button accent color */
                        #portfolioPage.style-applied .owner-cv-button {
                            border-color: var(--accent-color, #000000);
                            color: var(--accent-color, #000000);
                        }

                        /* Active state for navigation */
                        #portfolioPage.style-applied .portfolio-nav .nav-item.active {
                            border-bottom: 2px solid var(--accent-color, #000000);
                        }

                        /* PORTFOLIO TEXT STYLES */
                        #portfolioPage {
                            /* Header */
                            --header-font-size: 24px;
                            --nav-font-size: 14px;
                            --header-font-family: 'Space Grotesk', sans-serif;

                            /* Body */
                            --titles-size: 20px;
                            --desc-size: 16px;
                            --artwork-size: 16px;
                            --body-font-family: 'Space Grotesk', sans-serif;

                            /* Footer */
                            --footer-font-size: 14px;
                            --footer-font-family: 'Space Grotesk', sans-serif;

                            /* Colors */
                            --artist-name-color: var(--text-color, #000000);
                            --nav-color: var(--text-color, #666666);
                            --titles-color: var(--text-color, #000000);
                            --desc-color: var(--text-color, #333333);
                            --artwork-details-color: var(--text-color, #333333);
                            --footer-text-color: var(--text-color, #666666);

                            /* Footer Contact */
                            --show-footer-contact: false;
                        }

                        /* Header Color Applications */
                        #portfolioPage.style-applied .artist-name {
                            color: var(--artist-name-color);
                            font-size: var(--header-font-size);
                            font-family: var(--header-font-family);
                        }

                        #portfolioPage.style-applied .portfolio-nav .nav-item {
                            color: var(--nav-color);
                            font-size: var(--nav-font-size);
                            font-family: var(--header-font-family);
                        }

                        /* Body Color Applications */
                        #portfolioPage.style-applied .section-title,
                        #portfolioPage.style-applied h2 {
                            color: var(--titles-color);
                            font-size: var(--titles-size);
                            font-family: var(--body-font-family);
                        }

                        #portfolioPage.style-applied .artwork-details,
                        #portfolioPage.style-applied .artwork-description,
                        #portfolioPage.style-applied p {
                            color: var(--desc-color);
                            font-size: var(--desc-size);
                            font-family: var(--body-font-family);
                            line-height: 1.6;
                        }

                        #portfolioPage.style-applied .artwork-title,
                        #portfolioPage.style-applied .artwork-details,
                        #portfolioPage.style-applied .artwork-details div {
                            color: var(--artwork-details-color);
                            font-size: var(--artwork-size);
                            font-family: var(--body-font-family);
                        }

                        /* Remove hover effects for portfolio works */
                        #portfolioPage .artwork-card {
                            transform: none;
                            transition: none;
                        }

                        #portfolioPage .artwork-card:hover {
                            transform: none;
                        }

                        .artworks-grid.no-hover-effects .artwork-card {
                            transform: none;
                            transition: none;
                        }

                        .artworks-grid.no-hover-effects .artwork-card:hover {
                            transform: none;
                        }

                        /* Footer Styles */
                        footer {
                            font-size: var(--footer-font-size);
                            font-family: var(--footer-font-family);
                            color: var(--footer-text-color);
                        }

                        footer p {
                            font-size: var(--footer-font-size);
                            font-family: var(--footer-font-family);
                        }

                        /* Footer responsive design */
                        @media (max-width: 768px) {
                            footer {
                                padding: 1.5rem 0;
                            }

                            footer > div {
                                padding: 0 1rem;
                            }
                        }

                        /* Show event descriptions in portfolio */
                        #portfolioPage .artwork-card .artwork-description {
                            display: block;
                            font-size: 0.8rem;
                            color: #666;
                            margin-top: 0.5rem;
                            line-height: 1.3;
                        }

                        /* Mobile touch targets */
                        @media (max-width: 768px) {
                            .auth-button, 
                            .add-artwork-btn,
                            .btn-primary,
                            .btn-secondary,
                            .cta-button {
                                padding: 1rem 1.5rem;
                                min-height: 44px;
                                font-size: 1rem;
                            }

                            .delete-btn,
                            .icon-button {
                                padding: 0.75rem;
                                min-height: 44px;
                                min-width: 44px;
                            }

                            .artworks-grid {
                                grid-template-columns: 1fr;
                                padding: 0 0.5rem;
                                gap: 1.5rem;
                            }
                        }

                        /* STYLE EDITOR STYLES */
                        .style-editor-panel {
                            position: fixed;
                            top: 50%;
                            right: 0;
                            transform: translateY(-50%);
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px 0 0 12px;
                            padding: 1.5rem;
                            width: 320px;
                            max-height: 80vh;
                            overflow-y: auto;
                            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
                            z-index: 1000;
                        }

                        .style-editor-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 1.5rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px solid #e5e5e5;
                        }

                        .style-editor-header h4 {
                            margin: 0;
                            font-size: 1.1rem;
                            font-weight: 500;
                        }

                        .close-editor {
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            cursor: pointer;
                            color: #666;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 8px;
                        }

                        .close-editor:hover {
                            background: #f5f5f5;
                            color: #000;
                        }

                        .style-editor-tabs {
                            display: flex;
                            gap: 0.5rem;
                            margin-bottom: 1.5rem;
                            flex-wrap: wrap;
                        }                                               

                        .style-editor-tab {
                            flex: 1;
                            padding: 0.5rem;
                            background: #f5f5f5;
                            color: #666;
                            border: none;
                            border-radius: 6px;
                            font-size: 0.8rem;
                            cursor: pointer;
                            transition: all 0.2s;
                            min-width: 60px;
                        }

                        .style-editor-tab.active {
                            background: #000;
                            color: white;
                        }

                        .style-editor-tab:hover:not(.active) {
                            background: #e5e5e5;
                        }

                        .style-tab-content {
                            display: none;
                            margin-bottom: 1.5rem;
                        }

                        .style-tab-content.active {
                            display: block;
                        }

                        .style-tab-content p {
                            color: #666;
                            font-size: 0.9rem;
                            text-align: center;
                            margin: 2rem 0;
                        }

                        .style-editor-actions {
                            display: flex;
                            gap: 1rem;
                            padding-top: 1.5rem;
                            border-top: 1px solid #e5e5e5;
                        }

                        .style-editor-actions .btn-secondary,
                        .style-editor-actions .btn-primary {
                            flex: 1;
                            padding: 0.75rem;
                            font-size: 0.85rem;
                        }

                        /* COLOR CONTROLS STYLES */
                        .color-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                        }

                        .color-control-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .color-control-group label {
                            font-size: 0.85rem;
                            font-weight: 500;
                            color: #333;
                        }

                        .color-picker-container {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }

                        .color-picker {
                            width: 50px;
                            height: 30px;
                            border: 1px solid #e5e5e5;
                            border-radius: 6px;
                            cursor: pointer;
                        }

                        .color-value {
                            font-size: 0.8rem;
                            color: #666;
                            font-family: monospace;
                            min-width: 70px;
                        }

                        /* LAYOUT CONTROLS STYLES */
                        .layout-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                        }

                        .layout-control-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .layout-control-group label {
                            font-size: 0.85rem;
                            font-weight: 500;
                            color: #333;
                        }

                        .layout-select {
                            padding: 0.5rem;
                            border: 1px solid #e5e5e5;
                            border-radius: 6px;
                            font-size: 0.85rem;
                            background: white;
                            cursor: pointer;
                        }

                        .layout-select:focus {
                            outline: none;
                            border-color: #000;
                        }

                        /* FONT CONTROLS STYLES */
                        .font-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                        }

                        .font-control-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .font-control-group label {
                            font-size: 0.85rem;
                            font-weight: 500;
                            color: #333;
                        }

                        .font-select {
                            padding: 0.5rem;
                            border: 1px solid #e5e5e5;
                            border-radius: 6px;
                            font-size: 0.85rem;
                            background: white;
                            cursor: pointer;
                        }

                        .font-size-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        .size-control {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .size-control label {
                            font-size: 0.8rem;
                            color: #666;
                        }

                        .font-size-slider {
                            width: 100%;
                            height: 4px;
                            border-radius: 2px;
                            background: #e5e5e5;
                            outline: none;
                            cursor: pointer;
                        }

                        .size-value {
                            font-size: 0.8rem;
                            color: #666;
                            text-align: right;
                            font-family: monospace;
                        }

                        /* ADVANCED CONTROLS STYLES */
                        .advanced-controls {
                            display: flex;
                            flex-direction: column;
                            gap: 1.5rem;
                        }

                        .advanced-control-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .advanced-control-group label {
                            font-size: 0.85rem;
                            font-weight: 500;
                            color: #333;
                        }

                        .advanced-select {
                            padding: 0.5rem;
                            border: 1px solid #e5e5e5;
                            border-radius: 6px;
                            font-size: 0.85rem;
                            background: white;
                            cursor: pointer;
                        }

                        .toggle-control {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                        }

                        .toggle-switch {
                            position: relative;
                            display: inline-block;
                            width: 44px;
                            height: 24px;
                        }

                        .toggle-switch input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }

                        .toggle-slider {
                            position: absolute;
                            cursor: pointer;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-color: #e5e5e5;
                            transition: .2s;
                            border-radius: 24px;
                        }

                        .toggle-slider:before {
                            position: absolute;
                            content: "";
                            height: 16px;
                            width: 16px;
                            left: 4px;
                            bottom: 4px;
                            background-color: white;
                            transition: .2s;
                            border-radius: 50%;
                        }

                        input:checked + .toggle-slider {
                            background-color: #000;
                        }

                        input:checked + .toggle-slider:before {
                            transform: translateX(20px);
                        }

                        .toggle-label {
                            font-size: 0.8rem;
                            color: #666;
                        }

                        .save-style-control {
                            display: flex;
                            gap: 0.5rem;
                        }

                        .style-name-input {
                            flex: 1;
                            padding: 0.5rem;
                            border: 1px solid #e5e5e5;
                            border-radius: 6px;
                            font-size: 0.85rem;
                        }

                        .style-name-input:focus {
                            outline: none;
                            border-color: #000;
                        }

                        /* Toast notifications */
                        #global-toast {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #333333;
                            color: white;
                            border: 1px solid #666666;
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-size: 0.9rem;
                            z-index: 10000;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            animation: slideIn 0.3s ease;
                            max-width: 300px;
                        }

                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }

                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }

                        /* Event image sizing fixes */
                        #portfolioPage .event-card .artwork-image {
                            width: 100%;
                            height: auto;
                            min-height: auto;
                            max-height: none;
                        }

                        #portfolioPage .event-card .artwork-image img {
                            height: auto;
                            object-fit: cover;
                        }

                        /* SVG Icon Styles */
                        .social-icon {
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            width: 32px;
                            height: 32px;
                            border-radius: 6px;
                            transition: all 0.2s ease;
                        }

                        .social-icon:hover {
                            background: #f5f5f5;
                            transform: translateY(-1px);
                        }

                        .social-icon svg {
                            width: 16px;
                            height: 16px;
                        }

                        .icon-button svg {
                            width: 16px;
                            height: 16px;
                        }

                        /* Empty state icon styles */
                        .empty-icon svg {
                            opacity: 0.7;
                        }

                        .empty-state:hover .empty-icon svg {
                            opacity: 0.9;
                        }

                        /* Loading states */
                        .loading {
                            opacity: 0.6;
                            pointer-events: none;
                        }

                        .loading-spinner {
                            display: inline-block;
                            width: 16px;
                            height: 16px;
                            border: 2px solid #ffffff;
                            border-radius: 50%;
                            border-top-color: transparent;
                            animation: spin 1s ease-in-out infinite;
                            margin-right: 8px;
                        }

                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }

                        /* Make all description boxes bigger */
                        textarea {
                            width: 100%;
                            min-height: 120px;
                            resize: vertical;
                            font-size: 14px;
                            line-height: 1.4;
                        }

                        /* ==================== CONVEYOR BELT STYLES FOR DASHBOARD ==================== */
                        .conveyor-belt-container {
                            width: 1400px;
                            margin: 2rem 48px 2rem 32px;
                            overflow-x: auto;
                            padding: 2rem 0;
                            clip-path: inset(0 43px 0 25px);
                            position: relative;
                            left: -32px;
                            max-width: calc(100vw - 80px);
                            overflow-x: auto;
                            scrollbar-width: none;
                            -ms-overflow-style: none;
                        }

                        .conveyor-belt-container::-webkit-scrollbar {
                            height: none;
                        }

                        .conveyor-belt-container::-webkit-scrollbar-track {
                            background: transparent;
                        }

                        .conveyor-belt-container::-webkit-scrollbar-thumb {
                            background: rgba(0, 0, 0, 0.15);
                            border-radius: 1px;
                            width: 30% !important;
                            margin: 0 auto;
                        }

                        .conveyor-belt-container::-webkit-scrollbar-thumb:hover {
                            background: rgba(0, 0, 0, 0.25);
                            width: 40% !important;
                        }

                        .conveyor-belt-track {
                            display: flex;
                            gap: 2rem;
                            padding: 0 32px;
                            width: fit-content;
                            max-width: 100%;
                            min-width: auto !important;
                            box-sizing: border-box;
                            position: relative;
                            left: 32px;
                        }

                        .conveyor-item {
                            flex: 0 0 auto;
                            width: 350px;
                            height: 400px;
                            scroll-snap-align: start;
                        }

                        .conveyor-item.artwork-card {
                            margin-bottom: 0;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            border: none;
                            border-radius: 0;
                            overflow: visible;
                            background: transparent;
                            box-shadow: none;
                        }

                        .conveyor-item.event-card {
                            margin-bottom: 0;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px;
                            overflow: hidden;
                            background: white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }

                        .conveyor-item .artwork-image {
                            height: 70%;
                            flex-shrink: 0;
                            overflow: hidden;
                        }

                        .conveyor-item .artwork-image img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        .conveyor-item .artwork-info {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            justify-content: space-between;
                            padding: 1.5rem;
                        }

                        .conveyor-item.artwork-card .artwork-info {
                            background: transparent;
                            padding: 1rem 0.5rem;
                            border: none;
                        }

                        .conveyor-item.event-card .artwork-info {
                            background: white;
                            padding: 1.5rem;
                            border-top: 1px solid #e5e5e5;
                        }

                        /* Specific description fields */
                        #description, #bio, #collectionStatement, #eventDescription {
                            width: 100%;
                            min-height: 120px;
                        }

                        /* Collection title and statement font sizes */
                        .collection-section h2 {
                            font-size: var(--titles-size, 24px) !important;
                        }

                        .collection-section p {
                            font-size: var(--desc-size, 16px) !important;
                        }

                        #events-section .artworks-grid.portfolio-layout.grid-classic,
                        #events-section .artworks-grid.portfolio-layout.grid-masonry,
                        #events-section .artworks-grid.portfolio-layout.large {
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
                            gap: 2rem !important;
                        }

                        /* Force proper card sizing */
                        #events-section .artwork-card.event-card {
                            width: 100% !important;
                            max-width: 400px !important;
                            margin: 0 auto !important;
                        }

                        /* Override any broken grid templates */
                        #events-section .artworks-grid {
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
                        }

                        /* Dashboard events grid */
                        #eventsGrid {
                            display: grid !important;
                            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
                            gap: 2rem !important;
                            width: 100% !important;
                        }

                        #eventsGrid .artwork-card.event-card {
                            width: 100% !important;
                            max-width: 400px !important;
                            margin: 0 auto !important;
                        }

                        /* ==================== SPACING CONTROLS ==================== */
                        :root {
                            --grid-spacing: 2rem;
                            --card-padding: 1.5rem;
                        }

                        .artworks-grid {
                            gap: var(--grid-spacing) !important;
                        }

                        .artwork-card {
                            padding: var(--card-padding) !important;
                        }

                        /* ==================== DASHBOARD 22 GRID STYLES ==================== */
                        .dashboard-grid-2x2 {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 2rem;
                            max-width: 1400px;
                            margin: 0 auto;
                            padding: 0 2rem;
                        }

                        .dashboard-card {
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px;
                            padding: 1.5rem;
                            transition: all 0.2s ease;
                            min-height: 180px;
                            display: flex;
                            flex-direction: column;
                        }

                        .dashboard-card:hover {
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            transform: translateY(-2px);
                        }

                        /* Card titles and text sizing */
                        .dashboard-card h3 {
                            font-size: 1.1rem;
                            font-weight: 500;
                            margin: 0 0 0.5rem 0;
                        }

                        .dashboard-card p {
                            font-size: 0.85rem;
                            color: #666;
                            margin: 0;
                        }

                        .dashboard-card .count {
                            font-size: 0.75rem;
                            color: #999;
                            margin-top: 1rem;
                        }

                        /* Mobile responsive */
                        @media (max-width: 768px) {
                            .dashboard-grid-2x2 {
                                grid-template-columns: 1fr;
                                gap: 1rem;
                                padding: 0 1rem;
                            }

                            .dashboard-card {
                                min-height: 160px;
                                padding: 1.25rem;
                            }
                        }

                        /* ==================== WIP STUDIO STYLES ==================== */
                        .wip-project-item {
                            padding: 1rem;
                            border: 1px solid #e5e5e5;
                            border-radius: 8px;
                            margin-bottom: 0.75rem;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            background: white;
                        }

                        .wip-project-item:hover {
                            border-color: #000;
                            transform: translateY(-1px);
                        }

                        .wip-project-item.active {
                            border-color: #000;
                            background: #f0f0f0;
                        }

                        .wip-project-title {
                            font-weight: 500;
                            margin-bottom: 0.25rem;
                            font-size: 0.9rem;
                        }

                        .wip-project-meta {
                            font-size: 0.75rem;
                            color: #666;
                        }

                        /* ==================== WIP STUDIO TAB SYSTEM ==================== */
                        .wip-tab {
                            flex: 1;
                            padding: 1rem;
                            border: none;
                            background: none;
                            cursor: pointer;
                            font-size: 0.9rem;
                            transition: all 0.2s ease;
                            border-bottom: 2px solid transparent;
                        }

                        .wip-tab:hover {
                            background: #f5f5f5;
                        }

                        .wip-tab.active {
                            border-bottom: 2px solid #000;
                            font-weight: 500;
                        }

                        .wip-tab-content {
                            display: none;
                            flex: 1;
                            overflow-y: auto;
                            background: #fafafa;
                        }

                        .wip-tab-content.active {
                            display: block;
                        }

                        /* Moodboard Grid */
                        .moodboard-item {
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px;
                            overflow: hidden;
                            transition: all 0.2s ease;
                        }

                        .moodboard-item:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        }

                        .moodboard-image {
                            width: 100%;
                            height: 150px;
                            object-fit: cover;
                            background: #f5f5f5;
                        }

                        .moodboard-info {
                            padding: 1rem;
                        }

                        .moodboard-title {
                            font-weight: 500;
                            margin-bottom: 0.25rem;
                            font-size: 0.9rem;
                        }

                        .moodboard-description {
                            font-size: 0.8rem;
                            color: #666;
                            margin: 0;
                        }

                        /* Sketches Grid */
                        .sketch-item {
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px;
                            overflow: hidden;
                            transition: all 0.2s ease;
                        }

                        .sketch-item:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        }

                        .sketch-image {
                            width: 100%;
                            height: 200px;
                            object-fit: cover;
                            background: #f5f5f5;
                        }

                        .sketch-info {
                            padding: 1rem;
                        }

                        .sketch-title {
                            font-weight: 500;
                            margin-bottom: 0.25rem;
                            font-size: 0.9rem;
                        }

                        .sketch-meta {
                            font-size: 0.75rem;
                            color: #666;
                            margin: 0;
                        }

                        /* Notes List */
                        .note-item {
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                            transition: all 0.2s ease;
                        }

                        .note-item:hover {
                            border-color: #000;
                        }

                        .note-title {
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                            font-size: 1rem;
                        }

                        .note-content {
                            font-size: 0.9rem;
                            color: #333;
                            line-height: 1.5;
                            margin: 0;
                        }

                        .note-meta {
                            font-size: 0.75rem;
                            color: #666;
                            margin-top: 1rem;
                        }

                        /* Connected Artworks */
                        .connected-artwork {
                            background: white;
                            border: 1px solid #e5e5e5;
                            border-radius: 8px;
                            overflow: hidden;
                            transition: all 0.2s ease;
                        }

                        .connected-artwork:hover {
                            border-color: #000;
                        }

                        .connected-artwork-image {
                            width: 100%;
                            height: 120px;
                            object-fit: cover;
                            background: #f5f5f5;
                        }

                        .connected-artwork-info {
                            padding: 0.75rem;
                        }

                        .connected-artwork-title {
                            font-weight: 500;
                            font-size: 0.8rem;
                            margin: 0;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }

                        /* Moodboard Type Buttons */
                        .moodboard-type-btn {
                            padding: 1rem;
                            border: 1px solid #d1d1d1;
                            background: white;
                            color: #333;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            transition: all 0.2s ease;
                        }

                        .moodboard-type-btn.active {
                            background: #000;
                            color: white;
                            border-color: #000;
                        }

                        .moodboard-type-btn:hover:not(.active) {
                            border-color: #000;
                        }

                        /* Moodboard Upload Zone */
                        #moodboardUploadZone.dragover {
                            border-color: #000;
                            background: #f8f8f8;
                        }

                        
                    </style>
                </head>
                <body>
                    <!-- LOGIN SECTION -->
                    <div id="login-section">
                        <div class="login-container">
                            <div class="login-header">
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="background: #000000; border-radius: 12px; padding: 1rem 1.5rem; display: inline-flex; align-items: center; justify-content: center;">
                                        <h1 style="font-size: 3rem; font-weight: 600; letter-spacing: -0.02em; color: #ffffff; margin: 0; line-height: 1;">TRAC</h1>
                                    </div>
                                </div>
                                <h1 style="font-size: 2rem; margin-bottom: 0.75rem;">Artist Portal</h1>
                                <p class="tagline">Sign up or sign in to access your artist dashboard</p>
                            </div>

                            <!-- Sign In Form -->
                            <div id="signInForm" class="auth-form">
                                <div class="form-header">
                                    <h2>Welcome back</h2>
                                    <p>Sign in to your dashboard</p>
                                </div>

                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" placeholder="Enter your email">
                                </div>

                                <div class="form-group">
                                    <label for="password">Password</label>
                                    <div style="position: relative;">
                                        <input type="password" id="password" placeholder="Enter your password" style="padding-right: 2.5rem;">
                                        <button type="button" onclick="togglePassword('password')" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 0.25rem; width: 20px; height: 20px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <button id="signInButton" class="auth-button" onclick="signIn()">
                                    <span id="signInText">Sign in</span>
                                </button>

                                <div style="text-align: center; margin: 1rem 0;">
                                    <a href="#" onclick="requestPasswordReset()" style="color: #666; font-size: 0.8rem; text-decoration: underline;">
                                        Forgot your password?
                                    </a>
                                </div>

                                <div class="auth-switch">
                                    <p>Don't have an account? <a href="#" id="switchToSignUp">Sign up</a></p>
                                </div>

                                <div id="message" class="message"></div>
                            </div>

                            <!-- Sign Up Form -->
                            <div id="signUpForm" class="auth-form" style="display: none;">
                                <div class="form-header">
                                    <h2>Create Artist Account</h2>
                                    <p>Join TRAC as an artist to manage your artwork</p>
                                </div>

                                <div class="form-section">
                                    <h3>Name & Email</h3>
                                    <div class="form-group">
                                        <input type="text" id="signupFullName" placeholder="Enter your full name">
                                    </div>
                                    <div class="form-group">
                                        <input type="email" id="signupEmail" placeholder="Enter your email">
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3>Password</h3>
                                    <div class="form-group">
                                        <label for="signupPassword">Password</label>
                                        <div style="position: relative;">
                                            <input type="password" id="signupPassword" placeholder="Enter your password" style="padding-right: 2.5rem;">
                                            <button type="button" onclick="togglePassword('signupPassword')" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 0.25rem; width: 20px; height: 20px;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmPassword">Confirm Password</label>
                                        <div style="position: relative;">
                                            <input type="password" id="confirmPassword" placeholder="Confirm your password" style="padding-right: 2.5rem;">
                                            <button type="button" onclick="togglePassword('confirmPassword')" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; padding: 0.25rem; width: 20px; height: 20px;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="terms-group">
                                    <input type="checkbox" id="agreeTerms">
                                    <label for="agreeTerms">
                                        I agree to the <a href="#" onclick="showTermsPopup()" style="color: #000; text-decoration: underline;">Terms of Service</a> and <a href="#" onclick="showPrivacyPopup()" style="color: #000; text-decoration: underline;">Privacy Policy</a>
                                    </label>
                                </div>

                                <button id="signUpButton" class="auth-button" onclick="signUp()">
                                    <span id="signUpText">Create Artist Account</span>
                                </button>

                                <div class="auth-switch">
                                    <p>Already have an account? <a href="#" id="switchToSignIn">Sign in</a></p>
                                </div>

                                <div id="signupMessage" class="message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- DASHBOARD SECTION -->
                    <div id="dashboard-section" style="display: none;">
                        <header class="gallery-header">
                            <div class="header-container">
                                <div class="header-left">
                                    <div class="logo-container">
                                        <h1 class="gallery-logo">TRAC</h1>
                                    </div>
                                    <nav class="gallery-nav">
                                        <a href="#" class="nav-item active" onclick="showSection('dashboard')">Dashboard</a>
                                        <a href="#" class="nav-item" onclick="showSection('settings')">Profile Settings</a>
                                        <a href="#" class="nav-item" onclick="showSection('portfolio')">Portfolio</a>
                                    </nav>
                                </div>
                                <div class="header-right">
                                    <button class="icon-button" onclick="signOut()" title="Sign Out">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M6 14H3.333C2.98 14 2.641 13.86 2.391 13.61C2.14 13.36 2 13.02 2 12.667V3.333C2 2.98 2.14 2.641 2.391 2.391C2.641 2.14 2.98 2 3.333 2H6"></path>
                                            <path d="M10.667 11.333L14 8l-3.333-3.333"></path>
                                            <path d="M14 8H6"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main class="gallery-main">
                            <!-- Hero Section -->
                            <section class="hero-section">
                                <div class="hero-container">
                                    <h2 class="hero-title">Your Art Archive</h2>
                                    <p class="hero-subtitle">Manage and protect your artistic legacy</p>
                                </div>
                            </section>

                            <!-- Stats Section -->
                            <section class="stats-section">
                                <div class="stats-container">
                                    <div class="stat-item">
                                        <div class="stat-number" id="artworksCount">0</div>
                                        <div class="stat-label">Artworks</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number" id="collectionsCount">0</div>
                                        <div class="stat-label">Collections</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number" id="eventsCount">0</div>
                                        <div class="stat-label">Events</div>
                                    </div>
                                </div>
                            </section>

                            <!-- Artworks Grid Section -->
                            <section class="artworks-section">
                                <div class="section-header">
                                    <h3 class="section-title">Your Uploaded Works</h3>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <button class="add-artwork-btn" onclick="showUploadForm()">+ Add Artwork</button>
                                        <button class="add-artwork-btn" onclick="showArchivedPopup()" style="background: #ddd; border: none; color: black;">
                                            View Archived Works
                                        </button>
                                    </div>
                                </div>

                                <!-- Artworks Grid -->
                                <div id="artworksGrid" class="artworks-grid">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="10" y="10" width="60" height="60" rx="4" fill="none"/>
                                                <line x1="25" y1="25" x2="55" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <line x1="55" y1="25" x2="25" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <circle cx="40" cy="40" r="8" fill="none"/>
                                            </svg>
                                        </div>
                                        <h4>No artworks yet</h4>
                                        <p>Add your first artwork to start building your archive</p>
                                        <button class="cta-button" onclick="showUploadForm()">Upload Your First Piece</button>
                                    </div>
                                </div>
                            </section>

                            <!-- Upload Form -->
                            <div id="uploadForm" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000;">
                                <div class="upload-form">
                                    <div class="form-header">
                                        <h4>Add New Artwork</h4>
                                        <button class="close-form" onclick="hideUploadForm()"></button>
                                    </div>
                                    <form id="artworkUploadForm">
                                        <div class="form-body">
                                            <div class="upload-zone" id="uploadZone">
                                                <div class="upload-placeholder" id="uploadPlaceholder">
                                                    <span>Drag & drop artwork image here</span>
                                                    <span class="upload-subtitle">or click to browse (JPG, PNG, WebP - max 5MB)</span>
                                                </div>
                                                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                                                <div id="imagePreview" class="image-preview" style="display: none;"></div>
                                            </div>

                                            <div class="form-grid">
                                                <div class="form-group">
                                                    <label for="title">Title *</label>
                                                    <input type="text" id="title" name="title" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="year">Year</label>
                                                    <input type="number" id="year" name="year" min="1900" max="2030">
                                                </div>
                                                <div class="form-group">
                                                    <label for="medium">Medium</label>
                                                    <input type="text" id="medium" name="medium" placeholder="Oil on canvas, etc.">
                                                </div>
                                                <div class="form-group">
                                                    <label for="dimensions">Dimensions</label>
                                                    <input type="text" id="dimensions" name="dimensions" placeholder="24  36 in">
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="description">Description</label>
                                                <textarea id="description" name="description" rows="3"></textarea>
                                            </div>
                                            <div class="form-group">
                                                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <input type="checkbox" id="isPublic" name="isPublic" checked>
                                                    Make this artwork public
                                                </label>
                                                <small style="color: #666; font-size: 0.8rem; display: block; margin-left: 1.5rem;">
                                                    Public artworks appear in your portfolio. Private artworks are only visible in your dashboard.
                                                </small>
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="button" class="btn-secondary" onclick="hideUploadForm()">Cancel</button>
                                            <button type="submit" class="btn-primary" id="uploadSubmitBtn">
                                                <span id="uploadSubmitText">Add Artwork</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Your Events Section -->
                            <section class="artworks-section" style="border-top: 1px solid #e5e5e5; padding-top: 3rem;">
                                <div class="section-header">
                                    <h3 class="section-title">Your Events</h3>
                                    <button class="add-artwork-btn" onclick="showAddEventForm()">+ Add Event</button>
                                </div>

                                <div id="eventsGrid" class="artworks-grid">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="15" y="15" width="50" height="35" rx="2" fill="none"/>
                                                <rect x="20" y="55" width="40" height="15" rx="1" fill="none"/>
                                                <line x1="30" y1="20" x2="50" y2="20" stroke="#ddd" stroke-width="1"/>
                                                <line x1="30" y1="25" x2="50" y2="25" stroke="#ddd" stroke-width="1"/>
                                                <line x1="30" y1="30" x2="40" y2="30" stroke="#ddd" stroke-width="1"/>
                                            </svg>
                                        </div>
                                        <h4>No upcoming events</h4>
                                        <p>Add exhibitions, shows, or important dates to track your artistic calendar</p>
                                        <button class="cta-button" onclick="showAddEventForm()">Add Your First Event</button>
                                    </div>
                                </div>
                            </section>           

                                    <!-- 22 GRID: Activity | Alerts + WIP | Blockchain -->
                                    <section class="dashboard-grid-section" style="padding: 3rem 0; border-top: 1px solid #e5e5e5;">
                                        <div class="dashboard-grid-2x2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1400px; margin: 0 auto; padding: 0 2rem;">

                                            <!-- ROW 1: ACTIVITY HISTORY -->
                                            <div class="dashboard-card" style="background: white; border: 1px solid #e5e5e5; border-radius: 12px; padding: 1.5rem; cursor: pointer;" onclick="showActivityHistory()">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                                    <h3 style="font-size: 1rem; margin: 0; font-weight: 500;">Activity History</h3>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 16 16 12 12 8"></polyline>
                                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                                    </svg>
                                                </div>
                                                <div id="activitiesList" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                                    <div style="text-align: center; color: #666;">
                                                        <div style="margin-bottom: 0.5rem;">
                                                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                                            </svg>
                                                        </div>
                                                        <p style="margin: 0; font-size: 0.85rem;">Recent activity</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ROW 1: ALERTS -->
                                            <div class="dashboard-card" style="background: white; border: 1px solid #e5e5e5; border-radius: 12px; padding: 1.5rem; cursor: pointer;" onclick="showAlertsManager()">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                                    <h3 style="font-size: 1rem; margin: 0; font-weight: 500;">Opportunity Alerts</h3>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 16 16 12 12 8"></polyline>
                                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                                    </svg>
                                                </div>
                                                <div id="alertsList" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                                    <div style="text-align: center; color: #666;">
                                                        <div style="margin-bottom: 0.5rem;">
                                                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                                            </svg>
                                                        </div>
                                                        <p style="margin: 0; font-size: 0.85rem;">No new opportunities</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ROW 2: WIP STUDIO -->
                                            <div class="dashboard-card" style="background: white; border: 1px solid #e5e5e5; border-radius: 12px; padding: 1.5rem; cursor: pointer;" onclick="openWipStudio()">
                                                <div style="text-align: center; padding: 0.5rem;">
                                                    <div style="margin-bottom: 1rem;">
                                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                            <path d="M2 17l10 5 10-5"></path>
                                                            <path d="M2 12l10 5 10-5"></path>
                                                        </svg>
                                                    </div>
                                                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 500;">Studio WIP</h3>
                                                    <p style="margin: 0; color: #666; font-size: 0.85rem;">Your creative workspace</p>
                                                    <div style="margin-top: 1rem; font-size: 0.75rem; color: #999;">
                                                        <span id="wipCount">0</span> works in progress
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ROW 2: BLOCKCHAIN TOOLS -->
                                            <div class="dashboard-card" style="background: white; border: 1px solid #e5e5e5; border-radius: 12px; padding: 1.5rem; cursor: pointer;" onclick="openBlockchainTools()">
                                                <div style="text-align: center; padding: 0.5rem;">
                                                    <div style="margin-bottom: 1rem;">
                                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                            <line x1="8" y1="12" x2="16" y2="12"></line>
                                                            <line x1="12" y1="8" x2="12" y2="16"></line>
                                                        </svg>
                                                    </div>
                                                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 500;">Blockchain Tools</h3>
                                                    <p style="margin: 0; color: #666; font-size: 0.85rem;">Mint & manage COA's</p>
                                                    <div style="margin-top: 1rem; font-size: 0.75rem; color: #999;">
                                                        <span id="coaCount">0</span> certificates issued
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </section>

                        <!-- Archived Works Popup -->
                        <div id="archivedPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 1200px; width: 90%; max-height: 80vh; overflow-y: auto;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                    <h3 style="margin: 0;">Archived Works</h3>
                                    <button onclick="hideArchivedPopup()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;"></button>
                                </div>
                                <div id="archivedArtworksGrid" class="artworks-grid large">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="15" y="15" width="50" height="50" rx="2" fill="none"/>
                                                <rect x="20" y="20" width="40" height="15" rx="1" fill="none"/>
                                                <line x1="25" y1="45" x2="55" y2="45" stroke="#ddd" stroke-width="1"/>
                                                <line x1="25" y1="55" x2="55" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <line x1="25" y1="65" x2="45" y2="65" stroke="#ddd" stroke-width="1"/>
                                            </svg>
                                        </div>
                                        <h4>No archived artworks</h4>
                                        <p>Archived works are hidden from your main collection but preserved.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE SETTINGS SECTION -->
                    <div id="settings-section" style="display: none;">
                        <header class="gallery-header">
                            <div class="header-container">
                                <div class="header-left">
                                    <div class="logo-container">
                                        <h1 class="gallery-logo">TRAC</h1>
                                    </div>
                                    <nav class="gallery-nav">
                                        <a href="#" class="nav-item" onclick="showSection('dashboard')">Dashboard</a>
                                        <a href="#" class="nav-item active">Profile Settings</a>
                                        <a href="#" class="nav-item" onclick="showSection('portfolio')">Portfolio</a>
                                    </nav>
                                </div>
                                <div class="header-right">
                                    <button class="icon-button" onclick="signOut()" title="Sign Out">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M6 14H3.333C2.98 14 2.641 13.86 2.391 13.61C2.14 13.36 2 13.02 2 12.667V3.333C2 2.98 2.14 2.641 2.391 2.391C2.641 2.14 2.98 2 3.333 2H6"></path>
                                            <path d="M10.667 11.333L14 8l-3.333-3.333"></path>
                                            <path d="M14 8H6"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </header>

                        <main class="gallery-main">
                            <section class="hero-section">
                                <div class="hero-container">
                                    <h2 class="hero-title">Profile Settings</h2>
                                    <p class="hero-subtitle">Manage your artist profile and portfolio settings</p>
                                </div>
                            </section>

                            <section class="artworks-section">
                                <div class="upload-form-container">
                                    <div class="upload-form">
                                        <div class="form-header">
                                            <h4>Artist Profile</h4>
                                        </div>
                                        <form id="profileSettingsForm">
                                            <div class="form-body">
                                                <div class="form-grid">
                                                    <div class="form-group">
                                                        <label for="username">Username *</label>
                                                        <input type="text" id="username" name="username" required>
                                                        <small style="color: #666; font-size: 0.8rem;">This will be your portfolio URL: trac/username</small>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Your Portfolio Link</label>
                                                        <a id="portfolioLink" href="#" target="_blank" style="display: block; background: #f5f5f5; padding: 0.875rem; border-radius: 8px; text-decoration: none; color: #000; margin-bottom: 0.5rem;">
                                                            trac.art/username
                                                        </a>
                                                        <button type="button" onclick="copyPortfolioLink()" class="btn-secondary" style="width: 100%;">Copy</button>
                                                    </div>
                                                </div>


                                                <div class="form-group">
                                                    <label for="profileFullName">Full Name *</label>
                                                    <input type="text" id="profileFullName" name="fullName" required>
                                                </div>

                                                <div class="form-group">
                                                    <label for="profilePhoto">Profile Photo</label>
                                                    <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*">
                                                    <div id="profilePhotoPreview" style="margin-top: 0.5rem;"></div>
                                                </div>

                                                <div class="form-group">
                                                    <label for="bio">Artist Bio</label>
                                                    <textarea id="bio" name="bio" rows="10" placeholder="Tell your artistic story..."></textarea>
                                                </div>

                                                <div class="form-section">
                                                    <h3>Contact</h3>
                                                    <div class="form-grid">
                                                        <div class="form-group">
                                                            <label for="website">Website</label>
                                                            <input type="url" id="website" name="website" placeholder="https://...">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="contactEmail">Contact Email</label>
                                                            <input type="email" id="contactEmail" name="contactEmail">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-section">
                                                    <h3>Professional Materials</h3>
                                                    <div class="form-group">
                                                        <label for="cvUpload">Curriculum Vitae (CV)</label>
                                                        <input type="file" id="cvUpload" name="cvUpload" accept=".pdf,.doc,.docx">
                                                        <div id="cvCurrentFile" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                                            No CV uploaded yet
                                                        </div>
                                                        <small style="color: #999;">Upload PDF, DOC, or DOCX (max 5MB). CV will appear in your portfolio header.</small>
                                                    </div>
                                                </div>

                                                <div class="form-section">
                                                    <h3>Social Media</h3>
                                                    <div class="form-group">
                                                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                                                            Add your social media profiles to display them in your portfolio
                                                        </p>

                                                        <div id="socialPlatformsContainer">
                                                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">No social platforms added yet</p>
                                                        </div>

                                                        <button type="button" class="btn-secondary" onclick="addSocialPlatform()" style="margin-top: 0.5rem;">
                                                            + Add Social Platform
                                                        </button>
                                                    </div>
                                                </div>

                    <div class="form-section">
                        <h3>Portfolio Styles</h3>
                        <div class="form-group">
                            <button type="button" onclick="showStyleBrowser()" class="btn-secondary">Browse Portfolio Styles</button>
                            <div id="currentStyleIndicator" style="display: none; padding: 1rem; background: #f8f8f8; border-radius: 8px; border: 1px solid #e5e5e5; margin-top: 1rem;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.25rem;">Current Style</div>
                                <div id="currentStyleName" style="font-weight: 500;">Loading...</div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="showSection('dashboard')">Back to Dashboard</button>
                        <button type="submit" class="btn-primary" id="profileSubmitBtn">
                            <span id="profileSubmitText">Save Profile</span>
                        </button>
                    </div>
                    </form>

                                        <div class="form-section" style="margin-top: 2rem; padding: 0 2rem;">
                                                                <h3>Portfolio Collections</h3>
                                                                <div id="collectionsContainer">
                                                                    <!-- Collections will be listed here -->
                                                                </div>
                                            <button type="button" class="btn-secondary" onclick="event.stopPropagation(); showCreateCollectionForm(event)">
                                                + New Collection
                                            </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </section>
                                            </main>
                                        </div>

                    <!-- PORTFOLIO SECTION -->
                    <div id="portfolio-section" style="display: none; min-height: 100vh; background: white; position: relative;">
                        <div id="portfolioPage" style="min-height: 100vh;">
                            <!-- Portfolio content loads here -->
                            <div style="padding: 2rem; text-align: center;">
                                <h1>Loading portfolio...</h1>
                            </div>
                        </div>
                    </div>

                    <!-- STYLE BROWSER MODAL -->
                    <div id="styleBrowserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 1000px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3 style="margin: 0;">Browse Portfolio Styles</h3>
                                <button onclick="hideStyleBrowser()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;"></button>
                            </div>
                            <div id="styleBrowserGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
                                <!-- Style cards will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- CREATE COLLECTION FORM -->
                    <div id="createCollectionForm" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000;">
                        <div class="upload-form">
                            <div class="form-header">
                                <h4>Create New Collection</h4>
                                <button class="close-form" onclick="hideCreateCollectionForm()"></button>
                            </div>
                            <form id="collectionForm">
                                <div class="form-body">
                                    <div class="form-group">
                                        <label for="collectionTitle">Collection Title *</label>
                                        <input type="text" id="collectionTitle" name="name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="collectionStatement">Artist Statement</label>
                                        <textarea id="collectionStatement" name="statement" rows="10" placeholder="Describe this body of work..."></textarea>
                                    </div>
                                    <div class="form-section">
                                        <h3>Add Artworks to Collection</h3>
                                        <div id="availableArtworks" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e5e5; padding: 1rem; border-radius: 8px;">
                                            <!-- Artworks will be listed here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" onclick="hideCreateCollectionForm()">Cancel</button>
                                    <button type="submit" class="btn-primary" id="collectionSubmitBtn">
                                        <span id="collectionSubmitText">Create Collection</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ADD EVENT FORM -->
                    <div id="addEventPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3 style="margin: 0;" id="eventFormTitle">Add New Event</h3>
                                <button onclick="hideAddEventForm()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;"></button>
                            </div>

                            <form id="eventForm">
                                <div class="form-body">
                                    <!-- Enhanced Image Upload -->
                                    <div class="form-group">
                                        <label>Event Poster/Image (Optional)</label>
                                        <div class="upload-zone" id="eventUploadZone" style="margin-bottom: 1rem;">
                                            <div class="upload-placeholder" id="eventUploadPlaceholder">
                                                <span>Drag & drop event poster here</span>
                                                <span class="upload-subtitle">or click to browse (JPG, PNG, WebP - max 5MB)</span>
                                            </div>
                                            <input type="file" id="eventImageInput" accept="image/*" style="display: none;">
                                            <div id="eventImagePreview" class="image-preview" style="display: none;"></div>
                                        </div>
                                    </div>

                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="eventTitle">Event Title *</label>
                                            <input type="text" id="eventTitle" name="title" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="eventType">Event Type</label>
                                            <select id="eventType" name="eventType">
                                                <option value="exhibition">Exhibition</option>
                                                <option value="show">Show</option>
                                                <option value="opening">Opening Reception</option>
                                                <option value="deadline">Application Deadline</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="eventDate">Event Date *</label>
                                            <input type="date" id="eventDate" name="eventDate" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="eventTime">Event Time (Optional)</label>
                                            <input type="time" id="eventTime" name="eventTime">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="eventLocation">Location</label>
                                        <input type="text" id="eventLocation" name="location" placeholder="Gallery name, venue, or online">
                                    </div>

                                    <div class="form-group">
                                        <label for="eventDescription">Description</label>
                                        <textarea id="eventDescription" name="description" rows="4" placeholder="Describe the event..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" name="isPublic" checked>
                                            Make this event public on your portfolio
                                        </label>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" onclick="hideAddEventForm()">Cancel</button>
                                    <button type="submit" class="btn-primary" id="eventSubmitBtn">
                                        <span id="eventSubmitText">Add Event</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ACTIVITY HISTORY POPUP -->
                    <div id="activityHistoryPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h3 style="margin: 0;">Activity History</h3>
                                <button onclick="hideActivityHistory()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;"></button>
                            </div>

                            <!-- Timeline Filters -->
                            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                                <button class="timeline-filter active" data-hours="1" onclick="loadActivityHistory(1)">Last Hour</button>
                                <button class="timeline-filter" data-hours="24" onclick="loadActivityHistory(24)">Last Day</button>
                                <button class="timeline-filter" data-hours="168" onclick="loadActivityHistory(168)">Last Week</button>
                                <button class="timeline-filter" data-hours="720" onclick="loadActivityHistory(720)">Last Month</button>
                                <button class="timeline-filter" data-hours="0" onclick="loadActivityHistory(0)">All Time</button>
                            </div>

                            <div id="activityHistoryList">
                                <div class="activity-item">
                                    <div class="activity-dot"></div>
                                    <div class="activity-content">
                                        <p>Loading history...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CV REQUEST MODAL -->
                    <div id="cvRequestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="margin: 0;">Request Artist CV</h3>
                                <button onclick="hideCVRequestForm()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;"></button>
                            </div>

                            <form id="cvRequestForm">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label for="cvRequesterName">Full Name *</label>
                                        <input type="text" id="cvRequesterName" name="name" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="cvRequesterCompany">Company/Gallery *</label>
                                        <input type="text" id="cvRequesterCompany" name="company" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px;">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label for="cvRequesterEmail">Email *</label>
                                        <input type="email" id="cvRequesterEmail" name="email" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="cvRequesterPhone">Phone</label>
                                        <input type="tel" id="cvRequesterPhone" name="phone" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px;">
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label for="cvRequesterMessage">Message (Optional)</label>
                                    <textarea id="cvRequesterMessage" name="message" rows="3" placeholder="Tell the artist about your interest..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                                <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #e5e5e5;">
                                    <button type="button" class="btn-secondary" onclick="hideCVRequestForm()">Cancel</button>
                                    <button type="submit" class="btn-primary">Send Request</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- WIP STUDIO MODAL -->
                        <div id="wipStudioModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 16px; max-width: 1200px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                            <!-- Header -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                        <path d="M2 17l10 5 10-5"></path>
                                        <path d="M2 12l10 5 10-5"></path>
                                    </svg>
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Studio (WIP)</h3>
                                </div>
                                <button onclick="closeWipStudio()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                    
                                </button>
                            </div>

                            <!-- Content Area -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                <!-- Left Sidebar - Projects List -->
                                <div style="width: 300px; border-right: 1px solid #e5e5e5; background: #f8f8f8; display: flex; flex-direction: column;">
                                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                                        <button onclick="createNewWipProject()" style="width: 100%; background: #000; color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                            </svg>
                                            New Project
                                        </button>
                                    </div>
                                    <div id="wipProjectsList" style="flex: 1; overflow-y: auto; padding: 1rem;">
                                        <!-- Projects will be listed here -->
                                        <div style="text-align: center; padding: 2rem; color: #666;">
                                            <p style="margin: 0; font-size: 0.9rem;">No projects yet</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Main Workspace -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <!-- Workspace Header -->
                                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 id="currentProjectTitle" style="margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 500;">Select a project</h4>
                                            <p id="currentProjectDescription" style="margin: 0; color: #666; font-size: 0.85rem;">Choose or create a project to start working</p>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button id="aiAssistantBtn" onclick="openAIAssistant()" style="background: #000; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                    <path d="M2 17l10 5 10-5"></path>
                                                    <path d="M2 12l10 5 10-5"></path>
                                                </svg>
                                                AI Assistant
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Workspace Content -->
                                    <div id="wipWorkspace" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                        <!-- Project Tabs -->
                                        <div style="display: flex; border-bottom: 1px solid #e5e5e5; background: white;">
                                            <button class="wip-tab active" data-tab="dashboard" onclick="switchWipTab('dashboard')" style="flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #000; font-size: 0.9rem;">
                                                Dashboard
                                            </button>
                                            <button class="wip-tab" data-tab="moodboard" onclick="switchWipTab('moodboard')" style="flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; font-size: 0.9rem;">
                                                Moodboard
                                            </button>
                                            <button class="wip-tab" data-tab="sketches" onclick="switchWipTab('sketches')" style="flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; font-size: 0.9rem;">
                                                Sketches
                                            </button>
                                            <button class="wip-tab" data-tab="notes" onclick="switchWipTab('notes')" style="flex: 1; padding: 1rem; border: none; background: none; cursor: pointer; font-size: 0.9rem;">
                                                Notes
                                            </button>
                                        </div>

                                        <!-- Tab Content -->
                                        <div style="flex: 1; overflow-y: auto; background: #fafafa;">

                                            <!-- Dashboard Tab -->
                                            <div id="wipDashboardTab" class="wip-tab-content active" style="padding: 2rem;">
                                                <div style="max-width: 800px; margin: 0 auto;">
                                                    <!-- Project Overview -->
                                                    <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid #e5e5e5;">
                                                        <h4 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 500;">Project Overview</h4>
                                                        <div id="projectOverviewContent">
                                                            <!-- Project details will load here -->
                                                            <div style="text-align: center; padding: 2rem; color: #666;">
                                                                <p style="margin: 0; font-size: 0.9rem;">No project selected</p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Connected Artworks -->
                                                    <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e5e5e5;">
                                                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                                            <h4 style="margin: 0; font-size: 1.1rem; font-weight: 500;">Connected Artworks</h4>
                                                            <button onclick="manageConnectedArtworks()" style="background: none; border: 1px solid #d1d1d1; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                                                Manage
                                                            </button>
                                                        </div>
                                                        <div id="connectedArtworksGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                                            <!-- Connected artworks will appear here -->
                                                            <div style="text-align: center; padding: 2rem; color: #666; grid-column: 1 / -1;">
                                                                <p style="margin: 0; font-size: 0.9rem;">No connected artworks</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Moodboard Tab -->
                                            <div id="wipMoodboardTab" class="wip-tab-content" style="padding: 2rem; display: none;">
                                                <div style="max-width: 1000px; margin: 0 auto;">
                                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                                                        <h4 style="margin: 0; font-size: 1.1rem; font-weight: 500;">Moodboard & References</h4>
                                                        <button onclick="addMoodboardItem()" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                                            </svg>
                                                            Add Reference
                                                        </button>
                                                    </div>
                                                    <div id="moodboardGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                                                        <!-- Moodboard items will appear here -->
                                                        <div style="text-align: center; padding: 4rem 2rem; color: #666; grid-column: 1 / -1;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                                </svg>
                                                            </div>
                                                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">No references yet</h4>
                                                            <p style="margin: 0; font-size: 0.9rem;">Add images, links, or notes to build your moodboard</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Sketches Tab -->
                                            <div id="wipSketchesTab" class="wip-tab-content" style="padding: 2rem; display: none;">
                                                <div style="max-width: 1000px; margin: 0 auto;">
                                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                                                        <h4 style="margin: 0; font-size: 1.1rem; font-weight: 500;">Sketches & Drafts</h4>
                                                        <button onclick="uploadSketch()" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                                <polyline points="17 8 12 3 7 8"></polyline>
                                                                <line x1="12" y1="3" x2="12" y2="15"></line>
                                                            </svg>
                                                            Upload Sketch
                                                        </button>
                                                    </div>
                                                    <div id="sketchesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                                                        <!-- Sketches will appear here -->
                                                        <div style="text-align: center; padding: 4rem 2rem; color: #666; grid-column: 1 / -1;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                                                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                                                                    <path d="M2 2l7.586 7.586"></path>
                                                                    <circle cx="11" cy="11" r="2"></circle>
                                                                </svg>
                                                            </div>
                                                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">No sketches yet</h4>
                                                            <p style="margin: 0; font-size: 0.9rem;">Upload drawings, drafts, or process documentation</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Notes Tab -->
                                            <div id="wipNotesTab" class="wip-tab-content" style="padding: 2rem; display: none;">
                                                <div style="max-width: 800px; margin: 0 auto;">
                                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
                                                        <h4 style="margin: 0; font-size: 1.1rem; font-weight: 500;">Notes & Ideas</h4>
                                                        <button onclick="createNewNote()" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                                            </svg>
                                                            New Note
                                                        </button>
                                                    </div>
                                                    <div id="notesList">
                                                        <!-- Notes will appear here -->
                                                        <div style="text-align: center; padding: 4rem 2rem; color: #666;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                                    <polyline points="14 2 14 8 20 8"></polyline>
                                                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                                                    <polyline points="10 9 9 9 8 9"></polyline>
                                                                </svg>
                                                            </div>
                                                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">No notes yet</h4>
                                                            <p style="margin: 0; font-size: 0.9rem;">Add thoughts, ideas, or research notes</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <!-- WIP PROJECT CREATION MODAL -->
                                        <div id="wipProjectCreateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002; align-items: center; justify-content: center;">
                                        <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto;">
                                            <!-- Header -->
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5;">
                                                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Create New Project</h3>
                                                <button onclick="closeWipProjectCreate()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                                    
                                                </button>
                                            </div>

                                            <!-- Form -->
                                            <form id="wipProjectForm" style="padding: 2rem;">
                                                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                                    <!-- Project Title -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Project Title *</label>
                                                        <input type="text" id="projectTitle" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Enter project title" required>
                                                    </div>

                                                    <!-- Project Type -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Project Type</label>
                                                        <select id="projectType" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; background: white;">
                                                            <option value="">Select type (optional)</option>
                                                            <option value="series">Series Development</option>
                                                            <option value="material">Material Experiments</option>
                                                            <option value="exhibition">Exhibition Proposal</option>
                                                            <option value="research">Research/Concept</option>
                                                            <option value="commission">Commission Work</option>
                                                            <option value="publication">Publication Project</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>

                                                    <!-- Description -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                                                        <textarea id="projectDescription" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 100px; resize: vertical;" placeholder="Describe your project..."></textarea>
                                                    </div>

                                                    <!-- Connect Existing Artworks -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Connect to Existing Artworks (Optional)</label>
                                                        <div style="border: 1px solid #e5e5e5; border-radius: 8px; padding: 1rem; max-height: 150px; overflow-y: auto; background: #fafafa;">
                                                            <div id="availableArtworksList" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                                <!-- Artwork checkboxes will be loaded here -->
                                                                <div style="text-align: center; color: #666; padding: 1rem;">
                                                                    <p style="margin: 0; font-size: 0.85rem;">No artworks available to connect</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Tags -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Tags (Optional)</label>
                                                        <input type="text" id="projectTags" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Add tags separated by commas">
                                                    </div>
                                                </div>

                                                <!-- Form Actions -->
                                                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e5e5;">
                                                    <button type="button" onclick="closeWipProjectCreate()" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Cancel</button>
                                                    <button type="submit" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Create Project</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- ADD MOODBOARD ITEM MODAL -->
                                        <div id="moodboardItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center;">
                                        <div style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto;">
                                            <!-- Header -->
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5;">
                                                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Add Reference</h3>
                                                <button onclick="closeMoodboardItemModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                                    
                                                </button>
                                            </div>

                                            <!-- Form -->
                                            <form id="moodboardItemForm" style="padding: 2rem;">
                                                <div style="display: flex; flex-direction: column; gap: 1.5rem;">

                                                    <!-- Reference Type -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Reference Type</label>
                                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                                            <button type="button" class="moodboard-type-btn active" data-type="image" onclick="selectMoodboardType('image')" style="padding: 1rem; border: 1px solid #000; background: #000; color: white; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                                                Image
                                                            </button>
                                                            <button type="button" class="moodboard-type-btn" data-type="link" onclick="selectMoodboardType('link')" style="padding: 1rem; border: 1px solid #d1d1d1; background: white; color: #333; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                                                Web Link
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Image Upload -->
                                                    <div id="moodboardImageSection">
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Upload Image</label>
                                                        <div class="upload-zone" id="moodboardUploadZone" style="border: 2px dashed #d1d1d1; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                                                            <div id="moodboardUploadPlaceholder">
                                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;">
                                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                                    <polyline points="17 8 12 3 7 8"></polyline>
                                                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                                                </svg>
                                                                <div style="font-size: 0.9rem; color: #666;">Drag & drop image or click to browse</div>
                                                                <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">JPG, PNG, WebP - max 5MB</div>
                                                            </div>
                                                            <input type="file" id="moodboardImageInput" accept="image/*" style="display: none;">
                                                            <div id="moodboardImagePreview" style="display: none;"></div>
                                                        </div>
                                                    </div>

                                                    <!-- Link Input -->
                                                    <div id="moodboardLinkSection" style="display: none;">
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Web Link</label>
                                                        <input type="url" id="moodboardLink" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="https://...">
                                                    </div>

                                                    <!-- Title -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Title *</label>
                                                        <input type="text" id="moodboardTitle" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Enter reference title" required>
                                                    </div>

                                                    <!-- Description -->
                                                    <div>
                                                        <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                                                        <textarea id="moodboardDescription" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 80px; resize: vertical;" placeholder="Add notes about this reference..."></textarea>
                                                    </div>

                                                </div>

                                                <!-- Form Actions -->
                                                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e5e5;">
                                                    <button type="button" onclick="closeMoodboardItemModal()" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Cancel</button>
                                                    <button type="submit" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Add Reference</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                    <!-- TERMS & PRIVACY POPUPS -->
                    <div id="termsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                                <button onclick="hideTermsPopup()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-right: 1rem;"></button>
                                <h3 style="margin: 0;">Terms of Service</h3>
                            </div>
                            <div style="line-height: 1.6;">
                                <p><strong>TRAC Artist Platform Terms of Service</strong></p>
                                <p>Welcome to TRAC. By using our platform, you agree to these terms...</p>
                            </div>
                        </div>
                    </div>

                    <div id="privacyPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                                <button onclick="hidePrivacyPopup()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-right: 1rem;"></button>
                                <h3 style="margin: 0;">Privacy Policy</h3>
                            </div>
                            <div style="line-height: 1.6;">
                                <p><strong>TRAC Privacy Policy</strong></p>
                                <p>Your privacy is important to us. This policy explains how we handle your data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ARTWORK POPUP -->
                    <div id="artworkPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; align-items: center; justify-content: center;">
                        <!-- Close button -->
                        <button onclick="closePopup()" style="position: absolute; top: 2rem; right: 2rem; background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 10001; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;"></button>

                        <!-- Side-by-side container - CLOSER GAP -->
                        <div style="display: flex; align-items: flex-end; justify-content: center; gap: 1.5rem; max-width: 90vw; max-height: 90vh;">
                            <!-- Image on LEFT -->
                            <img id="popupImg" src="" style="max-width: 70vh; max-height: 90vh; object-fit: contain; display: block;">

                            <!-- Details on RIGHT -->
                            <div id="popupInfo" style="flex-shrink: 0; width: 200px;"></div>
                        </div>
                    </div>

                    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
                    <script>
                        /* ==================== TRAC CORE SYSTEM ==================== */
                        console.log(" TRAC Artist Career OS loaded");
                        console.log(" Script started");

                        // Supabase Configuration
                        const supabaseUrl = 'https://vhgsayaugbepugssyary.supabase.co';
                        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoZ3NheWF1Z2JlcHVnc3N5YXJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NjA5ODMsImV4cCI6MjA3ODIzNjk4M30.2a6qJqW3BrHZxHHhM5Hm9e0sU6Bts6dXmPFW5tbrW_A';
                        let supabaseClient;

                        // Global State Management
                        let currentArtworks = [];
                        let cachedPortfolioData = null;
                        let cachedArtworksData = null;
                        let cachedCollectionsData = null;
                        let cachedEventsData = null;
                        let selectedImageFile = null;
                        let selectedEventImageFile = null;

                        // Activity Types
                        const ACTIVITY_TYPES = {
                            ARTWORK_UPLOAD: 'artwork_upload',
                            ARTWORK_UPDATE: 'artwork_update',
                            ARTWORK_ARCHIVE: 'artwork_archive', 
                            ARTWORK_DELETE: 'artwork_delete',
                            ARTWORK_RESTORE: 'artwork_restore',
                            COLLECTION_CREATE: 'collection_create',
                            COLLECTION_DELETE: 'collection_delete',
                            PROFILE_UPDATE: 'profile_update',
                            EVENT_CREATE: 'event_create',
                            EVENT_UPDATE: 'event_update',
                            EVENT_DELETE: 'event_delete',
                            CV_REQUEST: 'cv_request'
                        };

                        // Event Types Constants
                        const EVENT_TYPES = {
                            EXHIBITION: 'exhibition',
                            SHOW: 'show', 
                            DEADLINE: 'deadline',
                            OPENING: 'opening',
                            OTHER: 'other'
                        };

                        // Style Presets System
                        const STYLE_PRESETS = {
                        'trac-classic': {
                                id: 'trac-classic',
                                name: 'TRAC Classic',
                                description: 'Clean, professional grid layout',
                                layout: 'grid-classic',
                                headerLayout: 'centered',
                                footerStyle: 'minimal', 
                                collectionLayout: 'grid',
                                collectionTitleLayout: 'centered',
                                isBase: true,
                                colors: { 
                                    bg: '#ffffff', 
                                    text: '#000000', 
                                    accent: '#666666',
                                    border: '#e5e5e5'
                                },
                                fonts: { 
                                    primary: 'Space Grotesk', 
                                    secondary: 'Space Grotesk' 
                                },
                            },

                            'guerrilla-minimal': {
                                id: 'guerrilla-minimal',
                                name: 'Guerrilla Minimal',
                                description: 'Full-bleed images, floating header, hidden footer',
                                layout: 'guerrilla-grid',
                                headerLayout: 'floating',
                                footerStyle: 'hidden',
                                collectionLayout: 'stacked',
                                collectionTitleLayout: 'minimal',
                                colors: { 
                                    bg: '#0a0a0a', 
                                    text: '#ffffff', 
                                    accent: '#ff6b6b',
                                    border: '#333333'
                                },
                                fonts: { 
                                    primary: 'Helvetica', 
                                    secondary: 'Courier New' 
                                }
                            },

                            'elegant-gallery': {
                                id: 'elegant-gallery',
                                name: 'Elegant Gallery', 
                                description: 'Split header, expanded footer with contact info',
                                layout: 'gallery-spaced',
                                headerLayout: 'split',
                                footerStyle: 'expanded',
                                collectionLayout: 'grid',
                                collectionTitleLayout: 'left-aligned',
                                colors: { 
                                    bg: '#f8f4e9',
                                    text: '#5a4a3a', 
                                    accent: '#8b7355',
                                    border: '#e8e0d0'
                                },
                                fonts: { 
                                    primary: 'Georgia', 
                                    secondary: 'Helvetica Neue' 
                                }
                            },

                            'experimental-immersive': {
                                id: 'experimental-immersive',
                                name: 'Experimental Immersive',
                                description: 'Minimal header, hidden footer, full-viewport experience',
                                layout: 'immersive-stacked',
                                headerLayout: 'minimal',
                                footerStyle: 'hidden',
                                collectionLayout: 'featured-first',
                                collectionTitleLayout: 'centered-large',
                                colors: { 
                                    bg: '#1a1a2e', 
                                    text: '#e6f7ff',
                                    accent: '#00d4ff',
                                    border: '#2d3047'
                                },
                                fonts: { 
                                    primary: 'Space Grotesk', 
                                    secondary: 'Inter' 
                                }
                            },

                            'monumental-sculptural': {
                                id: 'monumental-sculptural',
                                name: 'Monumental Sculptural',
                                description: 'Expressive header, social-focused footer, masonry collections',
                                layout: 'monumental-asymmetric',
                                headerLayout: 'expressive',
                                footerStyle: 'social-focused',
                                collectionLayout: 'masonry',
                                collectionTitleLayout: 'expressive',
                                colors: { 
                                    bg: '#2c2c2c', 
                                    text: '#ffffff', 
                                    accent: '#ffd700',
                                    border: '#4a4a4a'
                                },
                                fonts: { 
                                    primary: 'Times New Roman', 
                                    secondary: 'Arial' 
                                }
                            },

                            'historical-layered': {
                                id: 'historical-layered',
                                name: 'Historical Layered',
                                description: 'Left-aligned header, contact-prominent footer, archival grid',
                                layout: 'historical-overlap',
                                headerLayout: 'left-aligned',
                                footerStyle: 'contact-prominent',
                                collectionLayout: 'grid',
                                collectionTitleLayout: 'archival',
                                colors: { 
                                    bg: '#f5f1e6', 
                                    text: '#3a2c1e', 
                                    accent: '#d4af37',
                                    border: '#d4c4a8'
                                },
                                fonts: { 
                                    primary: 'Garamond', 
                                    secondary: 'Baskerville' 
                                }
                            },

                            'colorful-vibrant': {
                                id: 'colorful-vibrant',
                                name: 'Colorful Vibrant',
                                description: 'Centered bold header, minimal footer, carousel collections',
                                layout: 'vibrant-mosaic',
                                headerLayout: 'centered',
                                footerStyle: 'minimal',
                                collectionLayout: 'carousel',
                                collectionTitleLayout: 'bold-centered',
                                colors: { 
                                    bg: '#ffffff', 
                                    text: '#333333', 
                                    accent: '#ff4757',
                                    border: '#e5e5e5'
                                },
                                fonts: { 
                                    primary: 'Arial Rounded MT Bold', 
                                    secondary: 'Comic Sans MS'
                                }
                            },

                            'abstract-expressionist': {
                                id: 'abstract-expressionist',
                                name: 'Abstract Expressionist',
                                description: 'Floating rotated header, hidden footer, organic collections',
                                layout: 'abstract-random',
                                headerLayout: 'floating',
                                footerStyle: 'hidden',
                                collectionLayout: 'stacked',
                                collectionTitleLayout: 'rotated',
                                colors: { 
                                    bg: '#1e1e1e', 
                                    text: '#fffaed', 
                                    accent: '#ff9500',
                                    border: '#3a3a3a'
                                },
                                fonts: { 
                                    primary: 'Brush Script MT', 
                                    secondary: 'Papyrus'
                                }
                            },

                            'storytelling-quilt': {
                                id: 'storytelling-quilt',
                                name: 'Storytelling Quilt',
                                description: 'Split narrative header, expanded footer, quilt grid',
                                layout: 'quilt-narrative',
                                headerLayout: 'split',
                                footerStyle: 'expanded',
                                collectionLayout: 'grid',
                                collectionTitleLayout: 'narrative',
                                colors: { 
                                    bg: '#fff8e1', 
                                    text: '#5d4037', 
                                    accent: '#7b1fa2',
                                    border: '#ffcc80'
                                },
                                fonts: { 
                                    primary: 'Georgia', 
                                    secondary: 'Palatino' 
                                }
                            },

                            'contemporary-digital': {
                                id: 'contemporary-digital',
                                name: 'Contemporary Digital',
                                description: 'Minimal glitch header, social footer, floating grid',
                                layout: 'digital-floating',
                                headerLayout: 'minimal',
                                footerStyle: 'social-focused',
                                collectionLayout: 'grid',
                                collectionTitleLayout: 'glitch',
                                colors: { 
                                    bg: '#000000', 
                                    text: '#00ff9d',
                                    accent: '#ff00ff',
                                    border: '#333333'
                                },
                                fonts: { 
                                    primary: 'Courier New', 
                                    secondary: 'OCR A Std'
                                }
                            },

                            'political-archival': {
                                id: 'political-archival',
                                name: 'Political Archival',
                                description: 'Institutional header, contact footer, dossier layout',
                                layout: 'archival-dossier',
                                headerLayout: 'left-aligned',
                                footerStyle: 'contact-prominent',
                                collectionLayout: 'stacked',
                                collectionTitleLayout: 'institutional',
                                colors: { 
                                    bg: '#ffffff', 
                                    text: '#000000', 
                                    accent: '#cc0000',
                                    border: '#8b0000'
                                },
                                fonts: { 
                                    primary: 'Times New Roman', 
                                    secondary: 'Courier New' 
                                }
                            }
                        };

                        // CV System Constants
                        const CV_ALLOWED_TYPES = [
                            'application/pdf', 
                            'application/msword',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        ];
                        const CV_MAX_SIZE = 5 * 1024 * 1024; // 5MB

                        // ==================== SOCIAL MEDIA SYSTEM ====================
                        const SOCIAL_PLATFORMS = [
                            'instagram', 'arena', 'twitter', 'tiktok', 'substack', 
                            'linkedin', 'facebook', 'youtube', 'vimeo', 'spotify',
                            'threads', 'bluesky', 'discord', 'patreon', 'github', 'upscrolled'
                        ];

                        const SOCIAL_ICONS = {
                            instagram: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><circle cx="12" cy="12" r="5"></circle><circle cx="18" cy="6" r="1"></circle></svg>`,
                            arena: `<svg width="24" height="24" view="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>`,
                            twitter: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>`,
                            tiktok: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg>`,
                            substack: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>`,
                            linkedin: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>`,
                            facebook: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>`,
                            youtube: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 12a29 29 0 0 0 .46 5.58 2.78 2.78 0 0 0 1.94 2c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 12a29 29 0 0 0-.46-5.58z"></path><polygon points="9.75 15.02 15.5 12 9.75 8.98 9.75 15.02"></polygon></svg>`,
                            vimeo: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22.875 10.063c-.835 4.43-5.95 10.62-9.375 10.62-3.426 0-4.26-3.128-7.426-3.128-3.165 0-4.524 2.23-5.874 2.23-1.35 0-2.2-1.34-2.2-2.68 0-1.34 1.35-2.68 2.2-2.68 1.35 0 2.1 1.34 3.425 1.34 1.325 0 2.55-3.13 3.425-5.02.875-1.89 2.2-5.02 3.425-5.02 1.225 0 2.55 2.68 3.425 4.47.875 1.79 1.75 4.47 2.55 4.47.8 0 2.55-2.68 3.425-4.47.875-1.79 1.75-2.68 2.55-2.68s1.35 1.34 1.35 2.68c0 1.34-.875 2.68-1.35 2.68z"></path></svg>`,
                            spotify: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 12c0 1.38.72 2.5 1.6 3.2.88.7 2.08 1.2 3.4 1.2s2.52-.5 3.4-1.2c.88-.7 1.6-1.82 1.6-3.2s-.72-2.5-1.6-3.2C15.52 8.5 14.32 8 13 8s-2.52.5-3.4 1.2C8.72 9.9 8 11.02 8 12z"></path></svg>`,
                            threads: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 8l-4 4h3a4 4 0 0 1-4 4H5a4 4 0 0 1-4-4V8a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v0z"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg>`,
                            bluesky: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>`,
                            discord: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path><path d="M15 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path><path d="M8 16c.5.5 1.2 1 2 1s1.5-.5 2-1"></path><path d="M21 12c0 5-4 9-9 9s-9-4-9-9 4-9 9-9 9 4 9 9z"></path><path d="M8 8h8M8 12h8"></path></svg>`,
                            patreon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 8h8v8H8z"></path></svg>`,
                            github: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>`,
                            upscrolled: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="16" x2="12" y2="16"></line></svg>`
                        };

                        function getSocialProfileUrl(platform, username) {
                            const urls = {
                                instagram: `https://instagram.com/${username}`,
                                twitter: `https://twitter.com/${username}`,
                                tiktok: `https://tiktok.com/@${username}`,
                                linkedin: `https://linkedin.com/in/${username}`,
                                facebook: `https://facebook.com/${username}`,
                                youtube: `https://youtube.com/${username}`,
                                github: `https://github.com/${username}`,
                                discord: `https://discord.gg/${username}`,
                                patreon: `https://patreon.com/${username}`,
                                substack: `https://${username}.substack.com`,
                                arena: `https://are.na/${username}`,
                                threads: `https://threads.net/@${username}`,
                                bluesky: `https://bsky.app/profile/${username}`,
                                vimeo: `https://vimeo.com/${username}`,
                                spotify: `https://open.spotify.com/user/${username}`,
                                upscrolled: `https://upscrolled.com/${username}`
                            };
                            return urls[platform] || '#';
                        }

                        let favoriteStyles = [];
                        let generatedStyles = [];

                        // ==================== AUTHENTICATION SYSTEM ====================
                        async function signIn() {
                            const email = document.getElementById('email').value.trim();
                            const password = document.getElementById('password').value;
                            const button = document.getElementById('signInButton');
                            const buttonText = document.getElementById('signInText');

                            if (!email || !password) {
                                showToast('Please enter email and password', 'error');
                                return;
                            }

                            button.disabled = true;
                            buttonText.innerHTML = '<span class="loading-spinner"></span>Signing in...';

                            try {
                                const { data, error } = await supabaseClient.auth.signInWithPassword({
                                    email: email,
                                    password: password
                                });

                                if (error) throw error;

                                showToast('Welcome back!');
                                showSection('dashboard');

                            } catch (error) {
                                showToast('Sign in failed: ' + error.message, 'error');
                            } finally {
                                button.disabled = false;
                                buttonText.textContent = 'Sign in';
                            }
                        }

                        async function signUp() {
                            const fullName = document.getElementById('signupFullName').value;
                            const email = document.getElementById('signupEmail').value;
                            const password = document.getElementById('signupPassword').value;
                            const confirmPassword = document.getElementById('confirmPassword').value;
                            const agreeTerms = document.getElementById('agreeTerms').checked;
                            const button = document.getElementById('signUpButton');
                            const buttonText = document.getElementById('signUpText');

                            if (!fullName || !email || !password || !confirmPassword) {
                                showToast('Please fill in all fields', 'error');
                                return;
                            }

                            if (password !== confirmPassword) {
                                showToast('Passwords do not match', 'error');
                                return;
                            }

                            if (!agreeTerms) {
                                showToast('Please agree to the Terms and Privacy Policy', 'error');
                                return;
                            }

                            button.disabled = true;
                            buttonText.innerHTML = '<span class="loading-spinner"></span>Creating account...';

                            try {
                                const { data, error } = await supabaseClient.auth.signUp({
                                    email: email,
                                    password: password,
                                    options: {
                                        data: { full_name: fullName }
                                    }
                                });

                                if (error) throw error;

                                showToast('Account created! Please check your email to verify.');
                                showSignInForm();

                            } catch (error) {
                                showToast('Sign up failed: ' + error.message, 'error');
                            } finally {
                                button.disabled = false;
                                buttonText.textContent = 'Create Artist Account';
                            }
                        }

                        async function signOut() {
                            try {
                                const { error } = await supabaseClient.auth.signOut();
                                if (error) {
                                    showToast('Error signing out', 'error');
                                } else {
                                    showToast('Signed out successfully');
                                    showSection('login');
                                }
                            } catch (error) {
                                showToast('Error signing out', 'error');
                            }
                        }

                        // ==================== CORE INITIALIZATION ====================
                        async function initializeApp() {
                            try {
                                //  INITIALIZE SUPABASE FIRST (ALWAYS)
                                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
                                    auth: {
                                        persistSession: true,
                                        autoRefreshToken: true
                                    }
                                });
                                console.log(" Supabase initialized");

                                //  CHECK FOR PUBLIC PORTFOLIO SECOND
                                const urlParams = new URLSearchParams(window.location.search);
                                const viewType = urlParams.get('view');
                                const username = urlParams.get('username');

                                if (viewType === 'portfolio' && username) {
                                    console.log(" IMMEDIATELY loading public portfolio for:", username);

                                    //  SHOW PORTFOLIO SECTION IMMEDIATELY (BEFORE ANYTHING ELSE)
                                    document.getElementById('portfolio-section').style.display = 'block';
                                    document.getElementById('login-section').style.display = 'none';
                                    document.getElementById('dashboard-section').style.display = 'none';
                                    document.getElementById('settings-section').style.display = 'none';

                                    //  THEN ADD SPINNER TO PORTFOLIO PAGE
                                    document.getElementById('portfolioPage').innerHTML = `
                                        <div style="display: flex; justify-content: center; align-items: center; height: 80vh;">
                                            <div style="text-align: center;">
                                                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                                <p style="margin-top: 1rem; color: #666;">Loading portfolio...</p>
                                            </div>
                                        </div>
                                        <style>
                                            @keyframes spin {
                                                0% { transform: rotate(0deg); }
                                                100% { transform: rotate(360deg); }
                                            }
                                        </style>
                                    `;

                                    //  THEN LOAD DATA
                                    loadPublicPortfolio(username);

                                    //  FADE IN PAGE
                                    setTimeout(() => {
                                        document.body.classList.add('loaded');
                                    }, 50);

                                    return;
                                }

                                //  ONLY RUN NORMAL APP FLOW IF NOT PUBLIC PORTFOLIO
                                console.log(" No public portfolio - checking auth...");

                                // Check for existing session (NORMAL APP FLOW)
                                const { data: { session } } = await supabaseClient.auth.getSession();
                                console.log("Session found:", !!session);

                                if (session) {
                                    console.log(" User signed in:", session.user.email);
                                    showSection('dashboard');
                                    setTimeout(() => {
                                        fetchUserArtworks();
                                        fetchUserEvents();
                                    }, 100);
                                } else {
                                    console.log(" No session - showing login");
                                    showSection('login');
                                }

                                //  FADE IN PAGE FOR NORMAL FLOW TOO
                                setTimeout(() => {
                                    document.body.classList.add('loaded');
                                }, 50);

                            } catch (error) {
                                console.error('Error initializing app:', error);
                                //  DON'T SHOW LOGIN ON ERROR FOR PUBLIC PORTFOLIOS

                                //  FADE IN PAGE ON ERROR TOO
                                setTimeout(() => {
                                    document.body.classList.add('loaded');
                                }, 50);
                            }
                        }

                        // ==================== UTILITY FUNCTIONS ====================
                        function showSection(sectionName) {
                            //  CHECK IF ALREADY SHOWING THIS SECTION
                            const currentSection = document.querySelector('[id$="-section"][style*="display: block"]');
                            if (currentSection && currentSection.id === sectionName + '-section') {
                                console.log(" Already showing", sectionName, "- skipping");
                                return;
                            }

                            // Hide all sections
                            document.getElementById('login-section').style.display = 'none';
                            document.getElementById('dashboard-section').style.display = 'none';
                            document.getElementById('settings-section').style.display = 'none';
                            document.getElementById('portfolio-section').style.display = 'none';

                            //  AUTO-CLOSE STYLE EDITOR ONLY WHEN NAVIGATING TO DIFFERENT SECTIONS
                            if (sectionName !== 'portfolio') {
                                const styleEditor = document.querySelector('.style-editor-panel');
                                if (styleEditor) {
                                    styleEditor.style.display = 'none';
                                }
                            }

                            // Show selected section
                            const section = document.getElementById(sectionName + '-section');
                            if (section) {
                                section.style.display = 'block';
                                console.log(" Showing section:", sectionName);
                            }

                            //  DON'T LOAD PORTFOLIO DATA IF VIEWING PUBLIC PORTFOLIO
                            const urlParams = new URLSearchParams(window.location.search);
                            const viewType = urlParams.get('view');
                            const username = urlParams.get('username');

                            if (sectionName === 'portfolio' && viewType === 'portfolio' && username) {
                                console.log(" Skipping portfolio data load - viewing public portfolio");
                                return; // STOP HERE - don't load private portfolio data
                            }

                            // Load section data
                            if (sectionName === 'dashboard') {
                                fetchUserArtworks();
                                fetchUserEvents();
                            } else if (sectionName === 'settings') {
                                loadProfileData();
                                loadProfileCollections();
                            } else if (sectionName === 'portfolio') {
                                loadPortfolio(); //  ONLY load private portfolio data
                            }
                        }

                        function showToast(message, type = 'success') {
                            // Remove existing toast
                            const existingToast = document.getElementById('global-toast');
                            if (existingToast) existingToast.remove();

                            // Create toast with highest z-index
                            const toast = document.createElement('div');
                            toast.id = 'global-toast';
                            toast.textContent = message;
                            toast.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: ${type === 'error' ? '#dc2626' : '#000'};
                                color: white;
                                border: 1px solid #666666;
                                padding: 12px 20px;
                                border-radius: 8px;
                                font-size: 0.9rem;
                                z-index: 10010; // HIGHEST - above everything
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                animation: slideIn 0.3s ease;
                                max-width: 300px;
                            `;

                            document.body.appendChild(toast);

                            // Auto remove
                            setTimeout(() => {
                                if (toast.parentNode) {
                                    toast.style.animation = 'slideOut 0.3s ease';
                                    setTimeout(() => toast.remove(), 300);
                                }
                            }, 3000);
                        }

                        function showSignUpForm() {
                            document.getElementById('signInForm').style.display = 'none';
                            document.getElementById('signUpForm').style.display = 'block';
                        }

                        function showSignInForm() {
                            document.getElementById('signUpForm').style.display = 'none';
                            document.getElementById('signInForm').style.display = 'block';
                        }

                        function togglePassword(inputId) {
                            const input = document.getElementById(inputId);
                            const button = input.parentNode.querySelector('button');

                            if (input.type === 'password') {
                                input.type = 'text';
                                button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>`;
                            } else {
                                input.type = 'password';
                                button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>`;
                            }
                        }

                        // ==================== FORM HANDLERS ====================
                        function showUploadForm(artwork = null) {
                            document.getElementById('uploadForm').style.display = 'block';

                            // Get the public checkbox element
                            const publicCheckbox = document.getElementById('isPublic');
                            const publicLabel = publicCheckbox?.closest('.form-group');

                            // If editing existing artwork, pre-fill data and hide public checkbox
                            if (artwork) {
                                // Pre-fill form data
                                document.getElementById('title').value = artwork.title || '';
                                document.getElementById('year').value = artwork.year || '';
                                document.getElementById('medium').value = artwork.medium || '';
                                document.getElementById('dimensions').value = artwork.dimensions || '';
                                document.getElementById('description').value = artwork.description || '';

                                // Hide the public checkbox in edit mode
                                if (publicLabel) {
                                    publicLabel.style.display = 'none';
                                }

                                // Show current image
                                document.getElementById('uploadPlaceholder').style.display = 'none';
                                document.getElementById('imagePreview').style.display = 'block';
                                document.getElementById('imagePreview').innerHTML = `
                                    <div style="text-align: center;">
                                        <img src="${artwork.image_url}" alt="${artwork.title}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                        <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                                            Current artwork - upload new image to replace
                                        </div>
                                    </div>
                                `;

                                // Set form to edit mode
                                document.getElementById('artworkUploadForm').dataset.mode = 'edit';
                                document.getElementById('artworkUploadForm').dataset.artworkId = artwork.id;
                                document.querySelector('#uploadForm .form-header h4').textContent = 'Edit Artwork';

                                // Change button text
                                document.querySelector('#uploadSubmitText').textContent = 'Update Artwork';

                            } else {
                                // CREATE MODE - reset form and show public checkbox
                                document.getElementById('artworkUploadForm').reset();
                                document.getElementById('uploadPlaceholder').style.display = 'block';
                                document.getElementById('imagePreview').style.display = 'none';

                                // Show the public checkbox in create mode
                                if (publicLabel) {
                                    publicLabel.style.display = 'block';
                                }

                                document.getElementById('artworkUploadForm').dataset.mode = 'create';
                                document.querySelector('#uploadForm .form-header h4').textContent = 'Add New Artwork';
                                document.querySelector('#uploadSubmitText').textContent = 'Add Artwork';
                            }
                        }

                        function hideUploadForm() {
                            document.getElementById('uploadForm').style.display = 'none';
                            document.getElementById('artworkUploadForm').reset();

                            // Reset form mode
                            delete document.getElementById('artworkUploadForm').dataset.mode;
                            delete document.getElementById('artworkUploadForm').dataset.artworkId;

                            // Reset button text
                            document.querySelector('#uploadSubmitText').textContent = 'Add Artwork';

                            // Reset header
                            document.querySelector('#uploadForm .form-header h4').textContent = 'Add New Artwork';

                            // Make sure public checkbox is visible for next use
                            const publicCheckbox = document.getElementById('isPublic');
                            const publicLabel = publicCheckbox?.closest('.form-group');
                            if (publicLabel) {
                                publicLabel.style.display = 'block';
                            }

                            clearImageSelection();
                        }

                        function showAddEventForm() {
                            document.getElementById('addEventPopup').style.display = 'flex';
                            
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('eventDate').value = today;

                            document.getElementById('eventForm').dataset.mode = 'create';
                            document.getElementById('eventFormTitle').textContent = 'Add New Event';
                            document.getElementById('eventSubmitText').textContent = 'Add Event';
                        }

                        function hideAddEventForm() {
                            document.getElementById('addEventPopup').style.display = 'none';
                            document.getElementById('eventForm').reset();
                            clearEventImageSelection();
                        }                        

                        function showCreateCollectionForm(event) {
                            if (event) event.preventDefault();
                            document.getElementById('createCollectionForm').style.display = 'block';
                            loadAvailableArtworks();
                        }

                        function hideCreateCollectionForm() {
                            document.getElementById('createCollectionForm').style.display = 'none';
                            document.getElementById('collectionForm').reset();

                            // Reset edit mode
                            delete document.getElementById('collectionForm').dataset.mode;
                            delete document.getElementById('collectionForm').dataset.collectionId;

                            // Reset UI
                            document.querySelector('#createCollectionForm .form-header h4').textContent = 'Create New Collection';
                            document.querySelector('#collectionSubmitText').textContent = 'Create Collection';
                        }

                        // ==================== IMAGE HANDLING ====================
                        function handleImageSelect(event) {
                            if (event.target.files.length > 0) {
                                handleImageFile(event.target.files[0]);
                            }
                        }

                        async function compressImage(file, maxWidth = 1200, quality = 0.8) {
                            return new Promise((resolve) => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();

                                img.onload = function() {
                                    // Calculate new dimensions
                                    let width = img.width;
                                    let height = img.height;

                                    if (width > maxWidth) {
                                        height = (height * maxWidth) / width;
                                        width = maxWidth;
                                    }

                                    canvas.width = width;
                                    canvas.height = height;

                                    // Draw and compress
                                    ctx.drawImage(img, 0, 0, width, height);
                                    canvas.toBlob(resolve, 'image/jpeg', quality);
                                };

                                img.src = URL.createObjectURL(file);
                            });
                        }

                        async function handleImageFile(file) {
                            if (!file.type.startsWith('image/')) {
                                showToast('Please select an image file', 'error');
                                return;
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                showToast('Image must be smaller than 5MB', 'error');
                                return;
                            }

                            //  COMPRESS IMAGE BEFORE UPLOAD
                            let processedFile = file;

                            if (file.size > 1 * 1024 * 1024) { // Compress if >1MB
                                showToast('Optimizing image...');
                                try {
                                    const compressedBlob = await compressImage(file, 1200, 0.7);
                                    processedFile = new File([compressedBlob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    console.log(' Image compressed:', 
                                        Math.round(file.size / 1024) + 'KB  ' + 
                                        Math.round(compressedBlob.size / 1024) + 'KB');
                                } catch (error) {
                                    console.error('Compression failed, using original:', error);
                                }
                            }

                            selectedImageFile = processedFile;

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('uploadPlaceholder').style.display = 'none';
                                document.getElementById('imagePreview').style.display = 'block';
                                document.getElementById('imagePreview').innerHTML = `
                                    <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                                        ${file.name} (${Math.round(processedFile.size / 1024)}KB)
                                        ${file.size !== processedFile.size ? '  Optimized' : ''}
                                    </div>
                                `;
                            };
                            reader.readAsDataURL(processedFile);
                        }

                        function clearImageSelection() {
                            selectedImageFile = null;
                            document.getElementById('uploadPlaceholder').style.display = 'block';
                            document.getElementById('imagePreview').style.display = 'none';
                            document.getElementById('imagePreview').innerHTML = '';
                            document.getElementById('imageInput').value = '';
                        }

                        function handleEventImageSelect(event) {
                            if (event.target.files.length > 0) {
                                handleEventImageFile(event.target.files[0]);
                            }
                        }

                        function handleEventImageFile(file) {
                            if (!file.type.startsWith('image/')) {
                                showToast('Please select an image file', 'error');
                                return;
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                showToast('Image must be smaller than 5MB', 'error');
                                return;
                            }

                            selectedEventImageFile = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('eventImagePreview').innerHTML = `
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                                        ${file.name} (${Math.round(file.size / 1024)}KB)
                                    </div>
                                `;
                            };
                            reader.readAsDataURL(file);
                        }

                        function clearEventImageSelection() {
                            selectedEventImageFile = null;
                            document.getElementById('eventImagePreview').innerHTML = '';
                        }

                        // ==================== ENHANCED EVENT IMAGE HANDLING ====================
                        function handleEventDragOver(e) {
                            e.preventDefault();
                            e.currentTarget.classList.add('dragover');
                        }

                        function handleEventDrop(e) {
                            e.preventDefault();
                            e.currentTarget.classList.remove('dragover');
                            const files = e.dataTransfer.files;
                            if (files.length > 0) {
                                handleEventImageFile(files[0]);
                            }
                        }

                        // ==================== ARTWORK MANAGEMENT ====================
                        async function uploadArtwork() {
                            const submitBtn = document.getElementById('uploadSubmitBtn');
                            const submitText = document.getElementById('uploadSubmitText');

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                const form = document.getElementById('artworkUploadForm');
                                const title = document.getElementById('title').value;
                                const isEdit = form.dataset.mode === 'edit';
                                const artworkId = form.dataset.artworkId;

                                if (!title) {
                                    showToast('Please enter a title', 'error');
                                    return;
                                }
                                if (!isEdit && !selectedImageFile) {
                                    showToast('Please select an image', 'error');
                                    return;
                                }

                                // Set loading state
                                submitBtn.disabled = true;
                                submitText.innerHTML = `<span class="loading-spinner"></span> ${isEdit ? 'Updating...' : 'Uploading...'}`;

                                let imageUrl = null;

                                // Upload new image if provided (for both create and edit)
                                if (selectedImageFile) {
                                    const imageName = `${user.id}/${Date.now()}_${selectedImageFile.name}`;
                                    const { data: imageData, error: uploadError } = await supabaseClient.storage
                                        .from('artwork-images')
                                        .upload(imageName, selectedImageFile);

                                    if (uploadError) throw uploadError;

                                    const { data: { publicUrl } } = supabaseClient.storage
                                        .from('artwork-images')
                                        .getPublicUrl(imageData.path);

                                    imageUrl = publicUrl;
                                }

                                if (isEdit && artworkId) {
                                    // UPDATE EXISTING ARTWORK
                                    const updateData = {
                                        title: title,
                                        year: document.getElementById('year').value || null,
                                        medium: document.getElementById('medium').value || '',
                                        dimensions: document.getElementById('dimensions').value || '',
                                        description: document.getElementById('description').value || '',
                                        is_public: document.getElementById('isPublic').checked
                                    };

                                    // Only update image if a new one was uploaded
                                    if (imageUrl) {
                                        updateData.image_url = imageUrl;
                                    }

                                    const { error } = await supabaseClient
                                        .from('artworks')
                                        .update(updateData)
                                        .eq('id', artworkId)
                                        .eq('artist_id', user.id);

                                    if (error) throw error;

                                    await logActivity(ACTIVITY_TYPES.ARTWORK_UPDATE, `Updated artwork: ${title}`);
                                    showToast('Artwork updated successfully');

                                } else {
                                    // CREATE NEW ARTWORK
                                    const artworkData = {
                                        artist_id: user.id,
                                        title: title,
                                        year: document.getElementById('year').value || null,
                                        medium: document.getElementById('medium').value || '',
                                        dimensions: document.getElementById('dimensions').value || '',
                                        description: document.getElementById('description').value || '',
                                        image_url: imageUrl,
                                        is_public: document.getElementById('isPublic').checked
                                    };

                                    const { data, error } = await supabaseClient
                                        .from('artworks')
                                        .insert([artworkData])
                                        .select();

                                    if (error) throw error;

                                    await logActivity(ACTIVITY_TYPES.ARTWORK_UPLOAD, `Uploaded artwork: ${title}`);
                                    showToast('Artwork added successfully');
                                }

                                hideUploadForm();
                                clearImageSelection();
                                fetchUserArtworks();
                                updateStats();

                            } catch (error) {
                                console.error('Upload error:', error);
                                showToast((isEdit ? 'Update' : 'Upload') + ' failed: ' + error.message, 'error');
                            } finally {
                                submitBtn.disabled = false;
                                submitText.textContent = isEdit ? 'Update Artwork' : 'Add Artwork';
                            }
                        }

                        // ==================== CV UPLOAD SYSTEM ====================
                        async function handleCVUpload(cvFile) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                // Validate file type
                                if (!CV_ALLOWED_TYPES.includes(cvFile.type)) {
                                    showToast('Please upload a PDF, DOC, or DOCX file for your CV.', 'error');
                                    return null;
                                }

                                // Validate file size
                                if (cvFile.size > CV_MAX_SIZE) {
                                    showToast('CV file must be smaller than 5MB.', 'error');
                                    return null;
                                }

                                // Upload to Supabase Storage
                                const cvFileName = `${user.id}/cv_${Date.now()}_${cvFile.name}`;
                                const { data: cvData, error: cvError } = await supabaseClient.storage
                                    .from('cv-files')
                                    .upload(cvFileName, cvFile);

                                if (cvError) throw cvError;

                                // Get public URL
                                const { data: { publicUrl } } = supabaseClient.storage
                                    .from('cv-files')
                                    .getPublicUrl(cvData.path);

                                console.log(" CV uploaded successfully:", publicUrl);
                                return publicUrl;

                            } catch (error) {
                                console.error('CV upload error:', error);
                                showToast('Error uploading CV: ' + error.message, 'error');
                                return null;
                            }
                        }

                        function updateCVStatusDisplay(hasCV, cvUrl = null) {
                            const cvCurrentFile = document.getElementById('cvCurrentFile');
                            if (!cvCurrentFile) return;

                            if (hasCV) {
                                cvCurrentFile.innerHTML = `
                                    <span style="color: green;"> CV uploaded and stored</span>
                                    <br><small style="color: #666;">CV button will appear in portfolio header</small>
                                    ${cvUrl ? `<br><small><a href="${cvUrl}" target="_blank" style="color: #666;">View current CV</a></small>` : ''}
                                `;
                            } else {
                                cvCurrentFile.innerHTML = '<span style="color: #666;">No CV uploaded yet</span>';
                            }
                        }

                        // ==================== SOCIAL MEDIA MANAGEMENT ====================
                        function addSocialPlatform(platform = '', username = '') {
                            const container = document.getElementById('socialPlatformsContainer');
                            if (!container) return;

                            // Remove empty message if it exists when adding a platform
                            if (container.innerHTML.includes('No social platforms')) {
                                container.innerHTML = '';
                            }

                            const platformId = Date.now();

                            const platformHtml = `
                                <div class="social-platform-item" id="platform-${platformId}">
                                    <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 1rem; align-items: end;">
                                        <div class="form-group">
                                            <label>Platform</label>
                                            <select class="platform-select" onchange="updatePlatformExample(this)">
                                                <option value="">Select platform...</option>
                                                ${SOCIAL_PLATFORMS.map(p => 
                                                    `<option value="${p}" ${p === platform ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="platform-username-label">Username</label>
                                            <input type="text" class="platform-username" value="${username}" placeholder="yourusername">
                                        </div>
                                        <div class="form-group">
                                            <button type="button" onclick="removeSocialPlatform('${platformId}')" class="delete-btn" style="color: #ccc; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem; padding: 0; white-space: nowrap;">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            container.insertAdjacentHTML('beforeend', platformHtml);

                            // If a platform was pre-selected, update its example placeholder
                            if (platform) {
                                const select = container.querySelector(`#platform-${platformId} .platform-select`);
                                updatePlatformExample(select);
                            }
                        }

                        function updatePlatformExample(select) {
                            const platform = select.value;
                            const input = select.closest('.social-platform-item').querySelector('.platform-username');
                            const label = select.closest('.social-platform-item').querySelector('.platform-username-label');

                            const placeholders = {
                                instagram: 'yourusername',
                                arena: 'your-channel',
                                substack: 'your-publication',
                                upscrolled: 'your-profile',
                                default: 'yourusername'
                            };

                            input.placeholder = placeholders[platform] || placeholders.default;
                            label.textContent = platform ? `${platform.charAt(0).toUpperCase() + platform.slice(1)} Username` : 'Username';
                        }

                        function removeSocialPlatform(id) {
                            const element = document.getElementById(`platform-${id}`);
                            if (element) element.remove();

                            // Check if no platforms left, show empty message
                            const container = document.getElementById('socialPlatformsContainer');
                            if (container && container.children.length === 0) {
                                container.innerHTML = '<p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">No social platforms added yet</p>';
                            }
                        }

                        function loadSocialPlatforms(socialData) {
                            const container = document.getElementById('socialPlatformsContainer');
                            if (!container) return;

                            // SAFE CLEAR: Only clear the platforms container to prevent duplicates
                            container.innerHTML = '';

                            if (socialData) {
                                const platforms = socialData.split('\n').filter(line => line.trim());
                                platforms.forEach(line => {
                                    const [platform, ...usernameParts] = line.split(':');
                                    if (platform && usernameParts.length) {
                                        const username = usernameParts.join(':').trim();
                                        addSocialPlatform(platform.trim(), username);
                                    }
                                });
                            }

                            // If no platforms after loading, show empty state
                            if (container.children.length === 0) {
                                container.innerHTML = '<p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">No social platforms added yet</p>';
                            }
                        }

                        function getSocialPlatformsData() {
                            const items = document.querySelectorAll('.social-platform-item');
                            const platforms = [];

                            items.forEach(item => {
                                const platform = item.querySelector('.platform-select').value;
                                const username = item.querySelector('.platform-username').value.trim();
                                if (platform && username) {
                                    platforms.push(`${platform}:${username}`);
                                }
                            });

                            return platforms.join('\n');
                        }

                        function displaySocialIcons(socialLinks) {
                            if (!socialLinks) return '';

                            const platforms = socialLinks.split('\n').filter(line => line.trim());
                            let html = '<div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">';

                            platforms.forEach(line => {
                                const [platform, ...usernameParts] = line.split(':');
                                const username = usernameParts.join(':').trim();
                                if (platform && username && SOCIAL_ICONS[platform]) {
                                    const profileUrl = getSocialProfileUrl(platform, username);
                                    html += `
                                        <a href="${profileUrl}" target="_blank" style="color: #000; text-decoration: none; transition: opacity 0.2s;" 
                                           title="${platform}: ${username}" 
                                           onmouseover="this.style.opacity='0.7'" 
                                           onmouseout="this.style.opacity='1'">
                                            ${SOCIAL_ICONS[platform]}
                                        </a>
                                    `;
                                }
                            });

                            html += '</div>';
                            return html;
                        }

                        // ==================== ARCHIVED WORKS MANAGEMENT ====================
                        async function fetchArchivedArtworks() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return [];

                                const { data, error } = await supabaseClient
                                    .from('artworks')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .eq('is_archived', true)
                                    .order('created_at', { ascending: false });

                                if (error) {
                                    console.error('Error fetching archived artworks:', error);
                                    return [];
                                }

                                displayArchivedArtworks(data || []);
                                return data || [];

                            } catch (error) {
                                console.error('Error fetching archived artworks:', error);
                                return [];
                            }
                        }

                        function displayArchivedArtworks(archivedArtworks) {
                            const grid = document.getElementById('archivedArtworksGrid');
                            if (!grid) return;

                            if (!archivedArtworks || archivedArtworks.length === 0) {
                                grid.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="15" y="15" width="50" height="50" rx="2" fill="none"/>
                                                <rect x="20" y="20" width="40" height="15" rx="1" fill="none"/>
                                                <line x1="25" y1="45" x2="55" y2="45" stroke="#ddd" stroke-width="1"/>
                                                <line x1="25" y1="55" x2="55" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <line x1="25" y1="65" x2="45" y2="65" stroke="#ddd" stroke-width="1"/>
                                            </svg>
                                        </div>
                                        <h4>No archived artworks</h4>
                                        <p>Archived works are hidden from your main collection but preserved.</p>
                                    </div>
                                `;
                                return;
                            }

                            grid.innerHTML = archivedArtworks.map(artwork => `
                                <div class="artwork-card" style="opacity: 0.8;">
                                    <div class="artwork-image">
                                        <img src="${artwork.image_url}" alt="${artwork.title}" style="width: 100%; height: auto; display: block;">
                                    </div>
                                    <div class="artwork-info">
                                        <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                        <div class="artwork-details">
                                            ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                            ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                            ${artwork.dimensions ? `<div>${artwork.dimensions}</div>` : ''}
                                        </div>
                                        <div class="artwork-actions" style="margin-top: 1rem; display: flex; gap: 1rem;">
                                            <button onclick="restoreArtwork('${artwork.id}')" style="color: #4CAF50; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem;">Restore</button>
                                            <button onclick="permanentlyDeleteArtwork('${artwork.id}')" class="delete-btn" style="color: #ff4444; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem;">Delete Permanently</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        }

                        async function restoreArtwork(artworkId) {
                            // Create custom TRAC-styled confirmation dialog
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10000;
                            `;

                            dialog.innerHTML = `
                                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" style="margin-bottom: 1rem;">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 500;">Restore Artwork</h3>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Move this artwork back to your main collection?</p>
                                    </div>
                                    <div style="display: flex; gap: 1rem; justify-content: center;">
                                        <button id="cancelRestore" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Cancel</button>
                                        <button id="confirmRestore" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Restore to Collection</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(dialog);

                            // Wait for user choice
                            return new Promise((resolve) => {
                                dialog.querySelector('#cancelRestore').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(false);
                                };

                                dialog.querySelector('#confirmRestore').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(true);
                                };
                            }).then(async (shouldRestore) => {
                                if (!shouldRestore) return;

                                try {
                                    const { data: { user } } = await supabaseClient.auth.getUser();
                                    if (!user) throw new Error('Not authenticated');

                                    const { error } = await supabaseClient
                                        .from('artworks')
                                        .update({ is_archived: false })
                                        .eq('id', artworkId)
                                        .eq('artist_id', user.id);

                                    if (error) throw error;

                                    showToast('Artwork restored to collection');
                                    fetchUserArtworks();
                                    fetchArchivedArtworks();
                                    clearPortfolioCache();

                                    await logActivity(
                                        ACTIVITY_TYPES.ARTWORK_RESTORE,
                                        'Restored artwork',
                                        `Restored artwork to your collection`,
                                        { artwork_id: artworkId }
                                    );

                                } catch (error) {
                                    console.error('Error restoring artwork:', error);
                                    showToast('Error restoring artwork', 'error');
                                }
                            });
                        }

                        async function permanentlyDeleteArtwork(artworkId) {
                            // Create custom TRAC-styled confirmation dialog
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10000;
                            `;

                            dialog.innerHTML = `
                                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" style="margin-bottom: 1rem;">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                        </svg>
                                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 500; color: #ff4444;">Permanently Delete</h3>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">This action cannot be undone. The artwork will be permanently removed.</p>
                                    </div>
                                    <div style="display: flex; gap: 1rem; justify-content: center;">
                                        <button id="cancelDelete" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Cancel</button>
                                        <button id="confirmDelete" style="background: #ff4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Delete Permanently</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(dialog);

                            // Wait for user choice
                            return new Promise((resolve) => {
                                dialog.querySelector('#cancelDelete').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(false);
                                };

                                dialog.querySelector('#confirmDelete').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(true);
                                };
                            }).then(async (shouldDelete) => {
                                if (!shouldDelete) return;

                                try {
                                    const { data: { user } } = await supabaseClient.auth.getUser();
                                    if (!user) throw new Error('Not authenticated');

                                    const { error } = await supabaseClient
                                        .from('artworks')
                                        .delete()
                                        .eq('id', artworkId)
                                        .eq('artist_id', user.id);

                                    if (error) throw error;

                                    showToast('Artwork permanently deleted');
                                    fetchArchivedArtworks();

                                    await logActivity(
                                        ACTIVITY_TYPES.ARTWORK_DELETE,
                                        'Permanently deleted artwork',
                                        `Permanently deleted artwork from archives`,
                                        { artwork_id: artworkId }
                                    );

                                } catch (error) {
                                    console.error('Error deleting artwork:', error);
                                    showToast('Error deleting artwork', 'error');
                                }
                            });
                        }

                        async function archiveOrDeleteArtwork(artworkId) {
                            // Create custom dialog
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10000;
                            `;

                            dialog.innerHTML = `
                                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%;">
                                    <h3 style="margin: 0 0 1rem 0;">Artwork Action</h3>
                                    <p style="margin: 0 0 2rem 0; color: #666;">Choose what to do with this artwork:</p>
                                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                        <button id="cancelAction" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Cancel</button>
                                        <button id="archiveAction" style="background: #666; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Archive</button>
                                        <button id="deleteAction" style="background: #ff4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(dialog);

                            // Wait for user choice
                            return new Promise((resolve) => {
                                dialog.querySelector('#cancelAction').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve('cancel');
                                };

                                dialog.querySelector('#archiveAction').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve('archive');
                                };

                                dialog.querySelector('#deleteAction').onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve('delete');
                                };
                            }).then(async (action) => {
                                if (action === 'cancel') return;

                                try {
                                    const { data: { user } } = await supabaseClient.auth.getUser();

                                    if (action === 'delete') {
                                        // DELETE PERMANENTLY
                                        const { error } = await supabaseClient
                                            .from('artworks')
                                            .delete()
                                            .eq('id', artworkId)
                                            .eq('artist_id', user.id);

                                        if (error) throw error;
                                        showToast('Artwork permanently deleted');

                                        await logActivity(
                                            ACTIVITY_TYPES.ARTWORK_DELETE,
                                            'Deleted artwork',
                                            `Permanently deleted artwork`,
                                            { artwork_id: artworkId }
                                        );

                                    } else if (action === 'archive') {
                                        // ARCHIVE
                                        const { error } = await supabaseClient
                                            .from('artworks')
                                            .update({ is_archived: true })
                                            .eq('id', artworkId)
                                            .eq('artist_id', user.id);

                                        if (error) throw error;
                                        showToast('Artwork archived');

                                        await logActivity(
                                            ACTIVITY_TYPES.ARTWORK_ARCHIVE,
                                            'Archived artwork', 
                                            `Archived artwork - hidden from main collection`,
                                            { artwork_id: artworkId }
                                        );
                                    }

                                    // Refresh data
                                    clearPortfolioCache();
                                    fetchUserArtworks();
                                    updateStats();

                                } catch (error) {
                                    console.error('Error:', error);
                                    showToast('Error processing artwork', 'error');
                                }
                            });
                        }

                    async function fetchUserArtworks() {
                        try {
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (!user) return [];

                            // ONLY fetch NON-ARCHIVED artworks for dashboard
                            const { data: artworks, error } = await supabaseClient
                                .from('artworks')
                                .select('*')
                                .eq('artist_id', user.id)
                                .eq('is_archived', false)
                                .order('created_at', { ascending: false });

                            if (error) {
                                console.error('Error fetching artworks:', error);
                                return [];
                            }

                            currentArtworks = artworks || [];
                            displayArtworksGrid(currentArtworks);

                            loadProfileCollections();

                            updateStats();
                            return currentArtworks;

                        } catch (error) {
                            console.error('Error fetching artworks:', error);
                            return [];
                        }
                    }


                        function displayArtworksGrid(artworks) {
                            const grid = document.getElementById('artworksGrid');
                            if (!grid) return;

                            if (!artworks || artworks.length === 0) {
                                grid.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="10" y="10" width="60" height="60" rx="4" fill="none"/>
                                                <line x1="25" y1="25" x2="55" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <line x1="55" y1="25" x2="25" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <circle cx="40" cy="40" r="8" fill="none"/>
                                            </svg>
                                        </div>
                                        <h4>No artworks yet</h4>
                                        <p>Add your first artwork to start building your archive</p>
                                        <button class="cta-button" onclick="showUploadForm()">Upload Your First Piece</button>
                                    </div>
                                `;
                                return;
                            }

                            //  CONVEYOR BELT LAYOUT
                            grid.innerHTML = `
                                <div class="conveyor-belt-container">
                                    <div class="conveyor-belt-track">
                                        ${artworks.map(artwork => `
                                            <div class="conveyor-item artwork-card">
                                                <div class="artwork-image">
                                                    <img src="${artwork.image_url}" alt="${artwork.title}" loading="lazy" decoding="async" style="width: 100%; height: auto; display: block;">
                                                </div>
                                                <div class="artwork-info">
                                                    <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                    <div class="artwork-details">
                                                        ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                        ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                        ${artwork.dimensions ? `<div>${artwork.dimensions}</div>` : ''}
                                                    </div>
                                                    <!-- PORTFOLIO STATUS BADGES -->
                                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                                        ${artwork.is_public ? `
                                                            <span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                                                                Public
                                                            </span>
                                                        ` : `
                                                            <span style="background: #666; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                                                                Private
                                                            </span>
                                                        `}

                                                        ${artwork.is_public ? `
                                                            <span style="background: #2196F3; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                                                                Ready for Portfolio
                                                            </span>
                                                        ` : `
                                                            <span style="background: #FF9800; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">
                                                                Make Public First
                                                            </span>
                                                        `}
                                                    </div>
                                                    <div class="artwork-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                                                        <button class="delete-btn" onclick="editArtwork('${artwork.id}')" style="margin: 0;">Edit</button>
                                                        <button class="delete-btn" onclick="toggleArtworkVisibility('${artwork.id}')" style="margin: 0;">
                                                            ${artwork.is_public ? 'Make Private' : 'Make Public'}
                                                        </button>
                                                        <button class="delete-btn" onclick="archiveOrDeleteArtwork('${artwork.id}')" style="margin: 0;">Archive/Delete</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        async function deleteArtwork(artworkId) {
                            if (!confirm('Are you sure you want to delete this artwork?')) return;

                            try {
                                const { error } = await supabaseClient
                                    .from('artworks')
                                    .delete()
                                    .eq('id', artworkId);

                                if (error) throw error;

                                showToast('Artwork deleted successfully');
                                fetchUserArtworks();
                                clearPortfolioCache();

                            } catch (error) {
                                console.error('Error deleting artwork:', error);
                                showToast('Error deleting artwork', 'error');
                            }
                        }

                        // ==================== EVENT MANAGEMENT ====================
                        async function createEvent(event) {
                            event.preventDefault();

                            const submitBtn = document.getElementById('eventSubmitBtn');
                            const submitText = document.getElementById('eventSubmitText');

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                const formData = new FormData(event.target);
                                const title = formData.get('title');
                                const eventType = formData.get('eventType');
                                const eventDate = formData.get('eventDate');
                                const eventTime = formData.get('eventTime');
                                const location = formData.get('location');
                                const description = formData.get('description');
                                const isPublic = formData.get('isPublic') === 'on';

                                if (!title || !eventDate) {
                                    showToast('Please fill in required fields', 'error');
                                    return;
                                }

                                // Set loading state
                                submitBtn.disabled = true;
                                submitText.innerHTML = '<span class="loading-spinner"></span> Saving...';

                                let imageUrl = null;
                                let imagePath = null;

                                // Upload event image if selected
                                if (selectedEventImageFile) {
                                    const imageName = `${user.id}/events/${Date.now()}_${selectedEventImageFile.name}`;
                                    const { data: imageData, error: uploadError } = await supabaseClient.storage
                                        .from('artwork-images')
                                        .upload(imageName, selectedEventImageFile);

                                    if (uploadError) throw uploadError;

                                    const { data: { publicUrl } } = supabaseClient.storage
                                        .from('artwork-images')
                                        .getPublicUrl(imageData.path);

                                    imageUrl = publicUrl;
                                    imagePath = imageData.path;
                                }

                                // CHECK EDIT MODE
                                const isEdit = event.target.dataset.mode === 'edit';
                                const eventId = event.target.dataset.eventId;

                                if (isEdit && eventId) {
                                    // UPDATE EXISTING EVENT
                                    const updateData = {
                                        title: title,
                                        event_type: eventType,
                                        event_date: eventDate,
                                        event_time: eventTime,
                                        location: location,
                                        description: description,
                                        is_public: isPublic
                                    };

                                    if (imageUrl) {
                                        updateData.image_url = imageUrl;
                                        updateData.image_path = imagePath;
                                    }

                                    const { error } = await supabaseClient
                                        .from('events')
                                        .update(updateData)
                                        .eq('id', eventId)
                                        .eq('artist_id', user.id);

                                    if (error) throw error;

                                    showToast('Event updated');

                                    await logActivity(
                                        ACTIVITY_TYPES.EVENT_UPDATE,
                                        'Updated event', 
                                        `Modified "${title}" event`,
                                        { event_id: eventId }
                                    );
                                    
                                } else {
                                    // CREATE NEW EVENT
                                    const eventData = {
                                        artist_id: user.id,
                                        title: title,
                                        event_type: eventType,
                                        event_date: eventDate,
                                        event_time: eventTime || null,
                                        location: location || '',
                                        description: description || '',
                                        is_public: isPublic,
                                        image_url: imageUrl,
                                        image_path: imagePath
                                    };

                                    const { data, error } = await supabaseClient
                                        .from('events')
                                        .insert([eventData])
                                        .select();

                                    if (error) throw error;

                                    // Log activity
                                    await logActivity(
                                        ACTIVITY_TYPES.EVENT_CREATE,
                                        'Added new event',
                                        `Created "${title}" event`,
                                        { event_id: data[0].id }
                                    );

                                    showToast('Event added');
                                }

                                hideAddEventForm();
                                clearEventImageSelection();
                                fetchUserEvents();
                                updateStats();

                                // Clear cache to force fresh data
                                cachedEventsData = null;
                                if (document.getElementById('portfolio-section').style.display === 'block') {
                                    loadPortfolio();
                                }

                            } catch (error) {
                                console.error('Error saving event:', error);
                                showToast('Error saving event: ' + error.message, 'error');
                            } finally {
                                submitBtn.disabled = false;
                                submitText.textContent = isEdit ? 'Update Event' : 'Add Event';
                            }
                        }

                        async function fetchUserEvents() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return [];

                                // Show ALL events in dashboard (not just future ones)
                                const { data: events, error } = await supabaseClient
                                    .from('events')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .order('event_date', { ascending: true });

                                if (error) {
                                    console.error('Error fetching events:', error);
                                    return [];
                                }

                                // Store events globally for stats counting
                                window.currentEvents = events || [];

                                displayEventsGrid(window.currentEvents);
                                updateStats();
                                return window.currentEvents;

                            } catch (error) {
                                console.error('Error fetching events:', error);
                                return [];
                            }
                        }

                        function displayEventsGrid(events) {
                            const grid = document.getElementById('eventsGrid');
                            if (!grid) return;

                            if (!events || events.length === 0) {
                                grid.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="15" y="15" width="50" height="35" rx="2" fill="none"/>
                                                <rect x="20" y="55" width="40" height="15" rx="1" fill="none"/>
                                                <line x1="30" y1="20" x2="50" y2="20" stroke="#ddd" stroke-width="1"/>
                                                <line x1="30" y1="25" x2="50" y2="25" stroke="#ddd" stroke-width="1"/>
                                                <line x1="30" y1="30" x2="40" y2="30" stroke="#ddd" stroke-width="1"/>
                                            </svg>
                                        </div>
                                        <h4>No upcoming events</h4>
                                        <p>Add exhibitions, shows, or important dates to track your artistic calendar</p>
                                        <button class="cta-button" onclick="showAddEventForm()">Add Your First Event</button>
                                    </div>
                                `;
                                return;
                            }

                            //  CONVEYOR BELT LAYOUT FOR EVENTS TOO
                            grid.innerHTML = `
                                <div class="conveyor-belt-container">
                                    <div class="conveyor-belt-track">
                                        ${events.map(event => {
                                            const eventDate = new Date(event.event_date);
                                            const formattedDate = eventDate.toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            });

                                            return `
                                                <div class="conveyor-item event-card" style="min-width: 320px;">
                                                    <div class="artwork-image" style="height: 220px; overflow: hidden;">
                                                        ${event.image_url ? `
                                                            <img src="${event.image_url}" alt="${event.title}" style="width:100%;height:100%;object-fit: cover; display:block;">
                                                        ` : `
                                                            <div style="width:100%;height:100%;background:#f5f5f5;position:relative;display:flex;align-items:center;justify-content:center;">
                                                                <svg width="60" height="60" viewBox="0 0 100 100">
                                                                    <circle cx="50" cy="40" r="15" fill="none" stroke="#ddd" stroke-width="1"/>
                                                                    <rect x="30" y="60" width="40" height="20" fill="none" stroke="#ddd" stroke-width="1"/>
                                                                    <text x="50" y="58" text-anchor="middle" fill="#999" font-family="Arial" font-size="6">EVENT</text>
                                                                </svg>
                                                            </div>
                                                        `}
                                                    </div>

                                                    <div class="artwork-info" style="padding: 1rem 0.75rem 0.75rem;">
                                                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                                            ${event.event_type === 'exhibition' ? 'Exhibition' : 
                                                              event.event_type === 'show' ? 'Show' :
                                                              event.event_type === 'opening' ? 'Opening' :
                                                              event.event_type === 'deadline' ? 'Deadline' : 'Event'}
                                                        </div>

                                                        <h3 class="artwork-title" style="font-size: 0.95rem; margin-bottom: 0.5rem; line-height: 1.2;">${event.title}</h3>

                                                        <div class="artwork-details" style="font-size: 0.8rem;">
                                                            <div style="margin-bottom: 0.4rem; font-weight: 500;">${formattedDate}${event.event_time ? `  ${event.event_time}` : ''}</div>
                                                            ${event.location ? `<div style="margin-bottom: 0.5rem; color: #666;"> ${event.location}</div>` : ''}
                                                            ${event.description ? `
                                                                <div style="color:#666;line-height:1.3;margin-top:0.5rem; font-size: 0.8rem;">${event.description}</div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        // ==================== EVENT EDIT FUNCTIONALITY ====================
                        async function editEvent(eventId) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                // Fetch event data
                                const { data: event, error } = await supabaseClient
                                    .from('events')
                                    .select('*')
                                    .eq('id', eventId)
                                    .eq('artist_id', user.id)
                                    .single();

                                if (error) throw error;
                                if (!event) throw new Error('Event not found');

                                // Populate the add event form with existing data
                                document.getElementById('eventTitle').value = event.title;
                                document.getElementById('eventType').value = event.event_type;
                                document.getElementById('eventDate').value = event.event_date;
                                document.getElementById('eventTime').value = event.event_time || '';
                                document.getElementById('eventLocation').value = event.location || '';
                                document.getElementById('eventDescription').value = event.description || '';

                                // Set public checkbox
                                const isPublicCheckbox = document.querySelector('input[name="isPublic"]');
                                if (isPublicCheckbox) {
                                    isPublicCheckbox.checked = event.is_public;
                                }

                                // Set form to edit mode
                                document.getElementById('eventForm').dataset.mode = 'edit';
                                document.getElementById('eventForm').dataset.eventId = eventId;

                                // Show current image if exists
                                if (event.image_url) {
                                    document.getElementById('eventUploadPlaceholder').style.display = 'none';
                                    document.getElementById('eventImagePreview').style.display = 'block';
                                    document.getElementById('eventImagePreview').innerHTML = `
                                        <img src="${event.image_url}" alt="${event.title}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                        <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                                            Current event image
                                            <button type="button" onclick="clearEventImageSelection()" style="margin-left: 1rem; color: #ff4444; background: none; border: none; cursor: pointer;">
                                                Remove
                                            </button>
                                        </div>
                                    `;
                                }

                                // Show the form
                                document.getElementById('eventFormTitle').textContent = 'Edit Event';
                                document.getElementById('eventSubmitText').textContent = 'Update Event';
                                document.getElementById('addEventPopup').style.display = 'flex';

                            } catch (error) {
                                console.error('Error loading event for editing:', error);
                                showToast('Error loading event', 'error');
                            }
                        }

                        async function deleteEvent(eventId) {
                            if (!confirm('Are you sure you want to delete this event?')) return;

                            try {
                                // Get event title first for logging
                                const { data: event } = await supabaseClient
                                    .from('events')
                                    .select('title')
                                    .eq('id', eventId)
                                    .single();

                                const { error } = await supabaseClient
                                    .from('events')
                                    .delete()
                                    .eq('id', eventId);

                                if (error) throw error;

                                showToast('Event deleted successfully');

                                // EVENT DELETE LOGGING
                                await logActivity(
                                    ACTIVITY_TYPES.EVENT_DELETE,
                                    'Deleted event',
                                    `Removed "${event?.title || 'event'}" from events`,
                                    { event_id: eventId }
                                );

                                fetchUserEvents();
                                updateStats();
                                clearPortfolioCache();

                            } catch (error) {
                                console.error('Error deleting event:', error);
                                showToast('Error deleting event', 'error');
                            }
                        }

                        // ==================== PROFILE MANAGEMENT ====================
                        async function loadProfileData() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                console.log(" Loading profile data for:", user.id);

                                const { data: profile, error } = await supabaseClient
                                    .from('profiles')
                                    .select('*, portfolio_layout, image_size')
                                    .eq('id', user.id)
                                    .single();

                                if (error) {
                                    console.error('Error loading profile:', error);
                                    // Set defaults
                                    document.getElementById('username').value = user.email.split('@')[0];
                                    document.getElementById('profileFullName').value = user.user_metadata?.full_name || '';
                                    document.getElementById('bio').value = '';
                                    document.getElementById('website').value = '';
                                    document.getElementById('contactEmail').value = user.email;
                                    document.getElementById('portfolioLink').value = `trac.art/${user.email.split('@')[0]}`;

                                    // Initialize CV status
                                    updateCVStatusDisplay(false);

                                    // Initialize empty social platforms
                                    loadSocialPlatforms('');
                                    return;
                                }

                                console.log(" Profile loaded:", profile);

                                // Populate form with actual data
                                document.getElementById('username').value = profile.username || user.email.split('@')[0];
                                document.getElementById('profileFullName').value = profile.full_name || user.user_metadata?.full_name || '';
                                document.getElementById('bio').value = profile.bio || '';
                                document.getElementById('website').value = profile.website || '';
                                document.getElementById('contactEmail').value = profile.contact_email || user.email;
                                const portfolioUrl = `${window.location.origin}${window.location.pathname}?view=portfolio&username=${profile.username || user.email.split('@')[0]}`;
                                document.getElementById('portfolioLink').href = portfolioUrl;
                                document.getElementById('portfolioLink').textContent = portfolioUrl;

                                if (profile.profile_photo_url) {
                                    document.getElementById('profilePhotoPreview').innerHTML = `
                                        <img src="${profile.profile_photo_url}" alt="Current Profile Photo" style="max-width: 200px; border-radius: 8px;">
                                    `;
                                }

                                // Update CV status display
                                updateCVStatusDisplay(profile.has_cv, profile.cv_url);

                                // Load social platforms
                                loadSocialPlatforms(profile.social_links || '');

                                if (profile.image_size) {
                                    const sizeRadio = document.querySelector(`input[name="imageSize"][value="${profile.image_size}"]`);
                                    if (sizeRadio) {
                                        sizeRadio.checked = true;
                                    }
                                }

                                console.log(" Form populated with saved data");

                            } catch (error) {
                                console.error('Error loading profile data:', error);
                                // Fallback defaults
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (user) {
                                    document.getElementById('username').value = user.email.split('@')[0];
                                    document.getElementById('profileFullName').value = user.user_metadata?.full_name || '';
                                    document.getElementById('contactEmail').value = user.email;
                                    document.getElementById('portfolioLink').value = `trac.art/${user.email.split('@')[0]}`;
                                    updateCVStatusDisplay(false);
                                    loadSocialPlatforms('');
                                }
                            }
                        }

                        // ==================== PROFILE COLLECTIONS MANAGEMENT ====================
                    async function loadProfileCollections() {
                        try {
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (!user) return;

                            const { data: collections, error } = await supabaseClient
                                .from('collections')
                                .select(`
                                    *,
                                    artwork_collections (
                                        artwork_id
                                    )
                                `)
                                .eq('artist_id', user.id)
                                .order('created_at', { ascending: false });

                            if (error) throw error;

                            //  SET THE GLOBAL VARIABLE
                            window.currentCollections = collections || [];

                            displayProfileCollections(collections || []);

                            //  FORCE UPDATE THE COUNT IMMEDIATELY
                            document.getElementById('collectionsCount').textContent = window.currentCollections.length;

                        } catch (error) {
                            console.error('Error loading collections:', error);
                            document.getElementById('collectionsContainer').innerHTML = '<p style="color: #666; font-size: 0.9rem;">Error loading collections</p>';
                            window.currentCollections = [];
                            document.getElementById('collectionsCount').textContent = '0';
                        }
                    }


                        function displayProfileCollections(collections) {
                            const container = document.getElementById('collectionsContainer');
                            if (!container) return;

                            if (!collections || collections.length === 0) {
                                container.innerHTML = '<p style="color: #666; font-size: 0.9rem;">No collections yet</p>';
                                return;
                            }

                            container.innerHTML = collections.map(collection => `
                                <div class="collection-item" style="border: 1px solid #e5e5e5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 500;">${collection.name}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.8rem;">
                                            ${collection.artwork_collections ? collection.artwork_collections.length : 0} artworks  ${collection.is_public ? 'Public' : 'Private'}
                                        </p>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem; flex-shrink: 0; min-width: 80px;">
    <button type="button" onclick="event.stopPropagation(); editCollection('${collection.id}', event)" 
            style="color: #000; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem; text-align: left; padding: 0.1rem 0;">
        Edit
    </button>
    <button type="button" onclick="event.stopPropagation(); toggleCollectionPrivacy('${collection.id}', ${collection.is_public}, event)" 
            style="color: #000; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem; text-align: left; padding: 0.1rem 0;">
        ${collection.is_public ? 'Make Private' : 'Make Public'}
    </button>
    <button type="button" onclick="event.stopPropagation(); deleteCollection('${collection.id}', event)" 
            style="color: #ff4444; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.7rem; text-align: left; padding: 0.1rem 0;">
        Delete
    </button>
</div>
                                </div>
                            `).join('');
                        }

                        async function copyPortfolioLink() {
                            
                            const { data: { user } } = await supabaseClient.auth.getUser();
                            if (!user) {
                                showToast('You must be logged in', 'error');
                                return;
                            }

                            const { data: profile } = await supabaseClient
                                .from('profiles')
                                .select('username')
                                .eq('id', user.id)
                                .single();

                            const username = profile?.username;
                            if (!username) {
                                showToast('Please set a username in profile settings first', 'error');
                                return;
                            }

                            const portfolioUrl = `${window.location.origin}${window.location.pathname}?view=portfolio&username=${username}`;

                            navigator.clipboard.writeText(portfolioUrl).then(() => {
                                showToast('Portfolio link copied to clipboard!');
                            }).catch(err => {
                                const tempInput = document.createElement('input');
                                tempInput.value = portfolioUrl;
                                document.body.appendChild(tempInput);
                                tempInput.select();
                                document.execCommand('copy');
                                document.body.removeChild(tempInput);
                                showToast('Portfolio link copied to clipboard!');
                            });
                        }

                        // Basic collection management functions
                        async function toggleCollectionPrivacy(collectionId, currentStatus) {
                             if (event) event.preventDefault();
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                const { error } = await supabaseClient
                                    .from('collections')
                                    .update({ is_public: !currentStatus })
                                    .eq('id', collectionId)
                                    .eq('artist_id', user.id);

                                if (error) throw error;

                                showToast(`Collection made ${!currentStatus ? 'public' : 'private'}`);
                                loadProfileCollections();
                                clearPortfolioCache();

                            } catch (error) {
                                console.error('Error updating collection privacy:', error);
                                showToast('Error updating collection', 'error');
                            }
                        }

                        async function deleteCollection(collectionId) {
                            if (event) event.preventDefault();
                            const confirmed = await showConfirmDialog(
                                'Delete Collection',
                                'Are you sure you want to delete this collection? This will not delete the artworks.',
                                'Delete Collection',
                                'Keep Collection'
                            );

                            if (!confirmed) return;

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();

                                // First remove artwork links
                                const { error: linkError } = await supabaseClient
                                    .from('artwork_collections')
                                    .delete()
                                    .eq('collection_id', collectionId);

                                if (linkError) throw linkError;

                                // Then delete collection
                                const { error } = await supabaseClient
                                    .from('collections')
                                    .delete()
                                    .eq('id', collectionId)
                                    .eq('artist_id', user.id);

                                if (error) throw error;

                                showToast('Collection deleted');
                                loadProfileCollections();
                                clearPortfolioCache();

                            } catch (error) {
                                console.error('Error deleting collection:', error);
                                showToast('Error deleting collection', 'error');
                            }
                        }

                        async function loadAvailableArtworks() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                const { data: artworks, error } = await supabaseClient
                                    .from('artworks')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .eq('is_public', true)
                                    .eq('is_archived', false)
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                const container = document.getElementById('availableArtworks');
                                if (artworks && artworks.length > 0) {
                                    container.innerHTML = artworks.map(artwork => `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
                                            <input type="checkbox" name="artworkIds" value="${artwork.id}">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                                                <img src="${artwork.image_url}" alt="${artwork.title}" 
                                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                                                <div style="flex: 1;">
                                                    <div style="font-size: 0.8rem; font-weight: 500;">${artwork.title || 'Untitled'}</div>
                                                    <div style="font-size: 0.7rem; color: #666;">
                                                        ${artwork.year || ''} ${artwork.year && artwork.medium ? '' : ''} ${artwork.medium || ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    `).join('');
                                } else {
                                    container.innerHTML = '<p style="color: #666; font-size: 0.8rem;">No artworks available</p>';
                                }

                            } catch (error) {
                                console.error('Error loading artworks:', error);
                                document.getElementById('availableArtworks').innerHTML = '<p style="color: #666; font-size: 0.8rem;">Error loading artworks</p>';
                            }
                        }

                        async function editCollection(collectionId) {
                             if (event) event.preventDefault();
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                // Fetch collection data
                                const { data: collection, error } = await supabaseClient
                                    .from('collections')
                                    .select(`
                                        *,
                                        artwork_collections (
                                            artwork_id
                                        )
                                    `)
                                    .eq('id', collectionId)
                                    .eq('artist_id', user.id)
                                    .single();

                                if (error) throw error;
                                if (!collection) throw new Error('Collection not found');

                                // Show edit collection form
                                showEditCollectionForm(collection);

                            } catch (error) {
                                console.error('Error loading collection for editing:', error);
                                showToast('Error loading collection', 'error');
                            }
                        }

                        function showEditCollectionForm(collection) {
                            // Populate the existing create collection form with collection data
                            document.getElementById('collectionTitle').value = collection.name || '';
                            document.getElementById('collectionStatement').value = collection.description || '';

                            // Set form to edit mode
                            document.getElementById('collectionForm').dataset.mode = 'edit';
                            document.getElementById('collectionForm').dataset.collectionId = collection.id;

                            // Update UI
                            document.querySelector('#createCollectionForm .form-header h4').textContent = 'Edit Collection';
                            document.querySelector('#collectionSubmitText').textContent = 'Update Collection';

                            // Load available artworks for this collection
                            loadAvailableArtworksForCollection(collection.id);

                            // Show the form
                            document.getElementById('createCollectionForm').style.display = 'block';
                        }

                        async function loadAvailableArtworksForCollection(collectionId) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                // Get all user's public artworks
                                const { data: artworks, error } = await supabaseClient
                                    .from('artworks')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .eq('is_public', true)
                                    .eq('is_archived', false)
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                // Get artworks already in this collection
                                const { data: collectionArtworks, error: collectionError } = await supabaseClient
                                    .from('artwork_collections')
                                    .select('artwork_id')
                                    .eq('collection_id', collectionId);

                                if (collectionError) throw collectionError;

                                const collectionArtworkIds = collectionArtworks?.map(ca => ca.artwork_id) || [];

                                // Display artworks with checkboxes
                                const container = document.getElementById('availableArtworks');
                                container.innerHTML = artworks.map(artwork => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
                                        <input type="checkbox" name="artworkIds" value="${artwork.id}" 
                                               ${collectionArtworkIds.includes(artwork.id) ? 'checked' : ''}>
                                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 0.8rem; font-weight: 500;">${artwork.title || 'Untitled'}</div>
                                                <div style="font-size: 0.7rem; color: #666;">
                                                    ${artwork.year || ''} ${artwork.year && artwork.medium ? '' : ''} ${artwork.medium || ''}
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                `).join('');

                            } catch (error) {
                                console.error('Error loading artworks for collection:', error);
                                document.getElementById('availableArtworks').innerHTML = '<p style="color: #666; font-size: 0.8rem;">Error loading artworks</p>';
                            }
                        }

                        // PUBLIC PORTFOLIO //
                        async function loadPublicPortfolio(username) {
                            try {
                                console.log(" Loading public portfolio data for:", username);

                                const { data: profile, error } = await supabaseClient
                                    .from('profiles')
                                    .select('*')
                                    .eq('username', username)
                                    .single();

                                if (error || !profile) {
                                    document.getElementById('portfolioPage').innerHTML = `
                                        <div style="padding: 4rem; text-align: center;">
                                            <h1>Portfolio Not Found</h1>
                                            <p>The artist "${username}" doesn't exist or their portfolio is private.</p>
                                        </div>
                                    `;
                                    return false;
                                }

                                const { data: artworks } = await supabaseClient
                                    .from('artworks')
                                    .select('*')
                                    .eq('artist_id', profile.id)
                                    .eq('is_public', true)
                                    .eq('is_archived', false)
                                    .order('created_at', { ascending: false });

                                const { data: collections } = await supabaseClient
                                    .from('collections')
                                    .select(`
                                        *,
                                        artwork_collections (
                                            artworks (*)
                                        )
                                    `)
                                    .eq('artist_id', profile.id)
                                    .eq('is_public', true)
                                    .order('created_at', { ascending: false });

                                const { data: events } = await supabaseClient
                                    .from('events')
                                    .select('*')
                                    .eq('artist_id', profile.id)
                                    .eq('is_public', true)
                                    .order('event_date', { ascending: true });

                                displayPortfolio(profile, artworks || [], collections || [], events || [], false);
                                setTimeout(() => updateFooterContactDisplay(profile), 100);

                                return true;

                            } catch (error) {
                                console.error('Error loading public portfolio:', error);
                                document.getElementById('portfolioPage').innerHTML = `
                                    <div style="padding: 4rem; text-align: center;">
                                        <h1>Error Loading Portfolio</h1>
                                        <p>Please try again later.</p>
                                    </div>
                                `;
                                return false;
                            }
                        }
                        
                        // ==================== ACTIVITY SYSTEM ====================
                        async function logActivity(type, title, description = null, metadata = {}) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) {
                                    console.log('No user found - skipping activity log');
                                    return;
                                }

                                const { error } = await supabaseClient
                                    .from('activities')
                                    .insert([{
                                        artist_id: user.id,
                                        activity_type: type,
                                        title: title,
                                        description: description,
                                        metadata: metadata,
                                        created_at: new Date().toISOString()
                                    }]);

                                if (error) {
                                    console.error('Error logging activity:', error);
                                    return;
                                }

                                console.log('Activity logged:', type);

                            } catch (error) {
                                console.error('Unexpected error logging activity:', error);
                                // Fail silently - don't break main functionality
                            }
                        }

                        async function fetchActivities(limit = 10) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return [];

                                const { data: activities, error } = await supabaseClient
                                    .from('activities')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .order('created_at', { ascending: false })
                                    .limit(limit);

                                if (error) throw error;

                                return activities || [];

                            } catch (error) {
                                console.error('Error fetching activities:', error);
                                return [];
                            }
                        }

                        function displayActivities(activities) {
                            const container = document.getElementById('activitiesList');
                            if (!container) return;

                            if (!activities || activities.length === 0) {
                                container.innerHTML = `
                                    <div class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p><strong>Welcome to TRAC</strong> - Your artist archive is ready</p>
                                            <div class="activity-time">Just now</div>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>Upload your first artwork to start building your portfolio</p>
                                            <div class="activity-time">Today</div>
                                        </div>
                                    </div>
                                `;
                                return;
                            }

                            container.innerHTML = activities.map(activity => {
                                // Customize display based on activity type
                                let displayText = activity.title;
                                if (activity.description) {
                                    displayText += ` - ${activity.description}`;
                                }

                                return `
                                    <div class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>${displayText}</p>
                                            <div class="activity-time">${formatActivityTime(activity.created_at)}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }

                        function formatActivityTime(timestamp) {
                            if (!timestamp) return 'Recently';

                            const now = new Date();
                            const activityTime = new Date(timestamp);
                            const diffMs = now - activityTime;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);

                            if (diffMins < 1) return 'Just now';
                            if (diffMins < 60) return `${diffMins}m ago`;
                            if (diffHours < 24) return `${diffHours}h ago`;
                            if (diffDays < 7) return `${diffDays}d ago`;
                            return activityTime.toLocaleDateString();
                        }

                        // ==================== PORTFOLIO SYSTEM ====================
                        async function loadPortfolio() {
                            try {
                                console.log(" Loading portfolio...");
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                const isOwner = !!user; //  ADD THIS LINE

                                if (!user) {
                                    console.log(" No user for portfolio");
                                    return null;
                                }

                                // Load profile data
                                const { data: profile, error: profileError } = await supabaseClient
                                    .from('profiles')
                                    .select('*')
                                    .eq('id', user.id)
                                    .single();

                                // Load artworks, collections, events...
                                const { data: artworks, error: artworksError } = await supabaseClient
                                    .from('artworks')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .eq('is_public', true)
                                    .eq('is_archived', false)
                                    .order('created_at', { ascending: false });

                                const { data: collections, error: collectionsError } = await supabaseClient
                                    .from('collections')
                                    .select(`
                                        *,
                                        artwork_collections (
                                            artworks (*)
                                        )
                                    `)
                                    .eq('artist_id', user.id)
                                    .eq('is_public', true)
                                    .order('created_at', { ascending: false });

                                const { data: events, error: eventsError } = await supabaseClient
                                    .from('events')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .eq('is_public', true)
                                    .order('event_date', { ascending: true });

                                //  PASS isOwner TO displayPortfolio
                                displayPortfolio(profile, artworks || [], collections || [], events || [], isOwner);

                                //  APPLY HEADER/FOOTER:
                                if (profile) {
                                    updateHeaderOnly(profile.header_layout, profile);
                                    updateFooterOnly(profile.footer_style, profile);
                                    applySavedStyles(profile);
                                }

                                setupPortfolioNavigation();

                                return { profile, artworks: artworks || [], collections: collections || [], events: events || [] };

                            } catch (error) {
                                console.error('Error loading portfolio:', error);
                                return null;
                            }
                        }

                        function applyCustomColors(colors) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage || !colors) return;

                            //  CHECK IF COLORS ARE ALREADY SET TO CURRENT VALUES
                            const currentBg = portfolioPage.style.getPropertyValue('--bg-color');
                            if (currentBg === colors.bg) {
                                console.log(' Colors already applied, skipping duplicate');
                                return;
                            }

                            console.log(' Applying custom colors (first time):', colors);

                            if (colors.bg) portfolioPage.style.setProperty('--bg-color', colors.bg);
                            if (colors.text) portfolioPage.style.setProperty('--text-color', colors.text);
                            if (colors.accent) portfolioPage.style.setProperty('--accent-color', colors.accent);
                            if (colors.border) portfolioPage.style.setProperty('--border-color', colors.border);
                        }
                        
                        function displayPortfolio(profileData, artworks, collections = [], events = [], isOwner = true) {
                            //  CHECK IF ALREADY APPLIED TO PREVENT DUPLICATES
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            //  ADD LOADING STATE TO PREVENT MULTIPLE CALLS
                            if (portfolioPage.classList.contains('loading')) {
                                console.log(' Portfolio already loading, skipping duplicate call');
                                return;
                            }

                            portfolioPage.classList.add('loading');

                            console.log(' Applying portfolio styles (first time)');

                            //  CONSOLIDATE STYLE APPLICATIONS - NO DUPLICATES
                            if (profileData.custom_colors) {
                                applyCustomColors(profileData.custom_colors);
                            } else {
                                // Apply defaults if no custom colors
                                portfolioPage.style.setProperty('--bg-color', '#ffffff');
                                portfolioPage.style.setProperty('--text-color', '#000000');
                                portfolioPage.style.setProperty('--accent-color', '#666666');
                                portfolioPage.style.setProperty('--border-color', '#e5e5e5');
                            }

                            if (profileData.custom_fonts) {
                                // Fonts will be applied in applySavedStyles
                            } else {
                                // Apply defaults if no custom fonts
                                portfolioPage.style.setProperty('--header-font-family', 'Space Grotesk');
                                portfolioPage.style.setProperty('--body-font-family', 'Space Grotesk');
                                portfolioPage.style.setProperty('--footer-font-family', 'Space Grotesk');
                            }

                            const currentStyle = profileData.portfolio_style || 'trac-classic';
                            const stylePreset = STYLE_PRESETS[currentStyle] || STYLE_PRESETS['trac-classic'];

                            const layoutClass = profileData.portfolio_layout || "grid-classic";
                            const sizeClass = profileData.image_size || 'medium';
                            const collectionTitleLayout = profileData.collection_title_layout || 'centered';

                            console.log(' FORCE APPLYING CLASSES (once):', { layoutClass, sizeClass, currentStyle, collectionTitleLayout });

                            let artworksHTML = '';
                            if (artworks.length > 0) {
                                artworksHTML = `
                                   <div class="artworks-grid portfolio-layout ${layoutClass} ${sizeClass}">
                                        ${artworks.map(artwork => `
                                            <div class="artwork-card">
                                                <div class="artwork-image">
                                                    <img src="${artwork.image_url}" alt="${artwork.title}" 
                                                         loading="lazy" 
                                                         decoding="async"
                                                         data-artwork-id="${artwork.id}"
                                                         data-artwork-title="${artwork.title || 'Untitled'}"
                                                         data-artwork-year="${artwork.year || ''}"
                                                         data-artwork-medium="${artwork.medium || ''}"
                                                         data-artwork-dimensions="${artwork.dimensions || ''}"
                                                         style="cursor: zoom-in; width: 100%; height: auto; display: block;">
                                                </div>
                                                <div class="artwork-info">
                                                    <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                    <div class="artwork-details">
                                                        ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                        ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                        ${artwork.dimensions ? `<div>${artwork.dimensions}</div>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            } else {
                                artworksHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                <rect x="10" y="10" width="60" height="60" rx="4" fill="none"/>
                                                <line x1="25" y1="25" x2="55" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <line x1="55" y1="25" x2="25" y2="55" stroke="#ddd" stroke-width="1"/>
                                                <circle cx="40" cy="40" r="8" fill="none"/>
                                            </svg>
                                        </div>
                                        <h4>No public artworks</h4>
                                        <p>${isOwner ? 'Make artworks public in your dashboard to appear here.' : 'This artist has no public artworks yet.'}</p>
                                        ${isOwner ? '<button class="cta-button" onclick="showSection(\'dashboard\')">Go to Dashboard</button>' : ''}
                                    </div>
                                `;
                            }

                            const portfolioHTML = `
                              ${generateHeaderHTML(stylePreset.headerLayout, profileData, isOwner)}

                            <main class="gallery-main">
                                <section id="works-section" class="portfolio-tab">
                                    <section class="artworks-section">
                                        ${collections.length > 0 ? displayCollectionsInPortfolio(collections, profileData, collectionTitleLayout, stylePreset) : artworksHTML}
                                    </section>
                                </section>

                                <section id="profile-section" class="portfolio-tab" style="display: none;">
                                    <div class="hero-section">
                                        <div class="hero-container">
                                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 3rem; align-items: start; max-width: 1000px; margin: 0 auto;">
                                                ${profileData.profile_photo_url ? `
                                                    <div>
                                                        <img src="${profileData.profile_photo_url}" alt="Profile Photo" style="width: 300px; height: auto; display: block; border-radius: 8px;">
                                                    </div>
                                                ` : ''}
                                                <div style="text-align: left;">
                                                    ${profileData.bio ? `<p style="font-size: 1.1rem; line-height: 1.6; color: #333; margin-bottom: 2rem;">${profileData.bio}</p>` : `
                                                        <p style="color: #666; font-style: italic; margin-bottom: 2rem;">Artist profile</p>
                                                    `}
                                                </div>
                                            </div>
                                            ${profileData.social_links ? `
                                                <div style="margin-top: 3rem; text-align: center;">
                                                    ${displaySocialIcons(profileData.social_links)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </section>

                                <section id="events-section" class="portfolio-tab" style="display: none;">
                                    <section class="artworks-section">
                                        ${events.length > 0 ? `
                                            <div class="artworks-grid portfolio-layout small" style="max-width: 1400px; margin: 4rem auto; gap: 5rem;">
                                                ${events.map(event => {
                                                    const eventDate = new Date(event.event_date);
                                                    const formattedDate = eventDate.toLocaleDateString('en-US', { 
                                                        month: 'short', 
                                                        day: 'numeric', 
                                                        year: 'numeric' 
                                                    });

                                                    return `
                                                       <div class="artwork-card event-card" style="margin-bottom: 1.5rem; min-width: 280px;">
                                <div class="artwork-image" style="height: 220px; overflow: hidden;">
                                    ${event.image_url ? `
                                        <img src="${event.image_url}" alt="${event.title}" style="width:100%;height:100%;object-fit: cover; display:block;">
                                    ` : `
                                        <div style="width:100%;height:100%;background:#f5f5f5;position:relative;display:flex;align-items:center;justify-content:center;">
                                            <svg width="60" height="60" viewBox="0 0 100 100">
                                                <circle cx="50" cy="40" r="15" fill="none" stroke="#ddd" stroke-width="1"/>
                                                <rect x="30" y="60" width="40" height="20" fill="none" stroke="#ddd" stroke-width="1"/>
                                                <text x="50" y="58" text-anchor="middle" fill="#999" font-family="Arial" font-size="6">EVENT</text>
                                            </svg>
                                        </div>
                                    `}
                                </div>

                                <div class="artwork-info" style="padding: 1rem 0.75rem 0.75rem;">
                                    <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                        ${event.event_type === 'exhibition' ? 'Exhibition' : 
                                          event.event_type === 'show' ? 'Show' :
                                          event.event_type === 'opening' ? 'Opening' :
                                          event.event_type === 'deadline' ? 'Deadline' : 'Event'}
                                    </div>

                                    <h3 class="artwork-title" style="font-size: 0.95rem; margin-bottom: 0.5rem; line-height: 1.2;">${event.title}</h3>

                                    <div class="artwork-details" style="font-size: 0.8rem;">
                                        <div style="margin-bottom: 0.4rem; font-weight: 500;">${formattedDate}${event.event_time ? `  ${event.event_time}` : ''}</div>
                                        ${event.location ? `<div style="margin-bottom: 0.5rem; color: #666;"> ${event.location}</div>` : ''}
                                        ${event.description ? `
                                            <div style="color:#666;line-height:1.3;margin-top:0.5rem; font-size: 0.8rem;">${event.description}</div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                                                        `;
                                                    }).join('')}
                                            </div>
                                        ` : `
                                            <div class="empty-state">
                                                <div class="empty-icon">
                                                    <svg width="80" height="80" viewBox="0 0 80 80" fill="none" stroke="#ddd" stroke-width="1.5">
                                                        <rect x="15" y="15" width="50" height="35" rx="2" fill="none"/>
                                                        <rect x="20" y="55" width="40" height="15" rx="1" fill="none"/>
                                                        <line x1="30" y1="20" x2="50" y2="20" stroke="#ddd" stroke-width="1"/>
                                                        <line x1="30" y1="25" x2="50" y2="25" stroke="#ddd" stroke-width="1"/>
                                                        <line x1="30" y1="30" x2="40" y2="30" stroke="#ddd" stroke-width="1"/>
                                                    </svg>
                                                </div>
                                                <h4>No upcoming events</h4>
                                                <p>There are no scheduled events at the moment.</p>
                                            </div>
                                        `}
                                    </section>
                                </section>
                            </main>

                            ${applyFooterStyle(stylePreset.footerStyle, profileData)}
                            `;

                            document.getElementById('portfolioPage').innerHTML = portfolioHTML;
                            document.getElementById('portfolioPage').classList.add('style-applied');

                            applySavedStyles(profileData);

                            setTimeout(() => {
                                const grid = document.querySelector('.artworks-grid');
                                console.log(' FINAL GRID CLASSES:', grid?.className);
                                console.log(' SHOULD BE:', `artworks-grid portfolio-layout ${layoutClass} ${sizeClass}`);
                            }, 100);

                            setupPortfolioNavigation();
                            setTimeout(() => {
                                updateFooterContactDisplay(profileData);
                            }, 100);
                            setTimeout(cleanPortfolioDisplay, 10);

                            setTimeout(() => {
                                portfolioPage.classList.remove('loading');
                            }, 100);
                        }

                        function generateHeaderHTML(headerLayout, profileData, isOwner = true) {
                            const artistName = profileData.full_name || profileData.username;

                            const dashboardButton = isOwner ? `
                                <nav class="gallery-nav">
                                    <a href="#" class="nav-item" onclick="showSection('dashboard')">Dashboard</a>
                                </nav>
                            ` : '';

                            const portfolioNav = `
                                <nav class="portfolio-nav">
                                    <a href="#" class="nav-item active" data-tab="works">Works</a>
                                    <a href="#" class="nav-item" data-tab="profile">Profile</a>
                                    <a href="#" class="nav-item" data-tab="events">Events</a>
                                </nav>
                            `;

                            //  CV BUTTON FOR PUBLIC ONLY (NOT FOR OWNER)
                            const cvButton = (profileData.has_cv && !isOwner) ? `
                                <span class="owner-cv-button" 
                                      onclick="showCVRequestForm()"
                                      title="CV available upon request">
                                    CV
                                </span>
                            ` : '';

                            //  OWNER-ONLY ELEMENTS (NO CV BUTTON)
                            const ownerOnlyElements = isOwner ? `
                                <button class="icon-button" onclick="toggleStyleEditor()" title="Customize Portfolio">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M8 2l2 4 4 1-2 4 2 4-4-1-2 4-2-4-4 1 2-4-2-4 4 1z"></path>
                                    </svg>
                                </button>
                                <button class="icon-button" onclick="signOut()" title="Sign Out">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M6 14H3.333C2.98 14 2.641 13.86 2.391 13.61C2.14 13.36 2 13.02 2 12.667V3.333C2 2.98 2.14 2.641 2.391 2.391C2.641 2.14 2.98 2 3.333 2H6"></path>
                                        <path d="M10.667 11.333L14 8l-3.333-3.333"></path>
                                        <path d="M14 8H6"></path>
                                    </svg>
                                </button>
                            ` : '';

                            switch(headerLayout) {
                                case 'floating':
                                    return `
                                        <header class="portfolio-header" style="position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); background: var(--bg-color, rgba(255,255,255,0.9)); backdrop-filter: blur(10px); border: 1px solid var(--border-color, #e5e5e5); border-radius: 12px; padding: 1rem 2rem; z-index: 1000; width: auto;">
                                            <div class="header-container" style="max-width: none;">
                                                <div class="header-left">
                                                    <div class="artist-name">${artistName}</div>
                                                    ${dashboardButton}
                                                </div>
                                                <div class="header-right">
                                                    ${portfolioNav}
                                                    ${cvButton} <!--  CV FOR PUBLIC ONLY -->
                                                    ${ownerOnlyElements} <!--  OWNER ONLY (NO CV) -->
                                                </div>
                                            </div>
                                        </header>
                                        <div style="height: 120px;"></div>
                                    `;

                                case 'split':
                                    return `
                                        <header class="portfolio-header">
                                            <div class="header-container" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
                                                <div class="header-left" style="justify-self: start;">
                                                    <div class="artist-name">${artistName}</div>
                                                    ${dashboardButton}
                                                </div>
                                                <div style="justify-self: center;">
                                                    ${portfolioNav}
                                                </div>
                                                <div class="header-right" style="justify-self: end;">
                                                    ${cvButton} <!--  CV FOR PUBLIC ONLY -->
                                                    ${ownerOnlyElements} <!--  OWNER ONLY (NO CV) -->
                                                </div>
                                            </div>
                                        </header>
                                    `;

                                case 'minimal':
                                    return `
                                        <header class="portfolio-header" style="border: none; padding: 2rem 0 1rem;">
                                            <div class="header-container" style="text-align: center;">
                                                <div class="artist-name" style="font-size: 2.5rem; font-weight: 300; letter-spacing: -0.02em; margin-bottom: 1rem;">${artistName}</div>
                                                ${isOwner ? `
                                                    <div style="margin-top: 1rem;">
                                                        <a href="#" class="nav-item" onclick="showSection('dashboard')" style="font-size: 0.9rem; color: #666; text-decoration: underline;">Dashboard</a>
                                                        ${portfolioNav}
                                                        <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem; align-items: center;">
                                                            ${ownerOnlyElements} <!--  OWNER ONLY (NO CV) -->
                                                        </div>
                                                    </div>
                                                ` : `
                                                    ${portfolioNav}
                                                    <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem; align-items: center;">
                                                        ${cvButton} <!--  CV FOR PUBLIC ONLY -->
                                                    </div>
                                                `}
                                            </div>
                                        </header>
                                    `;

                                case 'expressive':
                                    return `
                                        <header class="portfolio-header" style="background: var(--accent-color, #000); color: white; padding: 4rem 0;">
                                            <div class="header-container" style="text-align: center;">
                                                <div class="artist-name" style="font-size: 4rem; font-weight: 700; letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 1rem;">${artistName}</div>
                                                ${portfolioNav}
                                                <div style="margin-top: 2rem; display: flex; justify-content: center; gap: 1rem; align-items: center;">
                                                    ${cvButton} <!--  CV FOR PUBLIC ONLY -->
                                                    ${isOwner ? ownerOnlyElements : ''}
                                                </div>
                                            </div>
                                        </header>
                                    `;

                                case 'left-aligned':
                                default:
                                    return `
                                        <header class="portfolio-header">
                                            <div class="header-container">
                                                <div class="header-left">
                                                    <div class="artist-name">${artistName}</div>
                                                    ${dashboardButton}
                                                </div>
                                                <div class="header-right">
                                                    ${portfolioNav}
                                                    ${cvButton} <!--  CV FOR PUBLIC ONLY -->
                                                    ${ownerOnlyElements} <!--  OWNER ONLY (NO CV) -->
                                                </div>
                                            </div>
                                        </header>
                                    `;
                            }
                        }

                        function updateHeaderOnly(headerLayout, profileData, isOwner = true) {
                            console.log(' updateHeaderOnly called with:', headerLayout);

                            const newHeaderHTML = generateHeaderHTML(headerLayout, profileData, isOwner);

                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) {
                                console.log(' No portfolio page found');
                                return;
                            }

                            // Remove ALL existing headers and spacers
                            const oldHeaders = portfolioPage.querySelectorAll('.portfolio-header, header');
                            oldHeaders.forEach(header => header.remove());

                            const spacers = portfolioPage.querySelectorAll('[style*="height: 120px"], [style*="height: 80px"]');
                            spacers.forEach(spacer => spacer.remove());

                            // Insert new header at the very top
                            portfolioPage.insertAdjacentHTML('afterbegin', newHeaderHTML);
                            console.log(' Header updated to:', headerLayout);
                        }

                        function updateFooterOnly(footerStyle, profileData) {
                            console.log(' updateFooterOnly called with:', footerStyle);

                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            // Remove ALL existing footers
                            const oldFooters = portfolioPage.querySelectorAll('footer');
                            oldFooters.forEach(footer => footer.remove());

                            // Create and insert new footer
                            const newFooterHTML = applyFooterStyle(footerStyle, profileData);
                            if (newFooterHTML) {
                                portfolioPage.insertAdjacentHTML('beforeend', newFooterHTML);
                                console.log(' Footer updated to:', footerStyle);
                            }

                            setupPortfolioNavigation();
                        }

                        function updateGridLayoutOnly(layoutClass) {
                            console.log(' updateGridLayoutOnly called with:', layoutClass);

                            //  ONLY TARGET PORTFOLIO GRIDS, NOT DASHBOARD
                            const portfolioGrids = document.querySelectorAll('#portfolioPage .artworks-grid');
                            portfolioGrids.forEach(grid => {
                                grid.className = grid.className.replace(/portfolio-layout\s+\S+/g, '');
                                grid.classList.add('portfolio-layout', layoutClass);
                                console.log(' Portfolio grid updated to:', layoutClass);
                            });

                            //  DON'T TOUCH DASHBOARD GRIDS
                            const dashboardGrids = document.querySelectorAll('#dashboard-section .artworks-grid');
                            dashboardGrids.forEach(grid => {
                                // Keep dashboard at medium size always
                                grid.className = grid.className.replace(/\b(small|medium|large)\b/g, '');
                                grid.classList.add('medium');
                            });
                        }

                        function generateCollectionLayout(collection, titleLayout, collectionArtworks, profileData) {
                        const title = collection.name || 'Untitled Collection';
                        const description = collection.description || '';
                        const layoutClass = profileData.portfolio_layout || "grid-classic";
                        const sizeClass = profileData.image_size || 'medium';

                        const artworksGrid = `
                            <div class="artworks-grid portfolio-layout ${layoutClass} ${sizeClass}">
                                ${collectionArtworks.map(artwork => `
                                    <div class="artwork-card">
                                        <div class="artwork-image">
                                            <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:auto;display:block;">
                                        </div>
                                        <div class="artwork-info">
                                            <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                            <div class="artwork-details">
                                                ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                ${artwork.dimensions ? `<div>${artwork.dimensions}</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;

                        // TRAC CLASSIC - EXACT ORIGINAL LAYOUT (NO CHANGES)
                        if (titleLayout === 'centered') {
                            return `
                                <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <h2 style="font-weight: 500; letter-spacing: -0.02em; text-align: left;">
                                            ${collection.name || 'Untitled Collection'}
                                        </h2>
                                    </div>

                                    ${collection.description ? `
                                        <div style="margin-bottom: 5rem; max-width: 800px;">
                                            <p style="line-height: 1.6; color: #666; text-align: left; word-wrap: break-word;">
                                                ${collection.description}
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                                ${artworksGrid}
                            `;
                        }

                        // OTHER STYLES: Use clean invisible containers
                        switch(titleLayout) {
                            case 'minimal':
                                return `
                                    ${artworksGrid}
                                    <div style="margin: 3rem auto 4rem auto; max-width: 600px; text-align: center; padding: 0 1rem;">
                                        <h2 style="font-weight: 400; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-color, #666); margin: 0; line-height: 1.3; word-wrap: break-word;">
                                            ${title}
                                        </h2>
                                        ${description ? `
                                            <p style="line-height: 1.4; color: var(--text-color, #666); margin: 0.5rem 0 0 0; opacity: 0.8; word-wrap: break-word;">
                                                ${description}
                                            </p>
                                        ` : ''}
                                    </div>
                                `;

                            case 'left-aligned':
                                return `
                                    <div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start; margin: 0 auto 3rem auto; max-width: 1400px; padding: 0 1rem;">
                                        <div style="padding: 0;">
                                            <h2 style="font-weight: 500; letter-spacing: -0.02em; margin: 0 0 1rem 0; color: var(--text-color, #000); line-height: 1.2; word-wrap: break-word;">
                                                ${title}
                                            </h2>
                                            ${description ? `
                                                <p style="line-height: 1.5; color: var(--text-color, #666); margin: 0; opacity: 0.8; word-wrap: break-word;">
                                                    ${description}
                                                </p>
                                            ` : ''}
                                        </div>
                                        <div style="min-width: 0;">
                                            ${artworksGrid}
                                        </div>
                                    </div>
                                `;

                                case 'centered-large':
                                    return `
                                        <!-- TITLE ABOVE IMAGES - CLEAN -->
                                        <div style="margin: 0 auto 3rem auto; max-width: 800px; padding: 0 1rem; text-align: center;">
                                            <h2 style="font-weight: 300; letter-spacing: -0.02em; margin: 0 0 1rem 0; color: var(--text-color, #000); line-height: 1.1; word-wrap: break-word;">
                                                ${title}
                                            </h2>
                                            ${description ? `
                                                <p style="line-height: 1.5; color: var(--text-color, #666); margin: 0; opacity: 0.8; word-wrap: break-word;">
                                                    ${description}
                                                </p>
                                            ` : ''}
                                        </div>
                                        ${artworksGrid}
                                    `;

                                case 'expressive':
                                    return `
                                        <!-- TITLE AS BANNER - KEEP COLORED -->
                                        <div style="margin: 0 auto 3rem auto; max-width: 100%; padding: 0 1rem;">
                                            <div style="background: var(--accent-color, #000); color: white; padding: 2.5rem 1rem; text-align: center; border-radius: 0;">
                                                <h2 style="font-weight: 700; letter-spacing: -0.02em; margin: 0 0 1rem 0; line-height: 1.1; word-wrap: break-word; max-width: 800px; margin-left: auto; margin-right: auto;">
                                                    ${title}
                                                </h2>
                                                ${description ? `
                                                    <p style="line-height: 1.4; opacity: 0.9; margin: 0; word-wrap: break-word; max-width: 600px; margin-left: auto; margin-right: auto;">
                                                        ${description}
                                                    </p>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ${artworksGrid}
                                    `;

                                case 'bold-centered':
                                    return `
                                        <!-- TITLE BELOW IMAGES - CLEAN -->
                                        ${artworksGrid}
                                        ${description ? `
                                            <div style="margin: 2rem auto 1rem auto; max-width: 600px; padding: 0 1rem; text-align: center;">
                                                <p style="line-height: 1.4; color: var(--text-color, #666); font-weight: 500; margin: 0; word-wrap: break-word;">
                                                    ${description}
                                                </p>
                                            </div>
                                        ` : ''}
                                        <div style="margin: 1rem auto 3rem auto; max-width: 600px; padding: 0 1rem; text-align: center;">
                                            <h2 style="font-weight: 700; letter-spacing: 0.05em; margin: 0; line-height: 1.1; word-wrap: break-word; color: var(--accent-color, #000);">
                                                ${title}
                                            </h2>
                                        </div>
                                    `;

                                case 'archival':
                                    return `
                                        <!-- TITLE ON RIGHT SIDE - CLEAN -->
                                        <div style="display: grid; grid-template-columns: 1fr 280px; gap: 2rem; align-items: start; margin: 0 auto 3rem auto; max-width: 1400px; padding: 0 1rem;">
                                            <div style="min-width: 0;">
                                                ${artworksGrid}
                                            </div>
                                            <div style="padding: 0; border-left: 2px solid var(--accent-color, #8b0000); padding-left: 1.5rem;">
                                                <h2 style="font-weight: 600; font-family: 'Times New Roman', serif; margin: 0 0 1rem 0; color: var(--text-color, #000); line-height: 1.2; word-wrap: break-word;">
                                                    ${title}
                                                </h2>
                                                ${description ? `
                                                    <p style="line-height: 1.5; color: var(--text-color, #666); font-style: italic; margin: 0; opacity: 0.8; word-wrap: break-word;">
                                                        ${description}
                                                    </p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;

                                case 'rotated':
                                    return `
                                        <!-- TITLE FLOATING ON SIDE - CLEAN -->
                                        <div style="position: relative; margin: 0 0 2rem 80px;">
                                            <div style="position: absolute; left: -100px; top: 50px; transform: rotate(-90deg); transform-origin: left top; z-index: 2;">
                                                <h2 style="font-weight: 500; letter-spacing: 0.1em; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color, #000);">
                                                    ${title}
                                                </h2>
                                            </div>
                                            <div style="margin-left: 0;">
                                                ${artworksGrid}
                                            </div>
                                        </div>
                                        ${description ? `
                                            <div style="margin: 0 auto 2rem auto; max-width: 600px; padding: 0 1rem 0 100px;">
                                                <p style="line-height: 1.4; color: var(--text-color, #666); margin: 0; word-wrap: break-word;">
                                                    ${description}
                                                </p>
                                            </div>
                                        ` : ''}
                                    `;

                                default:
                                    return `
                                        <!-- FALLBACK - CLEAN -->
                                        <div style="margin: 0 auto 2rem auto; max-width: 800px; padding: 0 1rem; text-align: center;">
                                            <h2 style="font-weight: 500; letter-spacing: -0.02em; margin: 0 0 1rem 0; color: var(--text-color, #000); line-height: 1.2; word-wrap: break-word;">
                                                ${title}
                                            </h2>
                                            ${description ? `
                                                <p style="line-height: 1.5; color: var(--text-color, #666); margin: 0; opacity: 0.8; word-wrap: break-word;">
                                                    ${description}
                                                </p>
                                            ` : ''}
                                        </div>
                                        ${artworksGrid}
                                    `;
                            }
                        }

                        // ==================== COLLECTIONS DISPLAY ====================
                        function displayCollectionsInPortfolio(collections, profileData) { // ADD profileData parameter
                            if (!collections || collections.length === 0) {
                                return ''; 
                            }

                            let collectionsHTML = '';
                            const layoutClass = profileData.portfolio_layout || "grid-classic";
                            const sizeClass = profileData.image_size || 'medium';

                            collections.forEach(collection => {
                                const collectionArtworks = collection.artwork_collections?.map(ac => ac.artworks).filter(Boolean) || [];

                                if (collectionArtworks.length > 0) {
                                    collectionsHTML += `
                                        <div class="collection-section" style="margin-top: 4rem; margin-bottom: 4rem;">
                                            ${generateCollectionLayout(collection, profileData.collection_title_layout || stylePreset.collectionTitleLayout, collectionArtworks, profileData)}
                                        </div>
                                    `;
                                }
                            });

                            return collectionsHTML;
                        }
                            function displayCollectionsInPortfolio(collections, profileData, collectionLayout = 'grid', stylePreset) {
                            if (!collections || collections.length === 0) {
                                return ''; 
                            }

                            let collectionsHTML = '';
                            const layoutClass = profileData.portfolio_layout || "grid-classic";
                            const sizeClass = profileData.image_size || 'medium';

                            collections.forEach(collection => {
                                const collectionArtworks = collection.artwork_collections?.map(ac => ac.artworks).filter(Boolean) || [];

                                if (collectionArtworks.length > 0) {
                                    let collectionGridHTML = '';

                                    switch(collectionLayout) {
                                        case 'carousel':
                                            collectionGridHTML = `
                                                <div class="collection-carousel" style="display: flex; overflow-x: auto; gap: 2rem; padding: 2rem 0; scroll-snap-type: x mandatory;">
                                                    ${collectionArtworks.map(artwork => `
                                                        <div class="artwork-card" style="flex: 0 0 auto; width: 300px; scroll-snap-align: start;">
                                                            <div class="artwork-image">
                                                                <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:200px;object-fit:cover;display:block;">
                                                            </div>
                                                            <div class="artwork-info">
                                                                <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                                <div class="artwork-details">
                                                                    ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                                    ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `;
                                            break;

                                        case 'masonry':
                                            collectionGridHTML = `
                                                <div class="artworks-grid portfolio-layout monumental-asymmetric ${sizeClass}">
                                                    ${collectionArtworks.map(artwork => `
                                                        <div class="artwork-card">
                                                            <div class="artwork-image">
                                                                <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:auto;display:block;">
                                                            </div>
                                                            <div class="artwork-info">
                                                                <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                                <div class="artwork-details">
                                                                    ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                                    ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `;
                                            break;

                                        case 'stacked':
                                            collectionGridHTML = `
                                                <div class="artworks-grid portfolio-layout guerrilla-grid ${sizeClass}">
                                                    ${collectionArtworks.map(artwork => `
                                                        <div class="artwork-card">
                                                            <div class="artwork-image">
                                                                <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:auto;display:block;">
                                                            </div>
                                                            <div class="artwork-info">
                                                                <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                                <div class="artwork-details">
                                                                    ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                                    ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `;
                                            break;

                                        case 'featured-first':
                                            const featuredArtwork = collectionArtworks[0];
                                            const otherArtworks = collectionArtworks.slice(1);
                                            collectionGridHTML = `
                                                <div class="featured-artwork" style="margin-bottom: 3rem;">
                                                    <div class="artwork-card" style="max-width: 800px; margin: 0 auto;">
                                                        <div class="artwork-image">
                                                            <img src="${featuredArtwork.image_url}" alt="${featuredArtwork.title}" style="width:100%;height:auto;display:block;">
                                                        </div>
                                                        <div class="artwork-info">
                                                            <h3 class="artwork-title" style="font-size: 1.5rem;">${featuredArtwork.title || 'Untitled'}</h3>
                                                            <div class="artwork-details">
                                                                ${featuredArtwork.year ? `<div>${featuredArtwork.year}</div>` : ''}
                                                                ${featuredArtwork.medium ? `<div>${featuredArtwork.medium}</div>` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                ${otherArtworks.length > 0 ? `
                                                    <div class="artworks-grid portfolio-layout grid-classic ${sizeClass}">
                                                        ${otherArtworks.map(artwork => `
                                                            <div class="artwork-card">
                                                                <div class="artwork-image">
                                                                    <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:auto;display:block;">
                                                                </div>
                                                                <div class="artwork-info">
                                                                    <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                                    <div class="artwork-details">
                                                                        ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                                        ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            `;
                                            break;

                                        case 'grid':
                                        default:
                                            collectionGridHTML = `
                                                <div class="artworks-grid portfolio-layout ${layoutClass} ${sizeClass}" id="mainArtworksGrid">
                                                    ${collectionArtworks.map(artwork => `
                                                        <div class="artwork-card">
                                                            <div class="artwork-image">
                                                                <img src="${artwork.image_url}" alt="${artwork.title}" style="width:100%;height:auto;display:block;">
                                                            </div>
                                                            <div class="artwork-info">
                                                                <h3 class="artwork-title">${artwork.title || 'Untitled'}</h3>
                                                                <div class="artwork-details">
                                                                    ${artwork.year ? `<div>${artwork.year}</div>` : ''}
                                                                    ${artwork.medium ? `<div>${artwork.medium}</div>` : ''}
                                                                    ${artwork.dimensions ? `<div>${artwork.dimensions}</div>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            `;
                                    }

                                    collectionsHTML += `
                                        <div class="collection-section" style="margin-top: 4rem; margin-bottom: 4rem;">
                                            ${generateCollectionLayout(collection, profileData.collection_title_layout || stylePreset.collectionTitleLayout, collectionArtworks, profileData)}
                                        </div>
                                    `;
                                }
                            });

                            return collectionsHTML;
                        }
                        
                        // ==================== FOOTER MANAGEMENT ====================
                        function updateFooterContactDisplay(profile) {
                            const footerContactDisplay = document.getElementById('footerContactDisplay');
                            if (!footerContactDisplay) return;

                            const showFooterContact = profile?.show_footer_contact || false;
                            const contactEmail = profile?.contact_email || '';
                            const website = profile?.website || '';

                            if (showFooterContact && (contactEmail || website)) {
                                let contactHTML = '';
                                if (contactEmail) {
                                    contactHTML += `<div style="margin-bottom: 0.25rem;"><a href="mailto:${contactEmail}" style="color: var(--footer-text-color, #666); text-decoration: none;">${contactEmail}</a></div>`;
                                }
                                if (website) {
                                    const cleanWebsite = website.replace(/^https?:\/\//, '');
                                    contactHTML += `<div><a href="${website}" target="_blank" style="color: var(--footer-text-color, #666); text-decoration: none;">${cleanWebsite}</a></div>`;
                                }

                                footerContactDisplay.innerHTML = contactHTML;
                                footerContactDisplay.style.display = 'block';
                            } else {
                                footerContactDisplay.style.display = 'none';
                            }
                        }

                        function setupPortfolioNavigation() {
                            const navItems = document.querySelectorAll('.portfolio-nav .nav-item');
                            navItems.forEach(item => {
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    navItems.forEach(nav => nav.classList.remove('active'));
                                    this.classList.add('active');

                                    const tabName = this.getAttribute('data-tab');
                                    document.querySelectorAll('.portfolio-tab').forEach(tab => {
                                        tab.style.display = tab.id === `${tabName}-section` ? 'block' : 'none';
                                    });
                                });
                            });
                        }

                        function clearPortfolioCache() {
                            cachedPortfolioData = null;
                            cachedArtworksData = null;
                            cachedCollectionsData = null;
                            cachedEventsData = null;
                            console.log(" Portfolio cache cleared");
                        }     

                        function applyHeaderLayout(headerLayout, profileData, isOwner) {
                            const artistName = profileData.full_name || profileData.username;

                            switch(headerLayout) {
                                case 'floating':
                                    return `
                                        <header class="portfolio-header" style="position: fixed; top: 2rem; left: 50%; transform: translateX(-50%); background: var(--bg-color, rgba(255,255,255,0.9)); backdrop-filter: blur(10px); border: 1px solid var(--border-color, #e5e5e5); border-radius: 12px; padding: 1rem 2rem; z-index: 1000; width: auto;">
                                            <div class="header-container" style="max-width: none;">
                                                <div class="header-left">
                                                    <div class="artist-name">${artistName}</div>
                                                    ${isOwner ? `
                                                        <nav class="gallery-nav">
                                                            <a href="#" class="nav-item" onclick="showSection('dashboard')">Dashboard</a>
                                                        </nav>
                                                    ` : ''}
                                                </div>
                                                <div class="header-right">
                                                    <nav class="portfolio-nav">
                                                        <a href="#" class="nav-item active" data-tab="works">Works</a>
                                                        <a href="#" class="nav-item" data-tab="profile">Profile</a>
                                                        <a href="#" class="nav-item" data-tab="events">Events</a>
                                                    </nav>
                                                    ${isOwner ? applyOwnerHeaderElements(profileData) : ''}
                                                </div>
                                            </div>
                                        </header>
                                        <div style="height: 120px;"></div> <!-- Spacer for fixed header -->
                                    `;

                                case 'split':
                                    return `
                                        <header class="portfolio-header">
                                            <div class="header-container" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
                                                <div class="header-left" style="justify-self: start;">
                                                    <div class="artist-name" style="font-size: 1.8rem; font-weight: 600;">${artistName}</div>
                                                </div>
                                                <div style="justify-self: center;">
                                                    <nav class="portfolio-nav">
                                                        <a href="#" class="nav-item active" data-tab="works">Works</a>
                                                        <a href="#" class="nav-item" data-tab="profile">Profile</a>
                                                        <a href="#" class="nav-item" data-tab="events">Events</a>
                                                    </nav>
                                                </div>
                                                <div class="header-right" style="justify-self: end;">
                                                    ${isOwner ? applyOwnerHeaderElements(profileData) : ''}
                                                </div>
                                            </div>
                                        </header>
                                    `;

                                case 'minimal':
                                    return `
                                        <header class="portfolio-header" style="border: none; padding: 2rem 0 1rem;">
                                            <div class="header-container" style="text-align: center;">
                                                <div class="artist-name" style="font-size: 2.5rem; font-weight: 300; letter-spacing: -0.02em; margin-bottom: 1rem;">${artistName}</div>
                                                ${isOwner ? `
                                                    <div style="margin-top: 1rem;">
                                                        <a href="#" class="nav-item" onclick="showSection('dashboard')" style="font-size: 0.9rem; color: #666; text-decoration: underline;">Dashboard</a>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </header>
                                    `;

                                case 'expressive':
                                    return `
                                        <header class="portfolio-header" style="background: var(--accent-color, #000); color: white; padding: 4rem 0;">
                                            <div class="header-container" style="text-align: center;">
                                                <div class="artist-name" style="font-size: 4rem; font-weight: 700; letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 1rem;">${artistName}</div>
                                                <nav class="portfolio-nav" style="margin-top: 2rem;">
                                                    <a href="#" class="nav-item active" data-tab="works" style="color: white; font-size: 1.1rem;">Works</a>
                                                    <a href="#" class="nav-item" data-tab="profile" style="color: white; font-size: 1.1rem;">Profile</a>
                                                    <a href="#" class="nav-item" data-tab="events" style="color: white; font-size: 1.1rem;">Events</a>
                                                </nav>
                                                ${isOwner ? applyOwnerHeaderElements(profileData, true) : ''}
                                            </div>
                                        </header>
                                    `;

                                case 'left-aligned':
                                default:
                                    return `
                                        <header class="portfolio-header">
                                            <div class="header-container">
                                                <div class="header-left">
                                                    <div class="artist-name">${artistName}</div>
                                                    ${isOwner ? `
                                                        <nav class="gallery-nav">
                                                            <a href="#" class="nav-item" onclick="showSection('dashboard')">Dashboard</a>
                                                        </nav>
                                                    ` : ''}
                                                </div>
                                                <div class="header-right">
                                                    <nav class="portfolio-nav">
                                                        <a href="#" class="nav-item active" data-tab="works">Works</a>
                                                        <a href="#" class="nav-item" data-tab="profile">Profile</a>
                                                        <a href="#" class="nav-item" data-tab="events">Events</a>
                                                    </nav>
                                                    ${isOwner ? applyOwnerHeaderElements(profileData) : ''}
                                                </div>
                                            </div>
                                        </header>
                                    `;
                            }
                        }

                        function applyFooterStyle(footerStyle, profileData) {
                            const showFooterContact = profileData?.show_footer_contact || false;
                            const contactEmail = profileData?.contact_email || '';
                            const website = profileData?.website || '';

                            let contactHTML = '';
                            if (showFooterContact && (contactEmail || website)) {
                                if (contactEmail) {
                                    contactHTML += `<div style="margin-bottom: 0.25rem;"><a href="mailto:${contactEmail}" style="color: var(--footer-text-color, #666); text-decoration: none;">${contactEmail}</a></div>`;
                                }
                                if (website) {
                                    const cleanWebsite = website.replace(/^https?:\/\//, '');
                                    contactHTML += `<div><a href="${website}" target="_blank" style="color: var(--footer-text-color, #666); text-decoration: none;">${cleanWebsite}</a></div>`;
                                }
                            }

                            //  AUTO-SWITCH TO CONTACT-PROMINENT WHEN CONTACT INFO EXISTS
                            if (showFooterContact && contactHTML) {
                                footerStyle = 'contact-prominent';
                            }

                            switch(footerStyle) {
                                case 'hidden':
                                    return '';

                                case 'expanded':
                                    return `
                                        <footer style="padding: 3rem 0; border-top: 1px solid var(--border-color, #e5e5e5); background: var(--bg-color, white); margin-top: 4rem;">
                                            <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-bottom: 2rem;">
                                                    <div>
                                                        <h4 style="margin-bottom: 1rem; font-weight: 600;">Contact</h4>
                                                        ${contactHTML || '<p style="color: #666;">Contact information available upon request</p>'}
                                                    </div>
                                                    <div>
                                                        <h4 style="margin-bottom: 1rem; font-weight: 600;">About</h4>
                                                        <p style="color: #666; line-height: 1.5;">${profileData.bio ? profileData.bio.substring(0, 150) + '...' : 'Artist portfolio'}</p>
                                                    </div>
                                                </div>
                                                <div style="text-align: center; color: var(--footer-text-color, #666); font-size: var(--footer-font-size, 14px); font-family: var(--footer-font-family, 'Space Grotesk'); border-top: 1px solid var(--border-color, #e5e5e5); padding-top: 2rem;">
                                                    Powered by TRAC
                                                </div>
                                            </div>
                                        </footer>
                                    `;

                                case 'social-focused':
                                    const socialIcons = profileData.social_links ? displaySocialIcons(profileData.social_links) : '';
                                    return `
                                        <footer style="padding: 3rem 0; border-top: 1px solid var(--border-color, #e5e5e5); background: var(--bg-color, white); text-align: center;">
                                            <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
                                                ${socialIcons}
                                                <div style="margin-top: 2rem; color: var(--footer-text-color, #666); font-size: var(--footer-font-size, 14px); font-family: var(--footer-font-family, 'Space Grotesk');">
                                                    Powered by TRAC
                                                </div>
                                            </div>
                                        </footer>
                                    `;

                                case 'contact-prominent':
                                    return `
                                        <footer style="padding: 2rem 0; border-top: 1px solid var(--border-color, #e5e5e5); background: var(--bg-color, white);">
                                            <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
                                                <div id="footerContactDisplay" style="text-align: center; font-size: var(--footer-font-size, 14px); font-family: var(--footer-font-family, 'Space Grotesk'); margin-bottom: 1rem; ${contactHTML ? '' : 'display: none;'}">
                                                    ${contactHTML}
                                                </div>
                                                <div style="text-align: center; color: var(--footer-text-color, #666); font-size: var(--footer-font-size, 14px); font-family: var(--footer-font-family, 'Space Grotesk');">
                                                    Powered by TRAC
                                                </div>
                                            </div>
                                        </footer>
                                    `;

                                case 'minimal':
                                default:
                                    return `
                                        <footer style="padding: 2rem 0; border-top: 1px solid var(--border-color, #e5e5e5); background: var(--bg-color, white);">
                                            <div style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
                                                <div style="text-align: center; color: var(--footer-text-color, #666); font-size: var(--footer-font-size, 14px); font-family: var(--footer-font-family, 'Space Grotesk');">
                                                    Powered by TRAC
                                                </div>
                                            </div>
                                        </footer>
                                    `;
                            }
                        }

                        function applyOwnerHeaderElements(profileData, isDark = false, isOwner = true) {
                            //  REMOVE THE isOwner CHECK - MAKE CV AVAILABLE TO PUBLIC
                            const textColor = isDark ? 'white' : 'inherit';
                            return `
                                ${profileData.has_cv ? `
                                    <span style="color: ${textColor}; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; margin-right: 1rem; padding: 0.25rem 0.5rem; border: 1px solid ${textColor}; border-radius: 4px; opacity: 0.8;" 
                                          onclick="showCVRequestForm()"
                                          title="CV available upon request">
                                        CV
                                    </span>
                                ` : ''}

                                ${isOwner ? `
                                    <button class="icon-button" onclick="toggleStyleEditor()" title="Customize Portfolio" style="margin-right: 0.5rem; color: ${textColor};">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M8 2l2 4 4 1-2 4 2 4-4-1-2 4-2-4-4 1 2-4-2-4 4 1z"></path>
                                        </svg>
                                    </button>

                                    <button class="icon-button" onclick="signOut()" title="Sign Out" style="color: ${textColor};">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M6 14H3.333C2.98 14 2.641 13.86 2.391 13.61C2.14 13.36 2 13.02 2 12.667V3.333C2 2.98 2.14 2.641 2.391 2.391C2.641 2.14 2.98 2 3.333 2H6"></path>
                                            <path d="M10.667 11.333L14 8l-3.333-3.333"></path>
                                            <path d="M14 8H6"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                            `;
                        }

                        function applyCollectionLayout(collectionLayout) {
                            // Apply different collection display methods
                        }

                        // ==================== BRANDED ALERT SYSTEM ====================
                        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
                            return new Promise((resolve) => {
                                const dialog = document.createElement('div');
                                dialog.style.cssText = `
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0,0,0,0.5);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    z-index: 10000;
                                `;

                                dialog.innerHTML = `
                                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%;">
                                        <h3 style="margin: 0 0 1rem 0; font-weight: 500; letter-spacing: -0.02em;">${title}</h3>
                                        <p style="margin: 0 0 2rem 0; color: #666; line-height: 1.4;">${message}</p>
                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button id="cancelAction" 
                                                    style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">
                                                ${cancelText}
                                            </button>
                                            <button id="confirmAction" 
                                                    style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: opacity 0.2s;">
                                                ${confirmText}
                                            </button>
                                        </div>
                                    </div>
                                `;

                                document.body.appendChild(dialog);

                                // Add hover effects
                                const cancelBtn = dialog.querySelector('#cancelAction');
                                const confirmBtn = dialog.querySelector('#confirmAction');

                                cancelBtn.onmouseover = () => cancelBtn.style.background = '#f5f5f5';
                                cancelBtn.onmouseout = () => cancelBtn.style.background = 'none';
                                confirmBtn.onmouseover = () => confirmBtn.style.opacity = '0.9';
                                confirmBtn.onmouseout = () => confirmBtn.style.opacity = '1';

                                cancelBtn.onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(false);
                                };

                                confirmBtn.onclick = () => {
                                    document.body.removeChild(dialog);
                                    resolve(true);
                                };
                            });
                        }

                        // ==================== WIP STUDIO & BLOCKCHAIN FUNCTIONS ====================
                        function openWipStudio() {
                            document.getElementById('wipStudioModal').style.display = 'flex';

                            document.getElementById('wipStudioModal').innerHTML = `
                                <!-- TRAC CENTERED MODAL -->
                                <div style="background: white; border-radius: 12px; max-width: 1000px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; margin: auto;">
                                    <!-- HEADER -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="background: #000000; border-radius: 8px; padding: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.5">
                                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                    <path d="M2 17l10 5 10-5"></path>
                                                    <path d="M2 12l10 5 10-5"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500; letter-spacing: -0.02em;">Studio Workspace</h3>
                                                <p style="margin: 0; font-size: 0.8rem; color: #666; font-weight: 400;">Your creative projects</p>
                                            </div>
                                        </div>
                                        <button class="close-wip-studio" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;"></button>
                                    </div>

                                    <!-- CENTERED CONTENT -->
                                    <div style="flex: 1; display: flex; overflow: hidden;">
                                        <!-- PROJECTS SIDEBAR -->
                                        <div style="width: 300px; border-right: 1px solid #e5e5e5; background: #f8f8f8; display: flex; flex-direction: column;">
                                            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                                                <button class="create-new-project-btn" 
                                                        style="width: 100%; background: #000; color: white; border: none; padding: 0.875rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: opacity 0.2s;">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                                    </svg>
                                                    New Project
                                                </button>
                                            </div>
                                            <div id="wipProjectsList" style="flex: 1; overflow-y: auto; padding: 1rem;">
                                                <div style="text-align: center; padding: 2rem; color: #666;">
                                                    <div style="margin-bottom: 1rem;">
                                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                            <path d="M2 17l10 5 10-5"></path>
                                                            <path d="M2 12l10 5 10-5"></path>
                                                        </svg>
                                                    </div>
                                                    <p style="margin: 0; font-size: 0.9rem; font-weight: 400;">No projects yet</p>
                                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #999;">Create your first project to start</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- MAIN WORKSPACE -->
                                        <div style="flex: 1; display: flex; flex-direction: column; background: white; position: relative;">
                                            <!-- PROJECT WORKSPACE -->
                                            <div id="projectWorkspace" style="display: none; flex: 1; flex-direction: column;">
                                                <!-- Project Header -->
                                                <div id="projectHeader" style="padding: 2rem; border-bottom: 1px solid #e5e5e5;">
                                                    <h2 id="currentProjectTitle" style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; letter-spacing: -0.02em;">Project Name</h2>
                                                    <p id="currentProjectDescription" style="margin: 0; color: #666; font-size: 0.9rem;">Project description</p>
                                                </div>

                                                <!-- Tools Grid -->
                                                <div style="padding: 2rem;">
                                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; max-width: 600px; margin: 0 auto;">
                                                        <div class="wip-tool moodboard-tool" 
                                                             style="text-align: center; padding: 2rem; border: 1px solid #e5e5e5; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                                </svg>
                                                            </div>
                                                            <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1rem;">Add Reference</div>
                                                            <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">Images, links & visual inspiration</div>
                                                        </div>

                                                        <div class="wip-tool sketch-tool" 
                                                             style="text-align: center; padding: 2rem; border: 1px solid #e5e5e5; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                                                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                                                                    <path d="M2 2l7.586 7.586"></path>
                                                                    <circle cx="11" cy="11" r="2"></circle>
                                                                </svg>
                                                            </div>
                                                            <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1rem;">Add Sketch</div>
                                                            <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">Drawings, drafts & process work</div>
                                                        </div>

                                                        <div class="wip-tool note-tool" 
                                                             style="text-align: center; padding: 2rem; border: 1px solid #e5e5e5; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white;">
                                                            <div style="margin-bottom: 1rem;">
                                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                                    <polyline points="14 2 14 8 20 8"></polyline>
                                                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                                                    <polyline points="10 9 9 9 8 9"></polyline>
                                                                </svg>
                                                            </div>
                                                            <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1rem;">Add Note</div>
                                                            <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">Ideas, research & concepts</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Content Area -->
                                                <div id="wipContentGrid" style="flex: 1; padding: 0 2rem 2rem 2rem; overflow-y: auto;">
                                                    <div style="max-width: 1000px; margin: 0 auto;">
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; align-content: start;">
                                                            <!-- Content loads here -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- EMPTY STATE -->
                                            <div id="emptyWorkspace" style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 4rem;">
                                                <div style="max-width: 400px;">
                                                    <div style="margin-bottom: 1.5rem;">
                                                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                                            <path d="M2 17l10 5 10-5"></path>
                                                            <path d="M2 12l10 5 10-5"></path>
                                                        </svg>
                                                    </div>
                                                    <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 500; letter-spacing: -0.02em;">Start a Project</h3>
                                                    <p style="margin: 0 0 2rem 0; font-size: 0.9rem; color: #666; line-height: 1.5;">Select a project from the sidebar or create a new one to begin your creative work</p>
                                                    <button class="create-first-project-btn" 
                                                            style="background: #000; color: white; border: none; padding: 0.875rem 1.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: opacity 0.2s;">
                                                        Create Your First Project
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // ADD EVENT LISTENERS AFTER HTML IS INJECTED
                            setTimeout(() => {
                                // Close button
                                const closeBtn = document.querySelector('.close-wip-studio');
                                if (closeBtn) {
                                    closeBtn.addEventListener('click', closeWipStudio);
                                    closeBtn.addEventListener('mouseover', function() {
                                        this.style.background = '#f5f5f5';
                                        this.style.color = '#000';
                                    });
                                    closeBtn.addEventListener('mouseout', function() {
                                        this.style.background = 'none';
                                        this.style.color = '#666';
                                    });
                                }

                                // Create project buttons
                                const createBtns = document.querySelectorAll('.create-new-project-btn, .create-first-project-btn');
                                createBtns.forEach(btn => {
                                    btn.addEventListener('click', createNewProject);
                                    btn.addEventListener('mouseover', function() {
                                        this.style.opacity = '0.9';
                                    });
                                    btn.addEventListener('mouseout', function() {
                                        this.style.opacity = '1';
                                    });
                                });

                                // Tool buttons
                                const moodboardTool = document.querySelector('.moodboard-tool');
                                if (moodboardTool) {
                                    moodboardTool.addEventListener('click', addMoodboardItem);
                                }

                                const sketchTool = document.querySelector('.sketch-tool');
                                if (sketchTool) {
                                    sketchTool.addEventListener('click', uploadSketch);
                                }

                                const noteTool = document.querySelector('.note-tool');
                                if (noteTool) {
                                    noteTool.addEventListener('click', createNote);
                                }

                                // Hover effects for tools
                                document.querySelectorAll('.wip-tool').forEach(tool => {
                                    tool.addEventListener('mouseenter', () => {
                                        tool.style.borderColor = '#000';
                                        tool.style.transform = 'translateY(-2px)';
                                        tool.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                                    });
                                    tool.addEventListener('mouseleave', () => {
                                        tool.style.borderColor = '#e5e5e5';
                                        tool.style.transform = 'translateY(0)';
                                        tool.style.boxShadow = 'none';
                                    });
                                });

                            }, 100);

                            loadWipProjects();
                        }

                        // ==================== WIP STUDIO FUNCTIONS ====================
                        function createNewProject() {
                            // Create dialog with highest z-index
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10004; // HIGHER than WIP Studio (10001) and other modals
                            `;

                            dialog.innerHTML = `
                                <div style="background: white; border-radius: 12px; max-width: 480px; width: 90%; max-height: 90vh; overflow: hidden;">
                                    <!-- HEADER -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500; letter-spacing: -0.02em;">Create New Project</h3>
                                        <button class="close-project-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;"></button>
                                    </div>

                                    <!-- FORM -->
                                    <div style="padding: 2rem;">
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: #333;">Project Name</label>
                                            <input type="text" id="quickProjectName" 
                                                   style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; transition: border-color 0.2s;"
                                                   placeholder="Enter project name">
                                        </div>

                                        <div style="margin-bottom: 2rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: #333;">Description (Optional)</label>
                                            <textarea id="quickProjectDescription" 
                                                      style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 80px; resize: vertical; transition: border-color 0.2s;"
                                                      placeholder="Brief description of your project"></textarea>
                                        </div>

                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button class="cancel-project-btn" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;">Cancel</button>
                                            <button class="create-project-submit" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: opacity 0.2s;">Create Project</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(dialog);

                            // ADD EVENT LISTENERS TO MODAL
                            setTimeout(() => {
                                // Close buttons
                                const closeBtn = dialog.querySelector('.close-project-modal');
                                if (closeBtn) {
                                    closeBtn.addEventListener('click', () => dialog.remove());
                                    closeBtn.addEventListener('mouseover', function() {
                                        this.style.background = '#f5f5f5';
                                        this.style.color = '#000';
                                    });
                                    closeBtn.addEventListener('mouseout', function() {
                                        this.style.background = 'none';
                                        this.style.color = '#666';
                                    });
                                }

                                // Cancel button
                                const cancelBtn = dialog.querySelector('.cancel-project-btn');
                                if (cancelBtn) {
                                    cancelBtn.addEventListener('click', () => dialog.remove());
                                    cancelBtn.addEventListener('mouseover', function() {
                                        this.style.background = '#f5f5f5';
                                    });
                                    cancelBtn.addEventListener('mouseout', function() {
                                        this.style.background = 'none';
                                    });
                                }

                                // Create button
                                const createBtn = dialog.querySelector('.create-project-submit');
                                if (createBtn) {
                                    createBtn.addEventListener('click', createProjectFromModal);
                                    createBtn.addEventListener('mouseover', function() {
                                        this.style.opacity = '0.9';
                                    });
                                    createBtn.addEventListener('mouseout', function() {
                                        this.style.opacity = '1';
                                    });
                                }

                                // Input focus states
                                const inputs = dialog.querySelectorAll('input, textarea');
                                inputs.forEach(input => {
                                    input.addEventListener('focus', function() {
                                        this.style.borderColor = '#000';
                                        this.style.outline = 'none';
                                    });
                                    input.addEventListener('blur', function() {
                                        this.style.borderColor = '#d1d1d1';
                                    });
                                });

                                // Focus first input
                                const firstInput = dialog.querySelector('input');
                                if (firstInput) firstInput.focus();

                            }, 100);
                        }

                                async function createWipProjectSimple(name) {
                                    try {
                                        const { data: { user } } = await supabaseClient.auth.getUser();
                                        if (!user) return;

                                        const { data: project, error } = await supabaseClient
                                            .from('wip_projects')
                                            .insert([{
                                                title: name,
                                                artist_id: user.id,
                                                status: 'active'
                                            }])
                                            .select()
                                            .single();

                                        if (error) throw error;

                                        showToast(`"${name}" created!`);
                                        loadWipProjects();
                                        openProjectWorkspace(project.id);

                                    } catch (error) {
                                        showToast('Error creating project', 'error');
                                    }
                                }

                        function uploadSketch() {
                            showSketchModal();
                        }

                        function createNote() {
                            showNoteModal();
                        }

                        function loadAvailableArtworksForConnection() {
                            // This will load user's existing artworks for connection
                            const artworksList = document.getElementById('availableArtworksList');
                            // For now, show empty state
                            artworksList.innerHTML = `
                                <div style="text-align: center; color: #666; padding: 1rem;">
                                    <p style="margin: 0; font-size: 0.85rem;">No artworks available to connect</p>
                                </div>
                            `;
                        }

                        // ==================== WIP PROJECT CREATION & MANAGEMENT ====================
                        async function createWipProject() {
                            const submitBtn = document.querySelector('#wipProjectForm button[type="submit"]');
                            const originalText = submitBtn.textContent;

                            try {
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<span class="loading-spinner"></span> Creating...';

                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                const formData = {
                                    title: document.getElementById('projectTitle').value,
                                    type: document.getElementById('projectType').value,
                                    description: document.getElementById('projectDescription').value,
                                    tags: document.getElementById('projectTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                                    artist_id: user.id,
                                    status: 'active',
                                    created_at: new Date().toISOString()
                                };

                                if (!formData.title) {
                                    showToast('Project title is required', 'error');
                                    return;
                                }

                                // Create project in database
                                const { data: project, error } = await supabaseClient
                                    .from('wip_projects')
                                    .insert([formData])
                                    .select()
                                    .single();

                                if (error) throw error;

                                showToast(`Project "${formData.title}" created!`);
                                closeWipProjectCreate();

                                // Reload projects list and open the new project
                                setTimeout(() => {
                                    openWipStudio();
                                    loadWipProjects();
                                    openProjectWorkspace(project.id);
                                }, 500);

                            } catch (error) {
                                console.error('Project creation error:', error);
                                showToast('Error creating project: ' + error.message, 'error');
                            } finally {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        }

                        async function deleteWipProject(projectId, projectName, event) {
                            if (event) event.stopPropagation();

                            //  CREATE CUSTOM CONFIRMATION DIALOG THAT APPEARS ON TOP
                            const confirmDialog = document.createElement('div');
                            confirmDialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.7);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10010; // HIGHER THAN WIP STUDIO
                            `;

                            confirmDialog.innerHTML = `
                                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2" style="margin-bottom: 1rem;">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                        </svg>
                                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 500; color: #ff4444;">Delete Project</h3>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Are you sure you want to delete "<strong>${projectName}</strong>"? This action cannot be undone.</p>
                                    </div>
                                    <div style="display: flex; gap: 1rem; justify-content: center;">
                                        <button id="cancelDelete" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">Cancel</button>
                                        <button id="confirmDelete" style="background: #ff4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s;">Delete Project</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(confirmDialog);

                            // Wait for user choice
                            return new Promise((resolve) => {
                                confirmDialog.querySelector('#cancelDelete').onclick = () => {
                                    document.body.removeChild(confirmDialog);
                                    resolve(false);
                                };

                                confirmDialog.querySelector('#confirmDelete').onclick = async () => {
                                    document.body.removeChild(confirmDialog);

                                    try {
                                        const { data: { user } } = await supabaseClient.auth.getUser();
                                        if (!user) return;

                                        const { error } = await supabaseClient
                                            .from('wip_projects')
                                            .delete()
                                            .eq('id', projectId)
                                            .eq('artist_id', user.id);

                                        if (error) throw error;

                                        showToast(`"${projectName}" deleted successfully`);

                                        // Reload projects list
                                        loadWipProjects();

                                        // If deleted project was currently open, show empty state
                                        if (window.currentWipProjectId === projectId) {
                                            document.getElementById('projectWorkspace').style.display = 'none';
                                            document.getElementById('emptyWorkspace').style.display = 'flex';
                                            window.currentWipProjectId = null;
                                        }

                                    } catch (error) {
                                        console.error('Error deleting project:', error);
                                        showToast('Error deleting project', 'error');
                                    }

                                    resolve(true);
                                };

                                // Close on background click
                                confirmDialog.onclick = (e) => {
                                    if (e.target === confirmDialog) {
                                        document.body.removeChild(confirmDialog);
                                        resolve(false);
                                    }
                                };
                            });
                        }

                                async function openProjectWorkspace(projectId) {
                                    try {
                                        const { data: { user } } = await supabaseClient.auth.getUser();
                                        if (!user) return;

                                        const { data: project, error } = await supabaseClient
                                            .from('wip_projects')
                                            .select('*')
                                            .eq('id', projectId)
                                            .eq('artist_id', user.id)
                                            .single();

                                        if (error) throw error;

                                        // Hide empty state, show workspace
                                        document.getElementById('emptyWorkspace').style.display = 'none';
                                        document.getElementById('projectWorkspace').style.display = 'flex';

                                        // Update project info
                                        document.getElementById('currentProjectTitle').textContent = project.title;
                                        document.getElementById('currentProjectDescription').textContent = project.description || 'No description';

                                        // Load project content
                                        loadProjectContent(projectId);

                                    } catch (error) {
                                        showToast('Error opening project', 'error');
                                    }
                                }

                                                                                                async function loadProjectContent(projectId) {
                                                                                                    await loadMoodboardItems(projectId);
                                                                                                    // Will add sketches and notes loading later
                                                                                                }

                                                                                                // CLOSE PROJECT (BACK TO EMPTY STATE)
                                                                                                function closeProject() {
                                                                                                    document.getElementById('projectWorkspace').style.display = 'none';
                                                                                                    document.getElementById('emptyWorkspace').style.display = 'flex';
                                                                                                    document.getElementById('wipContentGrid').innerHTML = '';
                                                                                                }

                        async function loadMoodboardItems(projectId) {
                            try {
                                const { data: items, error } = await supabaseClient
                                    .from('moodboard_items')
                                    .select('*')
                                    .eq('project_id', projectId)
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                const moodboardGrid = document.getElementById('moodboardGrid');

                                if (!items || items.length === 0) {
                                    moodboardGrid.innerHTML = `
                                        <div style="text-align: center; padding: 4rem 2rem; color: #666; grid-column: 1 / -1;">
                                            <div style="margin-bottom: 1rem;">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                            </div>
                                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">No references yet</h4>
                                            <p style="margin: 0; font-size: 0.9rem;">Add images, links, or notes to build your moodboard</p>
                                        </div>
                                    `;
                                    return;
                                }

                                moodboardGrid.innerHTML = items.map(item => `
                                    <div class="moodboard-item">
                                        ${item.type === 'image' ? `
                                            <div class="moodboard-image" style="background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                                                ${item.image_url ? `
                                                    <img src="${item.image_url}" alt="${item.title}" class="moodboard-image" style="width: 100%; height: 150px; object-fit: cover;">
                                                ` : `
                                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3;">
                                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                        <polyline points="21 15 16 10 5 21"></polyline>
                                                    </svg>
                                                `}
                                            </div>
                                        ` : `
                                            <div class="moodboard-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                    <polyline points="15 3 21 3 21 9"></polyline>
                                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                                </svg>
                                            </div>
                                        `}
                                        <div class="moodboard-info">
                                            <div class="moodboard-title">${item.title}</div>
                                            ${item.description ? `<p class="moodboard-description">${item.description}</p>` : ''}
                                            ${item.type === 'link' && item.web_url ? `
                                                <a href="${item.web_url}" target="_blank" style="font-size: 0.8rem; color: #666; text-decoration: none; display: block; margin-top: 0.5rem;">
                                                    ${item.web_url.replace(/^https?:\/\//, '').substring(0, 30)}...
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('');

                            } catch (error) {
                                console.error('Error loading moodboard items:', error);
                                document.getElementById('moodboardGrid').innerHTML = `
                                    <div style="text-align: center; padding: 2rem; color: #666; grid-column: 1 / -1;">
                                        <p style="margin: 0; font-size: 0.9rem;">Error loading references</p>
                                    </div>
                                `;
                            }
                        }

                        async function loadWipProjects() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                const { data: projects, error } = await supabaseClient
                                    .from('wip_projects')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                const projectsList = document.getElementById('wipProjectsList');

                                if (!projects || projects.length === 0) {
                                    projectsList.innerHTML = `
                                        <div style="text-align: center; padding: 2rem; color: #666;">
                                            <p style="margin: 0; font-size: 0.9rem;">No projects yet</p>
                                        </div>
                                    `;
                                    return;
                                }

                                projectsList.innerHTML = projects.map(project => `
                                    <div class="wip-project-item" onclick="openProjectWorkspace('${project.id}')">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                            <div style="flex: 1;">
                                                <div class="wip-project-title">${project.title}</div>
                                                <div class="wip-project-meta">
                                                    ${project.type ? project.type + '  ' : ''}
                                                    ${new Date(project.created_at).toLocaleDateString()}
                                                </div>
                                                ${project.description ? `
                                                    <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; line-height: 1.3;">
                                                        ${project.description}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <button onclick="event.stopPropagation(); deleteWipProject('${project.id}', '${project.title.replace(/'/g, "\\'")}')" 
                                                    style="background: none; border: none; color: #ff4444; cursor: pointer; padding: 0.5rem; border-radius: 6px; margin-left: 0.5rem; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#fff0f0'"
                                                    onmouseout="this.style.background='none'"
                                                    title="Delete project">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18"></path>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('');

                            } catch (error) {
                                console.error('Error loading projects:', error);
                                document.getElementById('wipProjectsList').innerHTML = `
                                    <div style="text-align: center; padding: 2rem; color: #666;">
                                        <p style="margin: 0; font-size: 0.9rem;">Error loading projects</p>
                                    </div>
                                `;
                            }
                        }

                        // ==================== WIP TAB MANAGEMENT ====================
                                function switchWipTab(tabName) {
                                    // Update tab buttons
                                    document.querySelectorAll('.wip-tab').forEach(tab => {
                                        tab.classList.remove('active');
                                        tab.style.borderBottom = 'none';
                                    });

                                    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                                    document.querySelector(`[data-tab="${tabName}"]`).style.borderBottom = '2px solid #000';

                                    // Update tab content
                                    document.querySelectorAll('.wip-tab-content').forEach(content => {
                                        content.style.display = 'none';
                                    });
                                    document.getElementById(`wip${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).style.display = 'block';

                                    // Load content for the tab if we have a project open
                                    if (window.currentWipProjectId) {
                                        switch(tabName) {
                                            case 'moodboard':
                                                loadMoodboardItems(window.currentWipProjectId);
                                                break;
                                            case 'sketches':
                                                // Will implement later
                                                break;
                                            case 'notes':
                                                // Will implement later
                                                break;
                                        }
                                    }
                                }

                        function closeWipStudio() {
                            const modal = document.getElementById('wipStudioModal');
                            if (modal) {
                                modal.style.display = 'none';
                                console.log(' WIP Studio closed');
                            }
                        }

                                function showWipToast(message, type = 'success') {
                                    const toast = document.createElement('div');
                                    toast.style.cssText = `
                                        position: fixed;
                                        top: 2rem;
                                        right: 2rem;
                                        background: ${type === 'error' ? '#dc2626' : '#000'};
                                        color: white;
                                        padding: 1rem 1.5rem;
                                        border-radius: 8px;
                                        font-size: 0.9rem;
                                        font-weight: 500;
                                        z-index: 10004;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                        animation: slideInRight 0.3s ease;
                                        max-width: 300px;
                                    `;

                                    toast.textContent = message;
                                    document.body.appendChild(toast);

                                    // Auto remove
                                    setTimeout(() => {
                                        toast.style.animation = 'slideOutRight 0.3s ease';
                                        setTimeout(() => toast.remove(), 300);
                                    }, 3000);
                                }

                        function addMoodboardItem() {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.7); // DARKER BACKGROUND
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10010; // HIGHER Z-INDEX
                            `;

                            modal.innerHTML = `
                                <div style="background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                                    <!-- HEADER -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500; letter-spacing: -0.02em;">Add Reference</h3>
                                        <button class="close-modal" 
                                                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;"
                                                onmouseover="this.style.background='#f5f5f5'; this.style.color='#000'" 
                                                onmouseout="this.style.background='none'; this.style.color='#666'"></button>
                                    </div>

                                    <!-- CONTENT -->
                                    <div style="padding: 2rem;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                                            <button class="ref-type-btn active" data-type="image" style="padding: 1rem; border: 1px solid #000; background: #000; color: white; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">Image</button>
                                            <button class="ref-type-btn" data-type="link" style="padding: 1rem; border: 1px solid #d1d1d1; background: white; color: #333; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">Web Link</button>
                                        </div>

                                        <!-- IMAGE UPLOAD SECTION -->
                                        <div id="imageUploadSection">
                                            <div style="margin-bottom: 1.5rem;">
                                                <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Upload Image</label>
                                                <div class="upload-zone" style="border: 2px dashed #d1d1d1; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;"
                                                     onmouseover="this.style.borderColor='#000'"
                                                     onmouseout="this.style.borderColor='#d1d1d1'">
                                                    <div id="imageUploadPlaceholder">
                                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;">
                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                            <polyline points="17 8 12 3 7 8"></polyline>
                                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                                        </svg>
                                                        <div style="font-size: 0.9rem; color: #666;">Drag & drop image or click to browse</div>
                                                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">JPG, PNG, WebP - max 5MB</div>
                                                    </div>
                                                    <input type="file" id="moodboardImageInput" accept="image/*" style="display: none;">
                                                    <div id="imagePreview" style="display: none;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- LINK INPUT SECTION -->
                                        <div id="linkInputSection" style="display: none;">
                                            <div style="margin-bottom: 1.5rem;">
                                                <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Web Link</label>
                                                <input type="url" id="referenceLink" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="https://...">
                                            </div>
                                        </div>

                                        <!-- COMMON FIELDS -->
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Title *</label>
                                            <input type="text" id="referenceTitle" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Enter reference title" required>
                                        </div>

                                        <div style="margin-bottom: 2rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                                            <textarea id="referenceDescription" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 80px; resize: vertical;" placeholder="Add notes about this reference..."></textarea>
                                        </div>

                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button class="cancel-btn" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#f5f5f5'"
                                                    onmouseout="this.style.background='none'">Cancel</button>
                                            <button class="add-reference-btn" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: opacity 0.2s;"
                                                    onmouseover="this.style.opacity='0.9'"
                                                    onmouseout="this.style.opacity='1'">Add Reference</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(modal);

                            // ADD EVENT HANDLERS
                            setTimeout(() => {
                                // Close buttons
                                modal.querySelector('.close-modal').onclick = () => modal.remove();
                                modal.querySelector('.cancel-btn').onclick = () => modal.remove();

                                // Type switcher
                                modal.querySelectorAll('.ref-type-btn').forEach(btn => {
                                    btn.onclick = function() {
                                        modal.querySelectorAll('.ref-type-btn').forEach(b => {
                                            b.style.background = 'white';
                                            b.style.color = '#333';
                                            b.style.borderColor = '#d1d1d1';
                                            b.classList.remove('active');
                                        });
                                        this.style.background = '#000';
                                        this.style.color = 'white';
                                        this.style.borderColor = '#000';
                                        this.classList.add('active');

                                        const type = this.dataset.type;
                                        document.getElementById('imageUploadSection').style.display = type === 'image' ? 'block' : 'none';
                                        document.getElementById('linkInputSection').style.display = type === 'link' ? 'block' : 'none';
                                    };
                                });

                                // Image upload
                                const uploadZone = modal.querySelector('.upload-zone');
                                const fileInput = modal.querySelector('#moodboardImageInput');

                                uploadZone.onclick = () => fileInput.click();
                                fileInput.onchange = (e) => handleImageUpload(e, modal);

                                // Add reference
                                modal.querySelector('.add-reference-btn').onclick = () => addReferenceToMoodboard(modal);
                            }, 100);
                        }

                        function showMoodboardModal() {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.7);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10010;
                            `;

                            modal.innerHTML = `
                                <div style="background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                                    <!-- HEADER -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Add Reference</h3>
                                        <button class="close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"></button>
                                    </div>

                                    <!-- CONTENT -->
                                    <div style="padding: 2rem;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                                            <button class="ref-type-btn active" data-type="image" style="padding: 1rem; border: 1px solid #000; background: #000; color: white; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Image</button>
                                            <button class="ref-type-btn" data-type="link" style="padding: 1rem; border: 1px solid #d1d1d1; background: white; color: #333; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Web Link</button>
                                        </div>

                                        <!-- IMAGE UPLOAD SECTION -->
                                        <div id="imageUploadSection">
                                            <div style="margin-bottom: 1.5rem;">
                                                <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Upload Image</label>
                                                <div class="upload-zone" style="border: 2px dashed #d1d1d1; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                                                    <div id="imageUploadPlaceholder">
                                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;">
                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                            <polyline points="17 8 12 3 7 8"></polyline>
                                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                                        </svg>
                                                        <div style="font-size: 0.9rem; color: #666;">Drag & drop image or click to browse</div>
                                                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">JPG, PNG, WebP - max 5MB</div>
                                                    </div>
                                                    <input type="file" id="moodboardImageInput" accept="image/*" style="display: none;">
                                                    <div id="imagePreview" style="display: none;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- LINK INPUT SECTION -->
                                        <div id="linkInputSection" style="display: none;">
                                            <div style="margin-bottom: 1.5rem;">
                                                <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Web Link</label>
                                                <input type="url" id="referenceLink" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="https://...">
                                            </div>
                                        </div>

                                        <!-- COMMON FIELDS -->
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Title *</label>
                                            <input type="text" id="referenceTitle" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Enter reference title" required>
                                        </div>

                                        <div style="margin-bottom: 2rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                                            <textarea id="referenceDescription" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 80px; resize: vertical;" placeholder="Add notes about this reference..."></textarea>
                                        </div>

                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button class="cancel-btn" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Cancel</button>
                                            <button class="add-reference-btn" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Add Reference</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(modal);

                            // EVENT HANDLERS
                            setTimeout(() => {
                                // Close buttons
                                modal.querySelector('.close-modal').onclick = () => modal.remove();
                                modal.querySelector('.cancel-btn').onclick = () => modal.remove();

                                // Type switcher
                                modal.querySelectorAll('.ref-type-btn').forEach(btn => {
                                    btn.onclick = function() {
                                        modal.querySelectorAll('.ref-type-btn').forEach(b => {
                                            b.style.background = 'white';
                                            b.style.color = '#333';
                                            b.style.borderColor = '#d1d1d1';
                                            b.classList.remove('active');
                                        });
                                        this.style.background = '#000';
                                        this.style.color = 'white';
                                        this.style.borderColor = '#000';
                                        this.classList.add('active');

                                        const type = this.dataset.type;
                                        document.getElementById('imageUploadSection').style.display = type === 'image' ? 'block' : 'none';
                                        document.getElementById('linkInputSection').style.display = type === 'link' ? 'block' : 'none';
                                    };
                                });

                                // Image upload
                                const uploadZone = modal.querySelector('.upload-zone');
                                const fileInput = modal.querySelector('#moodboardImageInput');

                                uploadZone.onclick = () => fileInput.click();
                                fileInput.onchange = (e) => handleImageUpload(e, modal);

                                // Add reference
                                modal.querySelector('.add-reference-btn').onclick = () => addReferenceToMoodboard(modal);
                            }, 100);
                        }

                        function showSketchModal() {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.7);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10010;
                            `;

                            modal.innerHTML = `
                                <div style="background: white; border-radius: 12px; max-width: 500px; width: 95%; max-height: 90vh; overflow-y: auto;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Upload Sketch</h3>
                                        <button class="close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"></button>
                                    </div>

                                    <div style="padding: 2rem;">
                                        <div style="text-align: center; padding: 2rem; color: #666;">
                                            <div style="margin-bottom: 1rem;">
                                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                                    <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                                                    <path d="M2 2l7.586 7.586"></path>
                                                    <circle cx="11" cy="11" r="2"></circle>
                                                </svg>
                                            </div>
                                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">Sketch Upload</h4>
                                            <p style="margin: 0; font-size: 0.9rem;">Upload drawings, drafts, or process documentation</p>
                                        </div>

                                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                                            <button class="cancel-btn" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Cancel</button>
                                            <button onclick="showToast('Sketch upload functionality coming in next update!')" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Upload Sketch</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(modal);

                            setTimeout(() => {
                                modal.querySelector('.close-modal').onclick = () => modal.remove();
                                modal.querySelector('.cancel-btn').onclick = () => modal.remove();
                            }, 100);
                        }

                        function showNoteModal() {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.7);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10010;
                            `;

                            modal.innerHTML = `
                                <div style="background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e5e5; background: #fafafa;">
                                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Create Note</h3>
                                        <button class="close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"></button>
                                    </div>

                                    <div style="padding: 2rem;">
                                        <div style="margin-bottom: 1.5rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Title *</label>
                                            <input type="text" id="noteTitle" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem;" placeholder="Enter note title" required>
                                        </div>

                                        <div style="margin-bottom: 2rem;">
                                            <label style="display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem;">Content</label>
                                            <textarea id="noteContent" style="width: 100%; padding: 0.875rem; border: 1px solid #d1d1d1; border-radius: 8px; font-size: 0.9rem; min-height: 200px; resize: vertical; font-family: monospace;" placeholder="Write your notes, ideas, or research here..."></textarea>
                                        </div>

                                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                            <button class="cancel-btn" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Cancel</button>
                                            <button class="add-note-btn" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Create Note</button>
                                        </div>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(modal);

                            setTimeout(() => {
                                modal.querySelector('.close-modal').onclick = () => modal.remove();
                                modal.querySelector('.cancel-btn').onclick = () => modal.remove();
                                modal.querySelector('.add-note-btn').onclick = () => addNoteToProject(modal);
                            }, 100);
                        }

                        async function addNoteToProject(modal) {
                            const title = modal.querySelector('#noteTitle').value.trim();
                            const content = modal.querySelector('#noteContent').value.trim();

                            if (!title) {
                                showToast('Please enter a note title', 'error');
                                return;
                            }

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user || !window.currentWipProjectId) return;

                                const { data, error } = await supabaseClient
                                    .from('wip_notes')
                                    .insert([{
                                        project_id: window.currentWipProjectId,
                                        title: title,
                                        content: content,
                                        artist_id: user.id
                                    }])
                                    .select()
                                    .single();

                                if (error) throw error;

                                showToast('Note created successfully!');
                                modal.remove();
                                // loadNotes() would go here when we build the notes tab

                            } catch (error) {
                                console.error('Error creating note:', error);
                                showToast('Error creating note', 'error');
                            }
                        }

                        function handleImageUpload(event, modal) {
                            const file = event.target.files[0];
                            if (!file) return;

                            if (!file.type.startsWith('image/')) {
                                showToast('Please select an image file', 'error');
                                return;
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                showToast('Image must be smaller than 5MB', 'error');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                modal.querySelector('#imageUploadPlaceholder').style.display = 'none';
                                const preview = modal.querySelector('#imagePreview');
                                preview.style.display = 'block';
                                preview.innerHTML = `
                                    <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                                        ${file.name} (${Math.round(file.size / 1024)}KB)
                                    </div>
                                `;
                            };
                            reader.readAsDataURL(file);
                        }

                        async function addReferenceToMoodboard(modal) {
                            const title = modal.querySelector('#referenceTitle').value.trim();
                            if (!title) {
                                showToast('Please enter a title', 'error');
                                return;
                            }

                            const type = modal.querySelector('.ref-type-btn.active').dataset.type;
                            const description = modal.querySelector('#referenceDescription').value.trim();

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user || !window.currentWipProjectId) return;

                                let imageUrl = null;
                                let webUrl = null;

                                if (type === 'image') {
                                    const fileInput = modal.querySelector('#moodboardImageInput');
                                    if (fileInput.files[0]) {
                                        const file = fileInput.files[0];
                                        const fileName = `${user.id}/moodboard/${Date.now()}_${file.name}`;
                                        const { data, error } = await supabaseClient.storage
                                            .from('artwork-images')
                                            .upload(fileName, file);
                                        if (error) throw error;

                                        const { data: { publicUrl } } = supabaseClient.storage
                                            .from('artwork-images')
                                            .getPublicUrl(data.path);
                                        imageUrl = publicUrl;
                                    }
                                } else if (type === 'link') {
                                    webUrl = modal.querySelector('#referenceLink').value.trim();
                                    if (!webUrl) {
                                        showToast('Please enter a web link', 'error');
                                        return;
                                    }
                                }

                                const { data, error } = await supabaseClient
                                    .from('moodboard_items')
                                    .insert([{
                                        project_id: window.currentWipProjectId,
                                        type: type,
                                        title: title,
                                        description: description,
                                        image_url: imageUrl,
                                        web_url: webUrl,
                                        artist_id: user.id
                                    }])
                                    .select()
                                    .single();

                                if (error) throw error;

                                showToast('Reference added successfully!');
                                modal.remove();
                                loadMoodboardItems(window.currentWipProjectId);

                            } catch (error) {
                                console.error('Error adding reference:', error);
                                showToast('Error adding reference', 'error');
                            }
                        }

                        async function createProjectFromModal() {
                            const name = document.getElementById('quickProjectName').value.trim();
                            const description = document.getElementById('quickProjectDescription').value.trim();

                            if (!name) {
                                showToast('Please enter a project name', 'error');
                                return;
                            }

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                const { data: project, error } = await supabaseClient
                                    .from('wip_projects')
                                    .insert([{
                                        title: name,
                                        description: description,
                                        artist_id: user.id,
                                        status: 'active'
                                    }])
                                    .select()
                                    .single();

                                if (error) throw error;

                                //  USE TOAST INSTEAD OF DIALOG
                                showToast(`"${name}" created successfully!`);

                                // Close project creation modal
                                document.querySelector('[style*="position: fixed"][style*="z-index: 10004"]').remove();

                                // Reload and open project
                                loadWipProjects();
                                openProjectWorkspace(project.id);

                            } catch (error) {
                                showToast('Error creating project', 'error');
                            }
                        }

                                function closeMoodboardItemModal() {
                                    const modal = document.getElementById('moodboardItemModal');
                                    if (modal) {
                                        modal.style.display = 'none';
                                        console.log(' Moodboard modal closed');
                                    }
                                }

                        function selectMoodboardType(type) {
                            currentMoodboardType = type;

                            // Update buttons
                            document.querySelectorAll('.moodboard-type-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.style.background = 'white';
                                btn.style.color = '#333';
                                btn.style.borderColor = '#d1d1d1';
                            });

                            const activeBtn = document.querySelector(`[data-type="${type}"]`);
                            activeBtn.classList.add('active');
                            activeBtn.style.background = '#000';
                            activeBtn.style.color = 'white';
                            activeBtn.style.borderColor = '#000';

                            // Show/hide sections
                            document.getElementById('moodboardImageSection').style.display = type === 'image' ? 'block' : 'none';
                            document.getElementById('moodboardLinkSection').style.display = type === 'link' ? 'block' : 'none';
                        }

                        function resetMoodboardForm() {
                            document.getElementById('moodboardItemForm').reset();
                            selectedMoodboardImage = null;
                            document.getElementById('moodboardUploadPlaceholder').style.display = 'block';
                            document.getElementById('moodboardImagePreview').style.display = 'none';
                            selectMoodboardType('image');
                        }

                        // Moodboard image upload handling
                        document.getElementById('moodboardUploadZone').addEventListener('click', function() {
                            document.getElementById('moodboardImageInput').click();
                        });

                        document.getElementById('moodboardImageInput').addEventListener('change', function(e) {
                            if (e.target.files.length > 0) {
                                handleMoodboardImageFile(e.target.files[0]);
                            }
                        });

                        function handleMoodboardImageFile(file) {
                            if (!file.type.startsWith('image/')) {
                                showToast('Please select an image file', 'error');
                                return;
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                showToast('Image must be smaller than 5MB', 'error');
                                return;
                            }

                            selectedMoodboardImage = file;
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                document.getElementById('moodboardUploadPlaceholder').style.display = 'none';
                                document.getElementById('moodboardImagePreview').style.display = 'block';
                                document.getElementById('moodboardImagePreview').innerHTML = `
                                    <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                                        ${file.name} (${Math.round(file.size / 1024)}KB)
                                    </div>
                                `;
                            };
                            reader.readAsDataURL(file);
                        }

                        // Drag and drop for moodboard
                        document.getElementById('moodboardUploadZone').addEventListener('dragover', function(e) {
                            e.preventDefault();
                            this.style.borderColor = '#000';
                            this.style.background = '#f8f8f8';
                        });

                        document.getElementById('moodboardUploadZone').addEventListener('dragleave', function(e) {
                            e.preventDefault();
                            this.style.borderColor = '#d1d1d1';
                            this.style.background = 'white';
                        });

                        document.getElementById('moodboardUploadZone').addEventListener('drop', function(e) {
                            e.preventDefault();
                            this.style.borderColor = '#d1d1d1';
                            this.style.background = 'white';
                            if (e.dataTransfer.files.length > 0) {
                                handleMoodboardImageFile(e.dataTransfer.files[0]);
                            }
                        });

                        // Form submission
                        document.getElementById('moodboardItemForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            await saveMoodboardItem();
                        });

                        async function saveMoodboardItem() {
                            const submitBtn = document.querySelector('#moodboardItemForm button[type="submit"]');
                            const originalText = submitBtn.textContent;

                            try {
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                const title = document.getElementById('moodboardTitle').value;
                                if (!title) {
                                    showToast('Title is required', 'error');
                                    return;
                                }

                                // Get current project ID (we'll need to track this)
                                const currentProjectId = window.currentWipProjectId;
                                if (!currentProjectId) {
                                    showToast('No project selected', 'error');
                                    return;
                                }

                                let imageUrl = null;

                                // Handle image upload if type is image
                                if (currentMoodboardType === 'image' && selectedMoodboardImage) {
                                    const imageName = `${user.id}/moodboard/${Date.now()}_${selectedMoodboardImage.name}`;
                                    const { data: imageData, error: uploadError } = await supabaseClient.storage
                                        .from('artwork-images')
                                        .upload(imageName, selectedMoodboardImage);

                                    if (uploadError) throw uploadError;

                                    const { data: { publicUrl } } = supabaseClient.storage
                                        .from('artwork-images')
                                        .getPublicUrl(imageData.path);

                                    imageUrl = publicUrl;
                                }

                                // Handle link if type is link
                                const webUrl = currentMoodboardType === 'link' ? document.getElementById('moodboardLink').value : null;

                                const moodboardData = {
                                    project_id: currentProjectId,
                                    type: currentMoodboardType,
                                    title: title,
                                    description: document.getElementById('moodboardDescription').value,
                                    image_url: imageUrl,
                                    web_url: webUrl
                                };

                                const { data: item, error } = await supabaseClient
                                    .from('moodboard_items')
                                    .insert([moodboardData])
                                    .select()
                                    .single();

                                if (error) throw error;

                                showToast('Reference added to moodboard!');
                                closeMoodboardItemModal();

                                // Reload moodboard items
                                loadMoodboardItems(currentProjectId);

                            } catch (error) {
                                console.error('Error saving moodboard item:', error);
                                showToast('Error saving reference: ' + error.message, 'error');
                            } finally {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        }

                        function openAIAssistant() {
                            showToast('AI Assistant opening soon!');
                        }

                        // Update WIP and COA counts
                        async function updateDashboardCounts() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                // Get WIP projects count
                                const { count, error } = await supabaseClient
                                    .from('wip_projects')
                                    .select('*', { count: 'exact', head: true })
                                    .eq('artist_id', user.id)
                                    .eq('status', 'active');

                                if (!error && count !== null) {
                                    document.getElementById('wipCount').textContent = count;
                                }

                                // COA count (placeholder for now)
                                document.getElementById('coaCount').textContent = '0';

                            } catch (error) {
                                console.error('Error updating counts:', error);
                            }
                        }

                        // ==================== STATS AND DASHBOARD ====================
                        function updateStats() {
                            try {
                                // Update artwork count
                                const artworksCount = currentArtworks.length;
                                document.getElementById('artworksCount').textContent = artworksCount;

                                // Update events count
                                const eventsGrid = document.getElementById('eventsGrid');
                                let eventsCount = 0;

                                if (eventsGrid) {
                                    const eventCards = eventsGrid.querySelectorAll('.event-card');
                                    eventsCount = eventCards.length;

                                    if (eventsCount === 0 && window.currentEvents && window.currentEvents.length > 0) {
                                        eventsCount = window.currentEvents.length;
                                    }
                                }

                                document.getElementById('eventsCount').textContent = eventsCount;

                                //  FIXED COLLECTIONS COUNT - USE window.currentCollections
                                let collectionsCount = 0;

                                // Use the global variable that gets set in loadProfileCollections()
                                if (window.currentCollections && window.currentCollections.length > 0) {
                                    collectionsCount = window.currentCollections.length;
                                } else {
                                    // Fallback to DOM counting
                                    const collectionsContainer = document.getElementById('collectionsContainer');
                                    if (collectionsContainer) {
                                        const collectionItems = collectionsContainer.querySelectorAll('.collection-item');
                                        collectionsCount = collectionItems.length;
                                    }
                                }

                                document.getElementById('collectionsCount').textContent = collectionsCount;

                                console.log(' Stats updated:', { 
                                    artworks: artworksCount, 
                                    events: eventsCount, 
                                    collections: collectionsCount 
                                });

                            } catch (error) {
                                console.error('Error updating stats:', error);
                                // Fallback to basic counts
                                document.getElementById('artworksCount').textContent = currentArtworks.length;
                                document.getElementById('eventsCount').textContent = '0';
                                document.getElementById('collectionsCount').textContent = '0';
                            }
                        }

                        // ==================== PLACEHOLDER FUNCTIONS ====================
                        function showArchivedPopup() {
                            if (document.getElementById('dashboard-section').style.display === 'block') {
                                document.getElementById('archivedPopup').style.display = 'flex';
                                fetchArchivedArtworks();
                            }
                        }

                        function hideArchivedPopup() {
                            document.getElementById('archivedPopup').style.display = 'none';
                        }

                        // ==================== CV REQUEST SYSTEM ====================
                        function showCVRequestForm() {
                            document.getElementById('cvRequestModal').style.display = 'flex';
                        }

                        function hideCVRequestForm() {
                            document.getElementById('cvRequestModal').style.display = 'none';
                            document.getElementById('cvRequestForm').reset();
                        }

                        async function submitCVRequest(event) {
                            event.preventDefault();
                            const submitBtn = event.target.querySelector('button[type="submit"]');
                            const originalText = submitBtn.textContent;

                            try {
                                // Set loading state
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<span class="loading-spinner"></span> Sending...';

                                const formData = new FormData(event.target);
                                const requestData = {
                                    name: formData.get('name'),
                                    company: formData.get('company'),
                                    email: formData.get('email'),
                                    phone: formData.get('phone'),
                                    message: formData.get('message'),
                                    requested_at: new Date().toISOString()
                                };

                                // Get current artist info for logging
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (user) {
                                    const { data: profile } = await supabaseClient
                                        .from('profiles')
                                        .select('full_name, username')
                                        .eq('id', user.id)
                                        .single();

                                    if (profile) {
                                        requestData.artist_name = profile.full_name || profile.username;
                                        requestData.artist_id = user.id;
                                    }
                                }

                                // In a real implementation, this would:
                                // 1. Send email to artist with request details
                                // 2. Log the request to database
                                // 3. Send auto-response to requester

                                console.log(' CV Request Received:', requestData);

                                // Simulate API call delay
                                await new Promise(resolve => setTimeout(resolve, 1000));

                                showToast(' CV request sent! The artist will contact you soon.');
                                hideCVRequestForm();

                                // Log activity for the artist
                                if (user) {
                                    await logActivity(
                                        'cv_request', 
                                        `CV requested by ${requestData.name} from ${requestData.company}`,
                                        `Email: ${requestData.email}${requestData.phone ? `, Phone: ${requestData.phone}` : ''}${requestData.message ? `, Message: ${requestData.message}` : ''}`
                                    );
                                }

                            } catch (error) {
                                console.error('CV request error:', error);
                                showToast('Error sending request. Please try again.', 'error');
                            } finally {
                                // Reset button state
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        }

                        function showActivityHistory() {
                            document.getElementById('activityHistoryPopup').style.display = 'flex';
                            loadActivityHistory(24); // Default: last day
                        }

                        function hideActivityHistory() {
                            document.getElementById('activityHistoryPopup').style.display = 'none';
                        }

                        async function loadActivityHistory(hours = 0) {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                let query = supabaseClient
                                    .from('activities')
                                    .select('*')
                                    .eq('artist_id', user.id)
                                    .order('created_at', { ascending: false });

                                const { data: activities, error } = await query;

                                if (error) throw error;

                                displayActivityHistory(activities || []);

                            } catch (error) {
                                console.error('Error loading activity history:', error);
                                document.getElementById('activityHistoryList').innerHTML = `
                                    <div class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>Unable to load activity history</p>
                                        </div>
                                    </div>
                                `;
                            }
                        }

                                function displayActivityHistory(activities) {
                                    const container = document.getElementById('activityHistoryList');
                                    if (!container) return;

                                    if (!activities || activities.length === 0) {
                                        container.innerHTML = `
                                            <div class="activity-item">
                                                <div class="activity-dot"></div>
                                                <div class="activity-content">
                                                    <p>No activities recorded yet</p>
                                                    <div class="activity-time">Upload artworks or make changes to see activity history</div>
                                                </div>
                                            </div>
                                        `;
                                        return;
                                    }

                                    container.innerHTML = activities.map(activity => {
                                        let displayText = activity.title;
                                        if (activity.description) {
                                            displayText += ` - ${activity.description}`;
                                        }

                                        return `
                                            <div class="activity-item">
                                                <div class="activity-dot"></div>
                                                <div class="activity-content">
                                                    <p>${displayText}</p>
                                                    <div class="activity-time">${formatActivityTime(activity.created_at)}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                }

                        function hideArchivedPopup() {
                            document.getElementById('archivedPopup').style.display = 'none';
                        }

                        function showTermsPopup() {
                            document.getElementById('termsPopup').style.display = 'flex';
                        }

                        function hideTermsPopup() {
                            document.getElementById('termsPopup').style.display = 'none';
                        }

                        function showPrivacyPopup() {
                            document.getElementById('privacyPopup').style.display = 'flex';
                        }

                        function hidePrivacyPopup() {
                            document.getElementById('privacyPopup').style.display = 'none';
                        }

                        function requestPasswordReset() {
                            const email = document.getElementById('email').value;
                            if (!email) {
                                showToast('Please enter your email address', 'error');
                                return;
                            }
                            showToast('Password reset feature coming soon!');
                        }

                        function showStyleBrowser() {
                            document.getElementById('styleBrowserModal').style.display = 'flex';
                            loadStyleBrowser();
                        }

                        function hideStyleBrowser() {
                            document.getElementById('styleBrowserModal').style.display = 'none';
                        }

                        function loadStyleBrowser() {
                            const container = document.getElementById('styleBrowserGrid');
                            if (!container) return;

                            // Get all preset styles
                            const presetStyles = Object.values(STYLE_PRESETS).map(style => 
                                createStyleCard(style)
                            ).join('');

                            //  LOAD AND DISPLAY CUSTOM PRESETS FROM LOCALSTORAGE
                            generatedStyles = JSON.parse(localStorage.getItem('generatedStyles') || '[]');
                            const customStyles = generatedStyles.map(style => createStyleCard(style)).join('');

                            //  COMBINE BOTH PRESETS AND CUSTOM STYLES
                            container.innerHTML = presetStyles + customStyles;

                            // If no custom styles, show message
                            if (generatedStyles.length === 0) {
                                container.innerHTML += `
                                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                                        <p>No custom presets yet. Create one in the Style Editor!</p>
                                    </div>
                                `;
                            }

                            updateFavoriteHearts();
                        }

                        function createStyleCard(style) {
                            const isFavorite = favoriteStyles.includes(style.id);
                            const isBaseStyle = style.isBase;
                            const isCustomStyle = style.id.startsWith('custom-');

                            return `
                                <div class="style-card" style="border: 1px solid #e5e5e5; border-radius: 12px; padding: 1.5rem; transition: all 0.2s ease; position: relative;">
                                    ${isBaseStyle ? `
                                        <div style="position: absolute; top: -8px; left: -8px; background: #000; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; z-index: 2;">
                                            BASE
                                        </div>
                                    ` : ''}

                                    ${isCustomStyle ? `
                                        <div style="position: absolute; top: -8px; right: -8px; background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; z-index: 2;">
                                            CUSTOM
                                        </div>
                                    ` : ''}

                                    <div style="background: ${style.colors.bg}; color: ${style.colors.text}; padding: 2rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; font-family: '${style.fonts.primary}', sans-serif; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; min-height: 120px; display: flex; flex-direction: column; justify-content: center;" 
                                         onclick="previewStyle('${style.id}')"
                                         onmouseover="this.style.borderColor='${style.colors.accent}'"
                                         onmouseout="this.style.borderColor='transparent'">
                                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">${style.name}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem; font-family: '${style.fonts.secondary}', sans-serif;">
                                            ${style.description}
                                        </div>
                                    </div>

                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">${style.name}</div>
                                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem; font-family: '${style.fonts.primary}', sans-serif;">
                                                ${style.fonts.primary}
                                            </div>
                                            <div style="font-size: 0.7rem; color: #999; font-family: '${style.fonts.secondary}', sans-serif;">
                                                + ${style.fonts.secondary}
                                            </div>
                                        </div>
                                        <button type="button" class="heart-btn" onclick="toggleFavorite('${style.id}')" style="background: none; border: none; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: ${isFavorite ? '#000000' : '#ddd'}">
                                            <!-- Crescent moons will be inserted by updateFavoriteHearts -->
                                        </button>
                                    </div>

                                    <button type="button" onclick="applyStyle('${style.id}')" class="btn-primary" style="width: 100%;">
                                        Apply Style
                                    </button>

                                    ${isCustomStyle ? `
                                        <button type="button" onclick="deleteCustomStyle('${style.id}')" class="btn-secondary" style="width: 100%; margin-top: 0.5rem; background: #ff4444; color: white; border: none;">
                                            Delete
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                        }

                        function deleteCustomStyle(styleId) {
                            //  ON-BRAND DELETE CONFIRMATION
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10000;
                            `;

                            dialog.innerHTML = `
                                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="background: #000; color: white; padding: 1rem; border-radius: 8px; display: inline-flex; margin-bottom: 1rem;">
                                            <h1 style="font-size: 1.5rem; font-weight: 600; margin: 0;">TRAC</h1>
                                        </div>
                                        <h3 style="margin: 0 0 0.5rem 0; font-weight: 500;">Delete Custom Preset</h3>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">This action cannot be undone.</p>
                                    </div>
                                    <div style="display: flex; gap: 1rem; justify-content: center;">
                                        <button id="cancelDelete" style="background: none; border: 1px solid #d1d1d1; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Cancel</button>
                                        <button id="confirmDelete" style="background: #000; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Delete Preset</button>
                                    </div>
                                </div>
                            `;

                            document.body.appendChild(dialog);

                            dialog.querySelector('#cancelDelete').onclick = () => {
                                document.body.removeChild(dialog);
                            };

                            dialog.querySelector('#confirmDelete').onclick = () => {
                                document.body.removeChild(dialog);

                                generatedStyles = generatedStyles.filter(style => style.id !== styleId);
                                localStorage.setItem('generatedStyles', JSON.stringify(generatedStyles));
                                showToast('Custom preset deleted');
                                loadStyleBrowser();
                            };

                            // Close on background click
                            dialog.onclick = (e) => {
                                if (e.target === dialog) {
                                    document.body.removeChild(dialog);
                                }
                            };
                        }

                        function toggleFavorite(styleId) {
                            const index = favoriteStyles.indexOf(styleId);
                            if (index > -1) {
                                favoriteStyles.splice(index, 1);
                            } else {
                                favoriteStyles.push(styleId);
                            }
                            localStorage.setItem('favoriteStyles', JSON.stringify(favoriteStyles));
                            updateFavoriteHearts();
                        }

                        function updateFavoriteHearts() {
                            const heartButtons = document.querySelectorAll('.heart-btn');
                            heartButtons.forEach(btn => {
                                const onclickAttr = btn.getAttribute('onclick');
                                if (onclickAttr) {
                                    const match = onclickAttr.match(/toggleFavorite\('([^']+)'\)/);
                                    if (match) {
                                        const styleId = match[1];
                                        const isFavorite = favoriteStyles.includes(styleId);
                                        //  CRESCENT MOONS - filled vs outline
                                        btn.innerHTML = isFavorite ? 
                                            '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>' :
                                            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
                                        btn.style.color = isFavorite ? '#000000' : '#ddd';
                                    }
                                }
                            });
                        }

                        async function applyStyle(styleId) {
                            console.log(' Applying style:', styleId);

                            //  KEEP EXISTING PRESET LOGIC EXACTLY THE SAME
                            let style = STYLE_PRESETS[styleId];
                            if (!style) {
                                // Check custom styles - ONLY CHANGE CUSTOM STYLE HANDLING
                                const customStyles = JSON.parse(localStorage.getItem('generatedStyles') || '[]');
                                style = customStyles.find(s => s.id === styleId);
                            }

                            if (!style) {
                                console.log(' Style not found:', styleId);
                                showToast('Style not found', 'error');
                                return;
                            }

                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) throw new Error('Not authenticated');

                                //  KEEP ALL EXISTING DATABASE FIELDS EXACTLY THE SAME
                                const updateData = { 
                                    portfolio_style: styleId,
                                    portfolio_layout: style.layout,
                                    header_layout: style.headerLayout,
                                    footer_style: style.footerStyle,
                                    collection_title_layout: style.collectionTitleLayout,
                                    image_size: style.imageSize || 'medium'
                                };

                                //  ONLY MODIFY CUSTOM STYLE SAVING - PRESETS STAY EXACTLY THE SAME
                                if (styleId.startsWith('custom-')) {
                                    updateData.custom_colors = style.colors;
                                    updateData.custom_fonts = {
                                        header: style.fonts.primary,
                                        body: style.fonts.secondary,
                                        header_size: style.fontSizes?.header || '24px',
                                        body_size: style.fontSizes?.body || '16px'
                                    };
                                    console.log(' Saving CUSTOM style to database:', styleId);
                                } else {
                                    //  PRESET STYLES - KEEP EXACTLY AS BEFORE
                                    updateData.custom_colors = style.colors;
                                    updateData.custom_fonts = {
                                        header: style.fonts.primary,
                                        body: style.fonts.secondary,
                                        header_size: '24px',
                                        body_size: '16px'
                                    };
                                    console.log(' Saving PRESET style to database:', styleId);
                                }

                                //  KEEP ALL EXISTING DATABASE CODE EXACTLY THE SAME
                                const { error } = await supabaseClient
                                    .from('profiles')
                                    .update(updateData)
                                    .eq('id', user.id);

                                if (error) throw error;

                                //  KEEP EXISTING LOCAL APPLICATION EXACTLY THE SAME
                                applyStyleLocally(style);
                                showToast(`${style.name} style applied`);

                                //  ONLY ADD THIS ONE LINE - AUTO-CLOSE AFTER APPLYING
                                hideStyleBrowser();

                            } catch (error) {
                                console.error('Style application error:', error);
                                showToast('Error applying style: ' + error.message, 'error');
                            }
                        }

                        // ADD HELPER FUNCTION
                        function applyStyleLocally(style) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            // Remove all style classes
                            portfolioPage.className = portfolioPage.className.replace(/style-\w+/g, '').replace('style-applied', '').trim();

                            // Add new style class
                            portfolioPage.classList.add('style-applied', `style-${style.id}`);

                            // Set CSS variables
                            portfolioPage.style.setProperty('--bg-color', style.colors.bg);
                            portfolioPage.style.setProperty('--text-color', style.colors.text);
                            portfolioPage.style.setProperty('--accent-color', style.colors.accent);
                            portfolioPage.style.setProperty('--border-color', style.colors.border);

                            // Set font variables
                            portfolioPage.style.setProperty('--header-font-family', style.fonts.primary);
                            portfolioPage.style.setProperty('--body-font-family', style.fonts.secondary);
                            portfolioPage.style.setProperty('--footer-font-family', style.fonts.primary);
                        }

                        // ==================== FIXED STYLE EDITOR SYSTEM ====================
                        function createStyleEditorPanel() {
                            // Remove existing editor if any
                            const oldPanel = document.querySelector('.style-editor-panel');
                            if (oldPanel) {
                                oldPanel.remove();
                            }

                            const panel = document.createElement('div');
                            panel.className = 'style-editor-panel';
                            panel.style.display = 'none';

                            panel.innerHTML = `
                                <div class="style-editor-header">
                                    <h4>Style Editor</h4>
                                    <button class="close-editor" onclick="toggleStyleEditor()"></button>
                                </div>

                                <div class="style-editor-tabs">
                                    <button class="style-editor-tab active" data-tab="colors">Colors</button>
                                    <button class="style-editor-tab" data-tab="layouts">Layouts</button>
                                    <button class="style-editor-tab" data-tab="fonts">Fonts</button>
                                    <button class="style-editor-tab" data-tab="advanced">Advanced</button>
                                </div>

                                <div class="style-editor-content">
                                    <!-- COLORS TAB -->
                                    <div class="style-tab-content active" id="colors-tab">
                                        <div class="color-controls">
                                            <div class="color-control-group">
                                                <label>Background Color</label>
                                                <div class="color-picker-container">
                                                    <input type="color" id="bgColor" class="color-picker" value="#ffffff">
                                                    <span class="color-value">#ffffff</span>
                                                </div>
                                            </div>
                                            <div class="color-control-group">
                                                <label>Text Color</label>
                                                <div class="color-picker-container">
                                                    <input type="color" id="textColor" class="color-picker" value="#000000">
                                                    <span class="color-value">#000000</span>
                                                </div>
                                            </div>
                                            <div class="color-control-group">
                                                <label>Accent Color</label>
                                                <div class="color-picker-container">
                                                    <input type="color" id="accentColor" class="color-picker" value="#666666">
                                                    <span class="color-value">#666666</span>
                                                </div>
                                            </div>
                                            <div class="color-control-group">
                                                <label>Border Color</label>
                                                <div class="color-picker-container">
                                                    <input type="color" id="borderColor" class="color-picker" value="#e5e5e5">
                                                    <span class="color-value">#e5e5e5</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- LAYOUTS TAB -->
                                    <div class="style-tab-content" id="layouts-tab">
                                        <div class="layout-controls">
                                            <div class="layout-control-group">
                                                <label>Grid Layout</label>
                                                <select id="gridLayout" class="layout-select">
                                                    <option value="grid-classic">Classic Grid</option>
                                                    <option value="grid-masonry">Masonry</option>
                                                    <option value="stacked-minimal">Stacked Minimal</option>
                                                    <option value="guerrilla-grid">Guerrilla Minimal</option>
                                                    <option value="gallery-spaced">Elegant Gallery</option>
                                                    <option value="immersive-stacked">Immersive Stacked</option>
                                                    <option value="monumental-asymmetric">Monumental Asymmetric</option>
                                                    <option value="historical-overlap">Historical Layered</option>
                                                    <option value="vibrant-mosaic">Vibrant Mosaic</option>
                                                    <option value="abstract-random">Abstract Random</option>
                                                    <option value="quilt-narrative">Storytelling Quilt</option>
                                                    <option value="digital-floating">Digital Floating</option>
                                                    <option value="archival-dossier">Archival Dossier</option>
                                                </select>
                                            </div>
                                            <div class="layout-control-group">
                                                <label>Header Style</label>
                                                <select id="headerLayout" class="layout-select">
                                                    <option value="centered">Centered</option>
                                                    <option value="floating">Floating</option>
                                                    <option value="split">Split</option>
                                                    <option value="minimal">Minimal</option>
                                                    <option value="expressive">Expressive</option>
                                                    <option value="left-aligned">Left Aligned</option>
                                                </select>
                                            </div>
                                            <div class="layout-control-group">
                                                <label>Footer Style</label>
                                                <select id="footerStyle" class="layout-select">
                                                    <option value="minimal">Minimal</option>
                                                    <option value="hidden">Hidden</option>
                                                    <option value="expanded">Expanded</option>
                                                    <option value="social-focused">Social Focused</option>
                                                    <option value="contact-prominent">Contact Prominent</option>
                                                </select>
                                            </div>
                                            <div class="layout-control-group">
                                                <label>Image Size</label>
                                                <select id="imageSize" class="layout-select">
                                                    <option value="small">Small</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="large">Large</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- FONTS TAB -->
                                    <div class="style-tab-content" id="fonts-tab">
                                        <div class="font-controls">
                                            <div class="font-control-group">
                                                <label>Header Font</label>
                                                <select id="headerFont" class="font-select">
                                                    <option value="Space Grotesk">Space Grotesk</option>
                                                    <option value="Helvetica">Helvetica</option>
                                                    <option value="Georgia">Georgia</option>
                                                    <option value="Times New Roman">Times New Roman</option>
                                                    <option value="Arial">Arial</option>
                                                    <option value="Courier New">Courier New</option>
                                                    <option value="Garamond">Garamond</option>
                                                    <option value="Arial Rounded MT Bold">Arial Rounded</option>
                                                    <option value="Brush Script MT">Brush Script</option>
                                                </select>
                                            </div>
                                            <div class="font-control-group">
                                                <label>Body Font</label>
                                                <select id="bodyFont" class="font-select">
                                                    <option value="Space Grotesk">Space Grotesk</option>
                                                    <option value="Helvetica Neue">Helvetica Neue</option>
                                                    <option value="Georgia">Georgia</option>
                                                    <option value="Arial">Arial</option>
                                                    <option value="Courier New">Courier New</option>
                                                    <option value="Baskerville">Baskerville</option>
                                                    <option value="Palatino">Palatino</option>
                                                    <option value="Comic Sans MS">Comic Sans</option>
                                                    <option value="Papyrus">Papyrus</option>
                                                    <option value="OCR A Std">OCR A</option>
                                                </select>
                                            </div>
                                            <div class="font-control-group">
                                                <label>Font Sizes</label>
                                                <div class="font-size-controls">
                                                    <div class="size-control">
                                                        <label>Header Size</label>
                                                        <input type="range" id="headerSize" min="12" max="36" value="24" class="font-size-slider">
                                                        <span class="size-value">24px</span>
                                                    </div>
                                                    <div class="size-control">
                                                        <label>Body Size</label>
                                                        <input type="range" id="bodySize" min="12" max="24" value="16" class="font-size-slider">
                                                        <span class="size-value">16px</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ADVANCED TAB - SPACING REMOVED -->
                                    <div class="style-tab-content" id="advanced-tab">
                                        <div class="advanced-controls">
                                            <div class="advanced-control-group">
                                                <label>Text Body Layout</label>
                                                <select id="collectionTitleLayout" class="advanced-select">
                                                    <option value="centered">Centered</option>
                                                    <option value="minimal">Minimal</option>
                                                    <option value="left-aligned">Left Aligned</option>
                                                    <option value="centered-large">Centered Large</option>
                                                    <option value="expressive">Expressive</option>
                                                    <option value="bold-centered">Bold Centered</option>
                                                    <option value="archival">Archival</option>
                                                    <option value="rotated">Rotated</option>
                                                </select>
                                            </div>

                                            <div class="advanced-control-group">
                                                <label>Show Contact in Footer</label>
                                                <div class="toggle-control">
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="showFooterContact">
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                    <span class="toggle-label" id="footerContactStatus">Disabled</span>
                                                </div>
                                            </div>

                                            <!--  SAVE CUSTOM PRESET ADDED BACK -->
                                            <div class="advanced-control-group">
                                                <label>Save as Custom Preset</label>
                                                <div class="save-style-control">
                                                    <input type="text" id="newStyleName" class="style-name-input" placeholder="Enter preset name">
                                                    <button type="button" onclick="saveCustomStyle()" class="btn-primary">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="style-editor-actions">
                                    <button class="btn-secondary" onclick="resetStylePreview()">Reset</button>
                                    <button class="btn-primary" onclick="applyStyleChanges()">Apply Changes</button>
                                </div>
                            `;

                            document.body.appendChild(panel);
                            setupStyleEditorEvents();
                            console.log(' STYLE EDITOR RECREATED WITHOUT SPACING');
                            return panel;
                        }

                        function setupStyleEditorEvents() {
                            //  FIXED TAB NAVIGATION
                            document.querySelectorAll('.style-editor-tab').forEach(tab => {
                                tab.addEventListener('click', function() {
                                    // Remove active class from all tabs and contents
                                    document.querySelectorAll('.style-editor-tab').forEach(t => t.classList.remove('active'));
                                    document.querySelectorAll('.style-tab-content').forEach(c => c.classList.remove('active'));

                                    // Add active class to clicked tab and corresponding content
                                    this.classList.add('active');
                                    const tabId = this.getAttribute('data-tab');
                                    const content = document.getElementById(`${tabId}-tab`);
                                    if (content) content.classList.add('active');
                                });
                            });

                            // Color pickers
                            document.querySelectorAll('.color-picker').forEach(picker => {
                                picker.addEventListener('input', function() {
                                    const value = this.value;
                                    const valueSpan = this.nextElementSibling;
                                    valueSpan.textContent = value;
                                    updateColorPreview(this.id, value);
                                });
                            });

                            // Layout selects
                            document.querySelectorAll('.layout-select').forEach(select => {
                                select.addEventListener('change', function() {
                                    updateLayoutPreview(this.id, this.value);
                                });
                            });

                            // Font controls
                            document.querySelectorAll('.font-select').forEach(select => {
                                select.addEventListener('change', function() {
                                    updateFontPreview(this.id, this.value);
                                });
                            });

                            // Font size sliders
                            document.querySelectorAll('.font-size-slider').forEach(slider => {
                                slider.addEventListener('input', function() {
                                    const value = this.value + 'px';
                                    const valueSpan = this.nextElementSibling;
                                    valueSpan.textContent = value;
                                    updateFontPreview(this.id, value);
                                });
                            });

                            // Toggle switches
                            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                                toggle.addEventListener('change', function() {
                                    const statusSpan = this.closest('.toggle-control').querySelector('.toggle-label');
                                    statusSpan.textContent = this.checked ? 'Enabled' : 'Disabled';
                                    updateAdvancedPreview(this.id, this.checked);
                                });
                            });
                        }

                        function setupColorControls() {
                            const colorsTab = document.getElementById('colors-tab');
                            if (!colorsTab) return;

                            colorsTab.innerHTML = `
                                <div class="color-controls">
                                    <div class="color-control-group">
                                        <label>Background Color</label>
                                        <div class="color-picker-container">
                                            <input type="color" id="bgColor" class="color-picker" value="#ffffff">
                                            <span class="color-value">#ffffff</span>
                                        </div>
                                    </div>

                                    <div class="color-control-group">
                                        <label>Text Color</label>
                                        <div class="color-picker-container">
                                            <input type="color" id="textColor" class="color-picker" value="#000000">
                                            <span class="color-value">#000000</span>
                                        </div>
                                    </div>

                                    <div class="color-control-group">
                                        <label>Accent Color</label>
                                        <div class="color-picker-container">
                                            <input type="color" id="accentColor" class="color-picker" value="#666666">
                                            <span class="color-value">#666666</span>
                                        </div>
                                    </div>

                                    <div class="color-control-group">
                                        <label>Border Color</label>
                                        <div class="color-picker-container">
                                            <input type="color" id="borderColor" class="color-picker" value="#e5e5e5">
                                            <span class="color-value">#e5e5e5</span>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // Add event listeners for color pickers
                            const colorPickers = colorsTab.querySelectorAll('.color-picker');
                            colorPickers.forEach(picker => {
                                picker.addEventListener('input', function() {
                                    const value = this.value;
                                    const valueSpan = this.nextElementSibling;
                                    valueSpan.textContent = value;

                                    // Update preview in real-time
                                    updateColorPreview(this.id, value);
                                });
                            });
                        }

                        function updateColorPreview(colorType, value) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            switch(colorType) {
                                case 'bgColor':
                                    portfolioPage.style.setProperty('--bg-color', value);
                                    break;
                                case 'textColor':
                                    portfolioPage.style.setProperty('--text-color', value);
                                    break;
                                case 'accentColor':
                                    portfolioPage.style.setProperty('--accent-color', value);
                                    break;
                                case 'borderColor':
                                    portfolioPage.style.setProperty('--border-color', value);
                                    break;
                            }
                        }

                        function setupTabNavigation() {
                            const tabs = document.querySelectorAll('.style-editor-tab');
                            const contents = document.querySelectorAll('.style-tab-content');

                            tabs.forEach(tab => {
                                tab.addEventListener('click', () => {
                                    // Remove active class from all tabs and contents
                                    tabs.forEach(t => t.classList.remove('active'));
                                    contents.forEach(c => c.classList.remove('active'));

                                    // Add active class to clicked tab and corresponding content
                                    tab.classList.add('active');
                                    const tabId = tab.getAttribute('data-tab');
                                    document.getElementById(`${tabId}-tab`).classList.add('active');
                                });
                            });
                        }

                        // ==================== FIXED STYLE EDITOR APPLY FUNCTION ====================
                        async function applyStyleChanges() {
                            try {
                                //  CHECK USER AUTHENTICATION
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) {
                                    showToast('You must be logged in to edit styles', 'error');
                                    return;
                                }

                                //  GET STYLE DATA FROM FORM
                                const styleData = {
                                    portfolio_style: 'custom',
                                    portfolio_layout: document.getElementById('gridLayout').value,
                                    header_layout: document.getElementById('headerLayout').value,
                                    footer_style: document.getElementById('footerStyle').value,
                                    image_size: document.getElementById('imageSize').value,
                                    collection_title_layout: document.getElementById('collectionTitleLayout').value,
                                    show_footer_contact: document.getElementById('showFooterContact').checked,
                                    custom_colors: {
                                        bg: document.getElementById('bgColor').value,
                                        text: document.getElementById('textColor').value,
                                        accent: document.getElementById('accentColor').value,
                                        border: document.getElementById('borderColor').value
                                    },
                                    custom_fonts: {
                                        header: document.getElementById('headerFont').value,
                                        body: document.getElementById('bodyFont').value,
                                        header_size: document.getElementById('headerSize').value + 'px',
                                        body_size: document.getElementById('bodySize').value + 'px'
                                    }
                                };

                                //  SAVE TO DATABASE
                                const { error } = await supabaseClient
                                    .from('profiles')
                                    .update(styleData)
                                    .eq('id', user.id);

                                if (error) throw error;

                                //  APPLY CHANGES IMMEDIATELY TO PORTFOLIO
                                const portfolioPage = document.getElementById('portfolioPage');
                                if (portfolioPage && document.getElementById('portfolio-section').style.display === 'block') {
                                    // APPLY COLORS
                                    portfolioPage.style.setProperty('--bg-color', styleData.custom_colors.bg);
                                    portfolioPage.style.setProperty('--text-color', styleData.custom_colors.text);
                                    portfolioPage.style.setProperty('--accent-color', styleData.custom_colors.accent);
                                    portfolioPage.style.setProperty('--border-color', styleData.custom_colors.border);

                                    // APPLY FONTS
                                    portfolioPage.style.setProperty('--header-font-family', styleData.custom_fonts.header);
                                    portfolioPage.style.setProperty('--body-font-family', styleData.custom_fonts.body);
                                    portfolioPage.style.setProperty('--footer-font-family', styleData.custom_fonts.body);
                                    portfolioPage.style.setProperty('--header-font-size', styleData.custom_fonts.header_size);
                                    portfolioPage.style.setProperty('--titles-size', styleData.custom_fonts.body_size);
                                    portfolioPage.style.setProperty('--desc-size', styleData.custom_fonts.body_size);
                                    portfolioPage.style.setProperty('--artwork-size', styleData.custom_fonts.body_size);
                                    portfolioPage.style.setProperty('--footer-font-size', styleData.custom_fonts.body_size);

                                    //  UPDATE LAYOUTS
                                    updateHeaderOnly(styleData.header_layout, await getCurrentProfileData());
                                    updateFooterOnly(styleData.footer_style, await getCurrentProfileData());
                                    updateGridLayoutOnly(styleData.portfolio_layout);
                                    updateImageSizeOnly(styleData.image_size);

                                    //  UPDATE COLLECTION LAYOUTS
                                    const newCollectionLayout = styleData.collection_title_layout;
                                    const collections = document.querySelectorAll('.collection-section');
                                    if (collections.length > 0) {
                                        const currentProfile = await getCurrentProfileData();
                                        if (currentProfile) {
                                            currentProfile.collection_title_layout = newCollectionLayout;
                                            collections.forEach(collection => {
                                                const title = collection.querySelector('h2')?.textContent || '';
                                                const description = collection.querySelector('p')?.textContent || '';
                                                const artworks = Array.from(collection.querySelectorAll('.artwork-card')).map(card => {
                                                    return {
                                                        image_url: card.querySelector('img')?.src,
                                                        title: card.querySelector('.artwork-title')?.textContent,
                                                        year: card.querySelector('.artwork-details div:nth-child(1)')?.textContent,
                                                        medium: card.querySelector('.artwork-details div:nth-child(2)')?.textContent,
                                                        dimensions: card.querySelector('.artwork-details div:nth-child(3)')?.textContent
                                                    };
                                                });

                                                if (artworks.length > 0) {
                                                    const collectionData = { name: title, description: description };
                                                    collection.innerHTML = generateCollectionLayout(
                                                        collectionData, 
                                                        newCollectionLayout, 
                                                        artworks, 
                                                        currentProfile
                                                    );
                                                }
                                            });
                                        }
                                    }
                                }

                                showToast(' Style changes applied!');

                            } catch (error) {
                                console.error('Style application error:', error);
                                showToast(' Error: ' + error.message, 'error');
                            }
                        }

                        //  TARGETED IMAGE SIZE UPDATE
                        function updateImageSizeOnly(sizeClass) {
                            console.log(' updateImageSizeOnly called with:', sizeClass);

                            //  ONLY TARGET PORTFOLIO GRIDS, NOT DASHBOARD
                            const portfolioGrids = document.querySelectorAll('#portfolioPage .artworks-grid');
                            portfolioGrids.forEach(grid => {
                                grid.className = grid.className.replace(/\b(small|medium|large)\b/g, '');
                                grid.classList.add(sizeClass);
                                console.log(' Portfolio image size updated to:', sizeClass);
                            });

                            //  DON'T TOUCH DASHBOARD GRIDS
                            const dashboardGrids = document.querySelectorAll('#dashboard-section .artworks-grid');
                            dashboardGrids.forEach(grid => {
                                // Keep dashboard at medium size always
                                grid.className = grid.className.replace(/\b(small|medium|large)\b/g, '');
                                grid.classList.add('medium');
                            });
                        }

                        // ==================== APPLY STYLES LOCALLY ====================
                        function applyStyleLocallyFromEditor(styleData) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            // Apply colors
                            if (styleData.custom_colors) {
                                portfolioPage.style.setProperty('--bg-color', styleData.custom_colors.bg);
                                portfolioPage.style.setProperty('--text-color', styleData.custom_colors.text);
                                portfolioPage.style.setProperty('--accent-color', styleData.custom_colors.accent);
                                portfolioPage.style.setProperty('--border-color', styleData.custom_colors.border);
                            }

                            // Apply fonts
                            if (styleData.custom_fonts) {
                                portfolioPage.style.setProperty('--header-font-family', styleData.custom_fonts.header);
                                portfolioPage.style.setProperty('--body-font-family', styleData.custom_fonts.body);
                                portfolioPage.style.setProperty('--footer-font-family', styleData.custom_fonts.body);
                                portfolioPage.style.setProperty('--header-font-size', styleData.custom_fonts.header_size);
                                portfolioPage.style.setProperty('--titles-size', styleData.custom_fonts.body_size);
                                portfolioPage.style.setProperty('--desc-size', styleData.custom_fonts.body_size);
                            }

                            // Apply layout changes
                            const grid = portfolioPage.querySelector('.artworks-grid');
                            if (grid && styleData.portfolio_layout) {
                                grid.className = grid.className.replace(/portfolio-layout\s+\S+/g, '');
                                grid.classList.add('portfolio-layout', styleData.portfolio_layout);
                            }

                            // Apply image size
                            if (grid && styleData.image_size) {
                                grid.className = grid.className.replace(/\b(small|medium|large)\b/g, '');
                                grid.classList.add(styleData.image_size);
                            }

                            // Apply footer contact setting
                            portfolioPage.style.setProperty('--show-footer-contact', styleData.show_footer_contact ? 'true' : 'false');
                        }

                        // ==================== RESET FUNCTION ====================
                        function resetStylePreview() {
                            // Only reset the EDITOR controls, not the actual portfolio
                            const colorDefaults = {
                                'bgColor': '#ffffff',
                                'textColor': '#000000', 
                                'accentColor': '#666666',
                                'borderColor': '#e5e5e5'
                            };

                            Object.keys(colorDefaults).forEach(id => {
                                const picker = document.getElementById(id);
                                if (picker) {
                                    picker.value = colorDefaults[id];
                                    const valueSpan = picker.nextElementSibling;
                                    if (valueSpan) valueSpan.textContent = colorDefaults[id];
                                }
                            });

                            // Reset other controls to defaults but DON'T reset the portfolio
                            document.getElementById('gridLayout').value = 'grid-classic';
                            document.getElementById('headerLayout').value = 'centered';
                            document.getElementById('footerStyle').value = 'minimal';
                            document.getElementById('imageSize').value = 'medium';
                            document.getElementById('collectionTitleLayout').value = 'centered';
                            document.getElementById('headerFont').value = 'Space Grotesk';
                            document.getElementById('bodyFont').value = 'Space Grotesk';
                            document.getElementById('headerSize').value = '24';
                            document.getElementById('bodySize').value = '16';
                            document.getElementById('showFooterContact').checked = false;
                            document.getElementById('hoverEffects').checked = true;

                            showToast(' Editor reset to defaults');
                        }

                        // ==================== TOGGLE EDITOR ====================
                        function toggleStyleEditor() {
                            let panel = document.querySelector('.style-editor-panel');

                            // Always recreate the panel to ensure fresh HTML
                            if (!panel) {
                                panel = createStyleEditorPanel();
                            }

                            if (panel.style.display === 'none') {
                                panel.style.display = 'block';
                                loadCurrentStyleIntoEditor();
                            } else {
                                panel.style.display = 'none';
                            }
                        }

                        
                        function rgbToHex(rgb) {
                            if (!rgb || rgb.startsWith('#')) return rgb || '#ffffff';

                            // Handle rgb() and rgba() formats
                            const match = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)$/);
                            if (!match) return '#ffffff';

                            const r = parseInt(match[1]);
                            const g = parseInt(match[2]); 
                            const b = parseInt(match[3]);

                            // Convert to hex and ensure 6 digits
                            return "#" + [r, g, b].map(x => {
                                const hex = x.toString(16);
                                return hex.length === 1 ? '0' + hex : hex;
                            }).join('');
                        }

                        // ==================== LOAD CURRENT STYLES INTO EDITOR ====================
                        async function loadCurrentStyleIntoEditor() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                const { data: profile, error } = await supabaseClient
                                    .from('profiles')
                                    .select('*')
                                    .eq('id', user.id)
                                    .single();

                                if (error) {
                                    console.error('Database error:', error);
                                    return;
                                }

                                const portfolioPage = document.getElementById('portfolioPage');
                                const styles = portfolioPage ? getComputedStyle(portfolioPage) : null;

                                // COLORS
                                if (profile.custom_colors) {
                                    document.getElementById('bgColor').value = profile.custom_colors.bg || '#ffffff';
                                    document.getElementById('textColor').value = profile.custom_colors.text || '#000000';
                                    document.getElementById('accentColor').value = profile.custom_colors.accent || '#666666';
                                    document.getElementById('borderColor').value = profile.custom_colors.border || '#e5e5e5';
                                } else if (styles) {
                                    // Fallback to CSS
                                    document.getElementById('bgColor').value = rgbToHex(styles.getPropertyValue('--bg-color').trim() || '#ffffff');
                                    document.getElementById('textColor').value = rgbToHex(styles.getPropertyValue('--text-color').trim() || '#000000');
                                    document.getElementById('accentColor').value = rgbToHex(styles.getPropertyValue('--accent-color').trim() || '#666666');
                                    document.getElementById('borderColor').value = rgbToHex(styles.getPropertyValue('--border-color').trim() || '#e5e5e5');
                                }

                                // UPDATE COLOR DISPLAYS
                                document.querySelectorAll('.color-picker').forEach(picker => {
                                    const valueSpan = picker.nextElementSibling;
                                    valueSpan.textContent = picker.value;
                                });

                                // LAYOUTS
                                document.getElementById('headerLayout').value = profile.header_layout || 'centered';
                                document.getElementById('footerStyle').value = profile.footer_style || 'minimal';
                                document.getElementById('gridLayout').value = profile.portfolio_layout || 'grid-classic';
                                document.getElementById('imageSize').value = profile.image_size || 'medium';

                                //  ADVANCED CONTROLS WITH CORRECT IDs
                                document.getElementById('collectionTitleLayout').value = profile.collection_title_layout || 'centered';
                                document.getElementById('showFooterContact').checked = profile.show_footer_contact || false;
                                document.getElementById('footerContactStatus').textContent = 
                                    profile.show_footer_contact ? 'Enabled' : 'Disabled';

                                // FONTS  
                                if (profile.custom_fonts) {
                                    document.getElementById('headerSize').value = parseInt(profile.custom_fonts.header_size) || 24;
                                    document.getElementById('bodySize').value = parseInt(profile.custom_fonts.body_size) || 16;
                                    document.getElementById('headerFont').value = profile.custom_fonts.header || 'Space Grotesk';
                                    document.getElementById('bodyFont').value = profile.custom_fonts.body || 'Space Grotesk';
                                }

                                console.log(' Editor loaded successfully');

                            } catch (error) {
                                console.error('Error loading editor:', error);
                            }
                        }

                        async function getCurrentProfileData() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return null;

                                const { data: profile } = await supabaseClient
                                    .from('profiles')
                                    .select('*')
                                    .eq('id', user.id)
                                    .single();

                                return profile;
                            } catch (error) {
                                console.error('Error getting profile data:', error);
                                return null;
                            }
                        }

                        // ==================== HELPER FUNCTION FOR DEFAULTS ====================
                        function setDefaultEditorValues() {
                            console.log(' Setting default editor values');

                            // Colors
                            document.getElementById('bgColor').value = '#ffffff';
                            document.getElementById('textColor').value = '#000000';
                            document.getElementById('accentColor').value = '#666666';
                            document.getElementById('borderColor').value = '#e5e5e5';

                            // Update color displays
                            document.querySelectorAll('.color-picker').forEach(picker => {
                                const valueSpan = picker.nextElementSibling;
                                valueSpan.textContent = picker.value;
                            });

                            // Layouts
                            document.getElementById('gridLayout').value = 'grid-classic';
                            document.getElementById('headerLayout').value = 'centered';
                            document.getElementById('footerStyle').value = 'minimal';
                            document.getElementById('imageSize').value = 'medium';

                            // Fonts
                            document.getElementById('headerSize').value = 24;
                            document.getElementById('bodySize').value = 16;
                            document.getElementById('headerFont').value = 'Space Grotesk';
                            document.getElementById('bodyFont').value = 'Space Grotesk';

                            // Update font displays
                            document.querySelectorAll('#headerSize + .size-value').forEach(span => {
                                span.textContent = '24px';
                            });
                            document.querySelectorAll('#bodySize + .size-value').forEach(span => {
                                span.textContent = '16px';
                            });

                            // Advanced
                            const textBodyLayout = document.getElementById('textBodyLayout');
                            if (textBodyLayout) textBodyLayout.value = 'centered';

                            const showFooterContact = document.getElementById('showFooterContact');
                            if (showFooterContact) {
                                showFooterContact.checked = false;
                                const statusSpan = document.getElementById('footerContactStatus');
                                if (statusSpan) statusSpan.textContent = 'Disabled';
                            }

                            const gridGap = document.getElementById('gridGap');
                            if (gridGap) {
                                gridGap.value = 2;
                                const gapDisplay = document.querySelector('#gridGap + .size-value');
                                if (gapDisplay) gapDisplay.textContent = '2rem';
                            }

                            const cardPadding = document.getElementById('cardPadding');
                            if (cardPadding) {
                                cardPadding.value = 1.5;
                                const paddingDisplay = document.querySelector('#cardPadding + .size-value');
                                if (paddingDisplay) paddingDisplay.textContent = '1.5rem';
                            }
                        }


                        // ==================== LOAD SAVED STYLES FROM DATABASE ====================
                        async function loadSavedStyles() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return null;

                                const { data: profile, error } = await supabaseClient
                                    .from('profiles')
                                    .select('custom_colors, custom_fonts, portfolio_layout, image_size, show_footer_contact')
                                    .eq('id', user.id)
                                    .single();

                                if (error) {
                                    console.log('No saved styles found, using defaults');
                                    return null;
                                }

                                console.log(' Loaded saved styles:', profile);
                                return profile;

                            } catch (error) {
                                console.error('Error loading saved styles:', error);
                                return null;
                            }
                        }

                        // ==================== APPLY SAVED STYLES TO PORTFOLIO ====================
                        function applySavedStyles(profileData) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage || !profileData) return;

                            console.log(' APPLYING SAVED STYLES:', profileData);

                            // Apply colors
                            if (profileData.custom_colors) {
                                portfolioPage.style.setProperty('--bg-color', profileData.custom_colors.bg);
                                portfolioPage.style.setProperty('--text-color', profileData.custom_colors.text);
                                portfolioPage.style.setProperty('--accent-color', profileData.custom_colors.accent);
                                portfolioPage.style.setProperty('--border-color', profileData.custom_colors.border);
                            }

                            // Apply fonts
                            if (profileData.custom_fonts) {
                                portfolioPage.style.setProperty('--header-font-family', profileData.custom_fonts.header);
                                portfolioPage.style.setProperty('--body-font-family', profileData.custom_fonts.body);
                                portfolioPage.style.setProperty('--footer-font-family', profileData.custom_fonts.body);
                                portfolioPage.style.setProperty('--header-font-size', profileData.custom_fonts.header_size);
                                portfolioPage.style.setProperty('--titles-size', profileData.custom_fonts.body_size);
                                portfolioPage.style.setProperty('--desc-size', profileData.custom_fonts.body_size);
                                portfolioPage.style.setProperty('--artwork-size', profileData.custom_fonts.body_size);
                                portfolioPage.style.setProperty('--footer-font-size', profileData.custom_fonts.body_size);
                            }

                            // Apply layouts
                            if (profileData.portfolio_layout) {
                                updateGridLayoutOnly(profileData.portfolio_layout);
                            }
                            if (profileData.image_size) {
                                updateImageSizeOnly(profileData.image_size);
                            }

                            console.log(' Saved styles applied successfully');
                        }

                        function updateColorPreview(colorType, value) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            switch(colorType) {
                                case 'bgColor':
                                    portfolioPage.style.setProperty('--bg-color', value);
                                    break;
                                case 'textColor':
                                    portfolioPage.style.setProperty('--text-color', value);
                                    break;
                                case 'accentColor':
                                    portfolioPage.style.setProperty('--accent-color', value);
                                    break;
                                case 'borderColor':
                                    portfolioPage.style.setProperty('--border-color', value);
                                    break;
                            }
                        }

                        function setupFontControls() {
                            const fontsTab = document.getElementById('fonts-tab');
                            if (!fontsTab) return;

                            fontsTab.innerHTML = `
                                <div class="font-controls">
                                    <div class="font-control-group">
                                        <label>Header Font</label>
                                        <select id="headerFont" class="font-select">
                                            <option value="Space Grotesk">Space Grotesk</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Arial">Arial</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Garamond">Garamond</option>
                                            <option value="Arial Rounded MT Bold">Arial Rounded</option>
                                            <option value="Brush Script MT">Brush Script</option>
                                        </select>
                                    </div>

                                    <div class="font-control-group">
                                        <label>Body Font</label>
                                        <select id="bodyFont" class="font-select">
                                            <option value="Space Grotesk">Space Grotesk</option>
                                            <option value="Helvetica Neue">Helvetica Neue</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Arial">Arial</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Baskerville">Baskerville</option>
                                            <option value="Palatino">Palatino</option>
                                            <option value="Comic Sans MS">Comic Sans</option>
                                            <option value="Papyrus">Papyrus</option>
                                            <option value="OCR A Std">OCR A</option>
                                        </select>
                                    </div>

                                    <div class="font-control-group">
                                        <label>Font Sizes</label>
                                        <div class="font-size-controls">
                                            <div class="size-control">
                                                <label>Header Size</label>
                                                <input type="range" id="headerSize" min="12" max="36" value="24" class="font-size-slider">
                                                <span class="size-value">24px</span>
                                            </div>
                                            <div class="size-control">
                                                <label>Body Size</label>
                                                <input type="range" id="bodySize" min="12" max="24" value="16" class="font-size-slider">
                                                <span class="size-value">16px</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // Add event listeners for font controls
                            const fontSelects = fontsTab.querySelectorAll('.font-select');
                            fontSelects.forEach(select => {
                                select.addEventListener('change', function() {
                                    updateFontPreview(this.id, this.value);
                                });
                            });

                            // Add event listeners for font size sliders
                            const fontSliders = fontsTab.querySelectorAll('.font-size-slider');
                            fontSliders.forEach(slider => {
                                slider.addEventListener('input', function() {
                                    const value = this.value + 'px';
                                    const valueSpan = this.nextElementSibling;
                                    valueSpan.textContent = value;
                                    updateFontPreview(this.id, value);
                                });
                            });
                        }

                        function updateFontPreview(fontType, value) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            switch(fontType) {
                                case 'headerFont':
                                    portfolioPage.style.setProperty('--header-font-family', value);
                                    break;
                                case 'bodyFont':
                                    portfolioPage.style.setProperty('--body-font-family', value);
                                    portfolioPage.style.setProperty('--footer-font-family', value);
                                    break;
                                case 'headerSize':
                                    portfolioPage.style.setProperty('--header-font-size', value);
                                    break;
                                case 'bodySize':
                                    portfolioPage.style.setProperty('--titles-size', value);
                                    portfolioPage.style.setProperty('--desc-size', value);
                                    portfolioPage.style.setProperty('--artwork-size', value);
                                    portfolioPage.style.setProperty('--footer-font-size', value);
                                    break;
                            }
                        }

                        async function loadCurrentStyleIntoEditor() {
                            try {
                                const { data: { user } } = await supabaseClient.auth.getUser();
                                if (!user) return;

                                const { data: profile, error } = await supabaseClient
                                    .from('profiles')
                                    .select('*')
                                    .eq('id', user.id)
                                    .single();

                                if (error) {
                                    console.error('Database error:', error);
                                    return;
                                }

                                const portfolioPage = document.getElementById('portfolioPage');
                                const styles = portfolioPage ? getComputedStyle(portfolioPage) : null;

                                // COLORS
                                if (profile.custom_colors) {
                                    document.getElementById('bgColor').value = profile.custom_colors.bg || '#ffffff';
                                    document.getElementById('textColor').value = profile.custom_colors.text || '#000000';
                                    document.getElementById('accentColor').value = profile.custom_colors.accent || '#666666';
                                    document.getElementById('borderColor').value = profile.custom_colors.border || '#e5e5e5';
                                } else if (styles) {
                                    // Fallback to CSS
                                    document.getElementById('bgColor').value = rgbToHex(styles.getPropertyValue('--bg-color').trim() || '#ffffff');
                                    document.getElementById('textColor').value = rgbToHex(styles.getPropertyValue('--text-color').trim() || '#000000');
                                    document.getElementById('accentColor').value = rgbToHex(styles.getPropertyValue('--accent-color').trim() || '#666666');
                                    document.getElementById('borderColor').value = rgbToHex(styles.getPropertyValue('--border-color').trim() || '#e5e5e5');
                                }

                                // UPDATE COLOR DISPLAYS
                                document.querySelectorAll('.color-picker').forEach(picker => {
                                    const valueSpan = picker.nextElementSibling;
                                    valueSpan.textContent = picker.value;
                                });

                                // LAYOUTS
                                document.getElementById('headerLayout').value = profile.header_layout || 'centered';
                                document.getElementById('footerStyle').value = profile.footer_style || 'minimal';
                                document.getElementById('gridLayout').value = profile.portfolio_layout || 'grid-classic';
                                document.getElementById('imageSize').value = profile.image_size || 'medium';

                                //  ADVANCED CONTROLS WITH CORRECT IDs
                                document.getElementById('collectionTitleLayout').value = profile.collection_title_layout || 'centered';
                                document.getElementById('showFooterContact').checked = profile.show_footer_contact || false;
                                document.getElementById('footerContactStatus').textContent = 
                                    profile.show_footer_contact ? 'Enabled' : 'Disabled';

                                //  SPACING CONTROLS WITH CORRECT IDs
                                if (profile.grid_gap) {
                                    const gapValue = parseFloat(profile.grid_gap);
                                    document.getElementById('gridSpacing').value = gapValue;
                                    document.querySelector('#gridSpacing + .size-value').textContent = gapValue + 'rem';
                                }
                                if (profile.card_padding) {
                                    const paddingValue = parseFloat(profile.card_padding);
                                    document.getElementById('cardPadding').value = paddingValue;
                                    document.querySelector('#cardPadding + .size-value').textContent = paddingValue + 'rem';
                                }

                                // FONTS  
                                if (profile.custom_fonts) {
                                    document.getElementById('headerSize').value = parseInt(profile.custom_fonts.header_size) || 24;
                                    document.getElementById('bodySize').value = parseInt(profile.custom_fonts.body_size) || 16;
                                    document.getElementById('headerFont').value = profile.custom_fonts.header || 'Space Grotesk';
                                    document.getElementById('bodyFont').value = profile.custom_fonts.body || 'Space Grotesk';
                                }

                                console.log(' Editor loaded with correct IDs');

                            } catch (error) {
                                console.error('Error loading editor:', error);
                            }
                        }

                        // ==================== FIXED setupAdvancedControls - FULL VERSION ====================
                        function setupAdvancedControls() {
                            const advancedTab = document.getElementById('advanced-tab');
                            if (!advancedTab) return;

                            advancedTab.innerHTML = `
                                <div class="advanced-controls">
                                    <div class="advanced-control-group">
                                        <label>Text Body Layout</label>
                                        <select id="collectionTitleLayout" class="advanced-select">
                                            <option value="centered">Centered</option>
                                            <option value="minimal">Minimal</option>
                                            <option value="left-aligned">Left Aligned</option>
                                            <option value="centered-large">Centered Large</option>
                                            <option value="expressive">Expressive</option>
                                            <option value="bold-centered">Bold Centered</option>
                                            <option value="archival">Archival</option>
                                            <option value="rotated">Rotated</option>
                                        </select>
                                    </div>

                                    <div class="advanced-control-group">
                                        <label>Show Contact in Footer</label>
                                        <div class="toggle-control">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="showFooterContact">
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span class="toggle-label" id="footerContactStatus">Disabled</span>
                                        </div>
                                    </div>

                                    <div class="advanced-control-group">
                                        <label>Grid Spacing</label>
                                        <div class="font-size-controls">
                                            <input type="range" id="gridSpacing" min="1" max="4" value="2" class="font-size-slider">
                                            <span class="size-value">2rem</span>
                                        </div>
                                    </div>

                                    <div class="advanced-control-group">
                                        <label>Card Padding</label>
                                        <div class="font-size-controls">
                                            <input type="range" id="cardPadding" min="1" max="3" value="1.5" step="0.5" class="font-size-slider">
                                            <span class="size-value">1.5rem</span>
                                        </div>
                                    </div>
                                </div>
                            `;

                            console.log(' ADVANCED TAB BUILT WITH CORRECT IDs');

                            // EVENT LISTENERS
                            const toggles = advancedTab.querySelectorAll('.toggle-switch input');
                            toggles.forEach(toggle => {
                                toggle.addEventListener('change', function() {
                                    const statusSpan = this.closest('.toggle-control').querySelector('.toggle-label');
                                    statusSpan.textContent = this.checked ? 'Enabled' : 'Disabled';
                                });
                            });

                            // SPACING SLIDERS
                            const spacingSliders = advancedTab.querySelectorAll('.font-size-slider');
                            spacingSliders.forEach(slider => {
                                slider.addEventListener('input', function() {
                                    const valueSpan = this.nextElementSibling;
                                    valueSpan.textContent = this.value + 'rem';
                                });
                            });
                        }


                        function updateAdvancedPreview(controlType, value) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            switch(controlType) {
                                case 'showFooterContact':
                                    portfolioPage.style.setProperty('--show-footer-contact', value ? 'true' : 'false');
                                    break;
                                case 'hoverEffects':
                                    const artworksGrid = portfolioPage.querySelector('.artworks-grid');
                                    if (artworksGrid) {
                                        if (value) {
                                            artworksGrid.classList.remove('no-hover-effects');
                                        } else {
                                            artworksGrid.classList.add('no-hover-effects');
                                        }
                                    }
                                    break;
                                case 'collectionTitleLayout':
                                    window.previewLayoutChanges = window.previewLayoutChanges || {};
                                    window.previewLayoutChanges.collectionTitleLayout = value;
                                    break;
                            }
                        }

                        function saveCustomStyle() {
                            const styleName = document.getElementById('newStyleName').value.trim();
                            if (!styleName) {
                                showToast('Please enter a style name');
                                return;
                            }

                            //  SAVE EXACT CURRENT STYLE, NOT BASED ON PREVIOUS PRESET
                            const customStyle = {
                                id: 'custom-' + Date.now(),
                                name: styleName,
                                description: 'Custom style created by user',
                                layout: document.getElementById('gridLayout').value,
                                headerLayout: document.getElementById('headerLayout').value,
                                footerStyle: document.getElementById('footerStyle').value,
                                collectionTitleLayout: document.getElementById('collectionTitleLayout').value,
                                colors: {
                                    bg: document.getElementById('bgColor').value,
                                    text: document.getElementById('textColor').value,
                                    accent: document.getElementById('accentColor').value,
                                    border: document.getElementById('borderColor').value
                                },
                                fonts: {
                                    primary: document.getElementById('headerFont').value,
                                    secondary: document.getElementById('bodyFont').value
                                },
                                showFooterContact: document.getElementById('showFooterContact').checked,
                                imageSize: document.getElementById('imageSize').value
                            };

                            generatedStyles = JSON.parse(localStorage.getItem('generatedStyles') || '[]');
                            generatedStyles.push(customStyle);
                            localStorage.setItem('generatedStyles', JSON.stringify(generatedStyles));

                            showToast(`"${styleName}" saved as custom preset!`);
                            document.getElementById('newStyleName').value = '';

                            if (document.getElementById('styleBrowserModal').style.display === 'flex') {
                                loadStyleBrowser();
                            }
                        }

                        function setupLayoutControls() {
                            const layoutsTab = document.getElementById('layouts-tab');
                            if (!layoutsTab) return;

                            layoutsTab.innerHTML = `
                                <div class="layout-controls">
                                    <div class="layout-control-group">
                                        <label>Grid Layout</label>
                                        <select id="gridLayout" class="layout-select">
                                            <option value="grid-classic">Classic Grid</option>
                                            <option value="grid-masonry">Masonry</option>
                                            <option value="stacked-minimal">Stacked Minimal</option>
                                            <option value="guerrilla-grid">Guerrilla Minimal</option>
                                            <option value="gallery-spaced">Elegant Gallery</option>
                                            <option value="immersive-stacked">Immersive Stacked</option>
                                            <option value="monumental-asymmetric">Monumental Asymmetric</option>
                                            <option value="historical-overlap">Historical Layered</option>
                                            <option value="vibrant-mosaic">Vibrant Mosaic</option>
                                            <option value="abstract-random">Abstract Random</option>
                                            <option value="quilt-narrative">Storytelling Quilt</option>
                                            <option value="digital-floating">Digital Floating</option>
                                            <option value="archival-dossier">Archival Dossier</option>
                                        </select>
                                    </div>

                                    <div class="layout-control-group">
                                        <label>Header Style</label>
                                        <select id="headerLayout" class="layout-select">
                                            <option value="centered">Centered</option>
                                            <option value="floating">Floating</option>
                                            <option value="split">Split</option>
                                            <option value="minimal">Minimal</option>
                                            <option value="expressive">Expressive</option>
                                            <option value="left-aligned">Left Aligned</option>
                                        </select>
                                    </div>

                                    <div class="layout-control-group">
                                        <label>Footer Style</label>
                                        <select id="footerStyle" class="layout-select">
                                            <option value="minimal">Minimal</option>
                                            <option value="hidden">Hidden</option>
                                            <option value="expanded">Expanded</option>
                                            <option value="social-focused">Social Focused</option>
                                            <option value="contact-prominent">Contact Prominent</option>
                                        </select>
                                    </div>

                                    <div class="layout-control-group">
                                        <label>Image Size</label>
                                        <select id="imageSize" class="layout-select">
                                            <option value="small">Small</option>
                                            <option value="medium">Medium</option>
                                            <option value="large">Large</option>
                                        </select>
                                    </div>
                                </div>
                            `;

                            // Add event listeners for layout controls
                            const layoutSelects = layoutsTab.querySelectorAll('.layout-select');
                            layoutSelects.forEach(select => {
                                select.addEventListener('change', function() {
                                    updateLayoutPreview(this.id, this.value);
                                });
                            });
                        }

                        function updateLayoutPreview(layoutType, value) {
                            const portfolioPage = document.getElementById('portfolioPage');
                            if (!portfolioPage) return;

                            switch(layoutType) {
                                case 'gridLayout':
                                    // Remove all layout classes and add new one
                                    const grid = portfolioPage.querySelector('.artworks-grid');
                                    if (grid) {
                                        grid.className = grid.className.replace(/portfolio-layout\s+\S+/g, '');
                                        grid.classList.add('portfolio-layout', value);
                                    }
                                    break;
                                case 'imageSize':
                                    // Update image size class
                                    const artworksGrid = portfolioPage.querySelector('.artworks-grid');
                                    if (artworksGrid) {
                                        artworksGrid.className = artworksGrid.className.replace(/\b(small|medium|large)\b/g, '');
                                        artworksGrid.classList.add(value);
                                    }
                                    break;
                                case 'headerLayout':
                                case 'footerStyle':
                                    // These require full portfolio reload, so just store for now
                                    window.previewLayoutChanges = window.previewLayoutChanges || {};
                                    window.previewLayoutChanges[layoutType] = value;
                                    break;
                            }
                        }

                        function setupTabNavigation() {
                            const tabs = document.querySelectorAll('.style-editor-tab');
                            const contents = document.querySelectorAll('.style-tab-content');

                            tabs.forEach(tab => {
                                tab.addEventListener('click', () => {
                                    // Remove active class from all tabs and contents
                                    tabs.forEach(t => t.classList.remove('active'));
                                    contents.forEach(c => c.classList.remove('active'));

                                    // Add active class to clicked tab and corresponding content
                                    tab.classList.add('active');
                                    const tabId = tab.getAttribute('data-tab');
                                    document.getElementById(`${tabId}-tab`).classList.add('active');
                                });
                            });
                        }

                        function openArtworkPopup(imageUrl, title, artwork) {
                            console.log(' Opening artwork popup:', title);

                            // Create overlay
                            const overlay = document.createElement('div');
                            overlay.id = 'artworkPopupOverlay';
                            overlay.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0, 0, 0, 0.95);
                                z-index: 10000;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                padding: 2rem;
                                backdrop-filter: blur(10px);
                                animation: fadeIn 0.3s ease;
                            `;

                            // Create popup content
                            const popupContent = document.createElement('div');
                            popupContent.style.cssText = `
                                background: white;
                                border-radius: 16px;
                                max-width: 90vw;
                                max-height: 90vh;
                                overflow: auto;
                                display: flex;
                                flex-direction: column;
                                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                                animation: scaleIn 0.3s ease;
                            `;

                            // Header with close button
                            const header = document.createElement('div');
                            header.style.cssText = `
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 1.5rem 2rem;
                                border-bottom: 1px solid #e5e5e5;
                                background: #fafafa;
                                border-radius: 16px 16px 0 0;
                            `;

                            const titleElement = document.createElement('h2');
                            titleElement.textContent = title || 'Untitled';
                            titleElement.style.cssText = `
                                margin: 0;
                                font-size: 1.5rem;
                                font-weight: 500;
                                letter-spacing: -0.02em;
                                color: #000;
                            `;

                            const closeButton = document.createElement('button');
                            closeButton.innerHTML = '';
                            closeButton.style.cssText = `
                                background: none;
                                border: none;
                                font-size: 2rem;
                                cursor: pointer;
                                color: #666;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 8px;
                                transition: all 0.2s;
                            `;
                            closeButton.onmouseover = () => {
                                closeButton.style.background = '#f0f0f0';
                                closeButton.style.color = '#000';
                            };
                            closeButton.onmouseout = () => {
                                closeButton.style.background = 'none';
                                closeButton.style.color = '#666';
                            };
                            closeButton.onclick = () => {
                                document.body.removeChild(overlay);
                            };

                            header.appendChild(titleElement);
                            header.appendChild(closeButton);

                            // Main content area
                            const mainContent = document.createElement('div');
                            mainContent.style.cssText = `
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 0;
                                min-height: 400px;
                            `;

                            // Image section
                            const imageSection = document.createElement('div');
                            imageSection.style.cssText = `
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                padding: 2rem;
                                background: #f8f8f8;
                                border-right: 1px solid #e5e5e5;
                            `;

                            const image = document.createElement('img');
                            image.src = imageUrl;
                            image.alt = title || 'Artwork';
                            image.style.cssText = `
                                max-width: 100%;
                                max-height: 60vh;
                                object-fit: contain;
                                display: block;
                                border-radius: 8px;
                            `;

                            imageSection.appendChild(image);

                            // Details section
                            const detailsSection = document.createElement('div');
                            detailsSection.style.cssText = `
                                padding: 2rem;
                                display: flex;
                                flex-direction: column;
                                gap: 1.5rem;
                                background: white;
                            `;

                            // Artwork details
                            const detailsList = document.createElement('div');
                            detailsList.style.cssText = `
                                display: flex;
                                flex-direction: column;
                                gap: 1rem;
                            `;

                            if (artwork.year) {
                                const yearItem = createDetailItem('Year', artwork.year);
                                detailsList.appendChild(yearItem);
                            }

                            if (artwork.medium) {
                                const mediumItem = createDetailItem('Medium', artwork.medium);
                                detailsList.appendChild(mediumItem);
                            }

                            if (artwork.dimensions) {
                                const dimensionsItem = createDetailItem('Dimensions', artwork.dimensions);
                                detailsList.appendChild(dimensionsItem);
                            }

                            detailsSection.appendChild(detailsList);

                            // Description
                            if (artwork.description) {
                                const descriptionSection = document.createElement('div');
                                descriptionSection.style.cssText = `
                                    border-top: 1px solid #e5e5e5;
                                    padding-top: 1.5rem;
                                `;

                                const descriptionTitle = document.createElement('h4');
                                descriptionTitle.textContent = 'Description';
                                descriptionTitle.style.cssText = `
                                    margin: 0 0 0.75rem 0;
                                    font-size: 1rem;
                                    font-weight: 500;
                                    color: #000;
                                `;

                                const descriptionText = document.createElement('p');
                                descriptionText.textContent = artwork.description;
                                descriptionText.style.cssText = `
                                    margin: 0;
                                    line-height: 1.6;
                                    color: #666;
                                    font-size: 0.9rem;
                                `;

                                descriptionSection.appendChild(descriptionTitle);
                                descriptionSection.appendChild(descriptionText);
                                detailsSection.appendChild(descriptionSection);
                            }

                            // Assemble main content
                            mainContent.appendChild(imageSection);
                            mainContent.appendChild(detailsSection);

                            // Assemble popup
                            popupContent.appendChild(header);
                            popupContent.appendChild(mainContent);
                            overlay.appendChild(popupContent);

                            // Add CSS animations
                            const style = document.createElement('style');
                            style.textContent = `
                                @keyframes fadeIn {
                                    from { opacity: 0; }
                                    to { opacity: 1; }
                                }
                                @keyframes scaleIn {
                                    from { transform: scale(0.9); opacity: 0; }
                                    to { transform: scale(1); opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);

                            // Close on ESC key
                            const handleEscape = (e) => {
                                if (e.key === 'Escape') {
                                    document.body.removeChild(overlay);
                                    document.removeEventListener('keydown', handleEscape);
                                }
                            };

                            // Close on overlay click
                            overlay.addEventListener('click', (e) => {
                                if (e.target === overlay) {
                                    document.body.removeChild(overlay);
                                    document.removeEventListener('keydown', handleEscape);
                                }
                            });

                            document.addEventListener('keydown', handleEscape);
                            document.body.appendChild(overlay);
                        }

                        function createDetailItem(label, value) {
                            const item = document.createElement('div');
                            item.style.cssText = `
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-start;
                                gap: 1rem;
                            `;

                            const labelElement = document.createElement('span');
                            labelElement.textContent = label;
                            labelElement.style.cssText = `
                                font-weight: 500;
                                color: #000;
                                font-size: 0.9rem;
                                min-width: 80px;
                            `;

                            const valueElement = document.createElement('span');
                            valueElement.textContent = value;
                            valueElement.style.cssText = `
                                color: #666;
                                font-size: 0.9rem;
                                text-align: right;
                                flex: 1;
                                line-height: 1.4;
                            `;

                            item.appendChild(labelElement);
                            item.appendChild(valueElement);
                            return item;
                        }

                                function closeArtworkPopup() {
                                    const popup = document.getElementById('artworkPopupOverlay');
                                    if (popup) {
                                        document.body.removeChild(popup);
                                    }
                                    // Also close the old popup system
                                    const oldPopup = document.getElementById('artworkPopup');
                                    if (oldPopup) {
                                        oldPopup.style.display = 'none';
                                    }
                                }

                        // Update the image click handlers in the portfolio
                        function updatePortfolioClickHandlers() {
                            setTimeout(() => {
                                const artworkImages = document.querySelectorAll('.artwork-image img');
                                artworkImages.forEach(img => {
                                    // Remove existing click handlers
                                    img.onclick = null;

                                    // Add new click handler
                                    img.addEventListener('click', function() {
                                        const artworkCard = this.closest('.artwork-card');
                                        const title = artworkCard.querySelector('.artwork-title')?.textContent || 'Untitled';
                                        const year = artworkCard.querySelector('.artwork-details div:nth-child(1)')?.textContent || '';
                                        const medium = artworkCard.querySelector('.artwork-details div:nth-child(2)')?.textContent || '';
                                        const dimensions = artworkCard.querySelector('.artwork-details div:nth-child(3)')?.textContent || '';

                                        // Get description if available (you might need to store this in data attributes)
                                        const description = '';

                                        const artworkData = {
                                            year: year,
                                            medium: medium,
                                            dimensions: dimensions,
                                            description: description
                                        };

                                        openArtworkPopup(this.src, title, artworkData);
                                    });
                                });
                            }, 1000);
                        }

                                // ==================== WORKING POPUP SYSTEM ====================

                        // Initialize the new popup system
                                function initPopupSystem() {
                                    createPopupElements();
                                    console.log(' Popup system initialized');
                                }

                                // Create popup elements
                                function createPopupElements() {
                                    // Remove existing popup if any
                                    const oldPopup = document.getElementById('artworkPopup');
                                    if (oldPopup) oldPopup.remove();

                                    // Create new popup
                                    const popup = document.createElement('div');
                                    popup.id = 'artworkPopup';
                                    popup.style.cssText = `
                                        position: fixed !important;
                                        top: 0 !important;
                                        left: 0 !important;
                                        width: 100% !important;
                                        height: 100% !important;
                                        background: rgba(0,0,0,0.95) !important;
                                        z-index: 99999 !important;
                                        display: none !important;
                                        align-items: center !important;
                                        justify-content: center !important;
                                        padding: 2rem !important;
                                    `;

                                    popup.innerHTML = `
                                        <!-- Close button -->
                                        <button onclick="closePopup()" style="position: absolute; top: 2rem; right: 2rem; background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 100001; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;"></button>

                                        <!-- Side-by-side container -->
                                        <div style="display: flex; align-items: flex-end; justify-content: center; gap: 1.5rem; max-width: 90vw; max-height: 90vh;">
                                            <!-- Image on LEFT -->
                                            <img id="popupImg" src="" style="max-width: 70vh; max-height: 90vh; object-fit: contain; display: block;">

                                            <!-- Details on RIGHT -->
                                            <div id="popupInfo" style="flex-shrink: 0; width: 200px;"></div>
                                        </div>
                                    `;

                                    document.body.appendChild(popup);
                                    console.log(' Popup elements created');
                                }

                                // Open popup function
                                function openPopup(imageSrc, title, year, medium, dimensions) {
                                    console.log(' Opening popup with:', { title, year, medium, dimensions });

                                    const popup = document.getElementById('artworkPopup');
                                    const popupImg = document.getElementById('popupImg');
                                    const popupInfo = document.getElementById('popupInfo');

                                    // Create elements if missing
                                    if (!popup || !popupImg || !popupInfo) {
                                        console.log(' Creating missing popup elements');
                                        createPopupElements();
                                        // Retry after creation
                                        setTimeout(() => openPopup(imageSrc, title, year, medium, dimensions), 100);
                                        return;
                                    }

                                    // Set image
                                    popupImg.src = imageSrc;
                                    popupImg.alt = title;

                                    // Create side details
                                    let infoHTML = `
                                        <div style="display: flex; flex-direction: column; justify-content: flex-end; height: 100%; padding-bottom: 2rem; padding-left: 1.5rem;">
                                            <div style="color: white;">
                                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem;">${title}</div>
                                    `;

                                    if (year && year !== '') infoHTML += `<div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.2rem;">${year}</div>`;
                                    if (medium && medium !== '') infoHTML += `<div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.2rem;">${medium}</div>`;
                                    if (dimensions && dimensions !== '') infoHTML += `<div style="font-size: 0.8rem; opacity: 0.8;">${dimensions}</div>`;

                                    infoHTML += `</div></div>`;

                                    popupInfo.innerHTML = infoHTML;

                                    // Show the popup
                                    popup.style.display = 'flex';

                                    console.log(' Popup visible!');
                                }

                                // Close popup function
                                function closePopup() {
                                    const popup = document.getElementById('artworkPopup');
                                    if (popup) {
                                        popup.style.display = 'none';
                                        console.log(' Popup closed');
                                    }
                                }

                                // Simple click handler for portfolio images
                                function initPortfolioClickHandlers() {
                                    document.addEventListener('click', function(e) {
                                        // Only work in portfolio section
                                        const portfolioSection = document.getElementById('portfolio-section');
                                        if (!portfolioSection || portfolioSection.style.display !== 'block') return;

                                        // Check if clicked on portfolio image
                                        if (e.target.tagName === 'IMG' && e.target.closest('.artwork-card')) {
                                            const img = e.target;
                                            const card = img.closest('.artwork-card');

                                            // Skip event cards
                                            if (card.classList.contains('event-card')) return;

                                            console.log(' Portfolio image clicked, opening popup...');

                                            // Get artwork data
                                            const title = card.querySelector('.artwork-title')?.textContent?.trim() || 
                                                         card.querySelector('h3')?.textContent?.trim() || 
                                                         'Artwork';

                                            const details = card.querySelector('.artwork-details');
                                            let year = '', medium = '', dimensions = '';

                                            if (details) {
                                                const divs = details.querySelectorAll('div');
                                                year = divs[0]?.textContent?.trim() || '';
                                                medium = divs[1]?.textContent?.trim() || '';
                                                dimensions = divs[2]?.textContent?.trim() || '';
                                            }

                                            console.log(' Popup data:', { title, year, medium, dimensions });
                                            openPopup(img.src, title, year, medium, dimensions);
                                        }
                                    });

                                    console.log(' Portfolio click handlers initialized');
                                }

                                // Initialize popup click handlers
                                function initPopupHandlers() {
                                    document.addEventListener('click', function(e) {
                                        if (e.target.matches('.artwork-image img')) {
                                            const img = e.target;

                                            // DEBUG: Check what data attributes exist
                                            console.log(' Image data attributes:', {
                                                title: img.getAttribute('data-artwork-title'),
                                                year: img.getAttribute('data-artwork-year'), 
                                                medium: img.getAttribute('data-artwork-medium'),
                                                dimensions: img.getAttribute('data-artwork-dimensions')
                                            });

                                            const title = img.getAttribute('data-artwork-title') || 'Untitled';
                                            const year = img.getAttribute('data-artwork-year') || '';
                                            const medium = img.getAttribute('data-artwork-medium') || '';
                                            const dimensions = img.getAttribute('data-artwork-dimensions') || '';

                                            openPopup(img.src, title, year, medium, dimensions);
                                        }
                                    });
                                }

                                    function testPopup() {
                                        console.log(' Testing popup...');

                                        const popup = document.getElementById('artworkPopup');
                                        console.log('Popup element:', popup);

                                        if (popup) {
                                            console.log('Popup found, displaying...');
                                            popup.style.display = 'flex';

                                            // Use your own artwork image or a working placeholder
                                            const testImage = 'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=600&h=400&fit=crop'; // Working test image

                                            document.getElementById('popupImg').src = testImage;
                                            document.getElementById('popupInfo').innerHTML = `
                                                <div style="color: white;">
                                                    <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem;">Test Artwork</div>
                                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.2rem;">2024</div>
                                                    <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.2rem;">Oil on canvas</div>
                                                    <div style="font-size: 0.8rem; opacity: 0.8;">24 x 36 in</div>
                                                </div>
                                            `;

                                            console.log(' Popup should be visible with working image');
                                        } else {
                                            console.log(' Popup element not found!');
                                        }
                                    }
                        
                        // ==================== DYNAMIC DATA ATTRIBUTES ====================
                        function addDataAttributesToImages() {
                            const images = document.querySelectorAll('.artwork-image img');

                            images.forEach(img => {
                                const card = img.closest('.artwork-card');
                                if (!card) return;

                                const title = card.querySelector('.artwork-title')?.textContent || 'Untitled';
                                const details = card.querySelector('.artwork-details');

                                let year = '', medium = '', dimensions = '';
                                if (details) {
                                    const divs = details.querySelectorAll('div');
                                    for (let i = 0; i < Math.min(divs.length, 3); i++) {
                                        const text = divs[i].textContent.trim();
                                        if (i === 0) year = text;
                                        if (i === 1) medium = text;
                                        if (i === 2) dimensions = text;
                                    }
                                }

                                // Add data attributes
                                img.setAttribute('data-artwork-title', title);
                                img.setAttribute('data-artwork-year', year);
                                img.setAttribute('data-artwork-medium', medium);
                                img.setAttribute('data-artwork-dimensions', dimensions);
                            });
                        }

                        // ==================== CLEAN PORTFOLIO DISPLAY ====================
                        function cleanPortfolioDisplay() {
                            // ONLY target portfolio section
                            const portfolioSection = document.getElementById('portfolio-section');
                            if (!portfolioSection || portfolioSection.style.display !== 'block') return;

                            // REMOVE ARTWORK DETAILS IMMEDIATELY (NOT JUST HIDE)
                            const artworkCards = document.querySelectorAll('#portfolioPage .artwork-card');
                            artworkCards.forEach(card => {
                                // EXCLUDE event cards from cleanup
                                if (!card.classList.contains('event-card') && !card.closest('#events-section')) {
                                    const title = card.querySelector('.artwork-title');
                                    const details = card.querySelector('.artwork-details');

                                    if (title) title.style.display = 'none';
                                    if (details) details.style.display = 'none';
                                }
                            });
                        }

                        // ==================== SAFE POPUP SYSTEM (PORTFOLIO ONLY) ====================
                                            function initSafePopupHandlers() {
                                                document.addEventListener('click', function(e) {
                                                    console.log(' Click detected on:', e.target);

                                                    // Only work in portfolio section
                                                    const portfolioSection = document.getElementById('portfolio-section');
                                                    if (!portfolioSection || portfolioSection.style.display !== 'block') {
                                                        console.log(' Not in portfolio section');
                                                        return;
                                                    }

                                                    if (e.target.matches('.artwork-image img')) {
                                                        console.log(' Portfolio image clicked, opening popup...');
                                                        const img = e.target;
                                                        const card = img.closest('.artwork-card');

                                                        if (!card) {
                                                            console.log(' No artwork card found');
                                                            return;
                                                        }

                                                        // Read from hidden DOM elements
                                                        const title = card.querySelector('.artwork-title')?.textContent || 'Untitled';
                                                        const details = card.querySelector('.artwork-details');

                                                        let year = '', medium = '', dimensions = '';
                                                        if (details) {
                                                            const divs = details.querySelectorAll('div');
                                                            for (let i = 0; i < Math.min(divs.length, 3); i++) {
                                                                const text = divs[i].textContent.trim();
                                                                if (i === 0) year = text;
                                                                if (i === 1) medium = text;
                                                                if (i === 2) dimensions = text;
                                                            }
                                                        }

                                                        console.log(' Popup data:', { title, year, medium, dimensions });

                                                        // USE THE EXISTING POPUP SYSTEM
                                                        openPopup(img.src, title, year, medium, dimensions);
                                                    }
                                                });
                                            }

                        // ==================== DASHBOARD CLEANUP ====================
                        function disableDashboardPopups() {
                            const dashboardSection = document.getElementById('dashboard-section');
                            if (dashboardSection && dashboardSection.style.display === 'block') {
                                const dashboardImages = document.querySelectorAll('#dashboard-section .artwork-image img');
                                dashboardImages.forEach(img => {
                                    img.style.pointerEvents = 'none';
                                    img.style.cursor = 'default';
                                    img.removeAttribute('onclick');
                                    img.onclick = null;
                                });
                            }
                        }

                        // Initialize everything
                        //setInterval(cleanPortfolioDisplay, 500);
                        setInterval(disableDashboardPopups, 300);
                        //setInterval(removePortfolioHoverEffects, 500);
                        setTimeout(initSafePopupHandlers, 1000);

                        // ==================== CLEAN PORTFOLIO DISPLAY ====================
                        function cleanPortfolioDisplay() {
                            // ONLY target portfolio section
                            const portfolioSection = document.getElementById('portfolio-section');
                            if (!portfolioSection || portfolioSection.style.display !== 'block') return;

                            // Remove artwork details from PORTFOLIO ONLY (NOT events)
                            const artworkCards = document.querySelectorAll('#portfolioPage .artwork-card');
                            artworkCards.forEach(card => {
                                // EXCLUDE event cards from cleanup
                                if (!card.classList.contains('event-card') && !card.closest('#events-section')) {
                                    const title = card.querySelector('.artwork-title');
                                    const details = card.querySelector('.artwork-details');

                                    if (title) title.style.display = 'none';
                                    if (details) details.style.display = 'none';
                                }
                            });
                        }

                        // Run when portfolio loads
                        setInterval(cleanPortfolioDisplay, 2000);

                                                                // ==================== REMOVE PORTFOLIO HOVER EFFECTS ====================
                                                                function removePortfolioHoverEffects() {
                                                                    const portfolioSection = document.getElementById('portfolio-section');
                                                                    if (!portfolioSection || portfolioSection.style.display !== 'block') return;

                                                                    // Remove hover effects
                                                                    const artworkCards = document.querySelectorAll('#portfolioPage .artwork-card');
                                                                    artworkCards.forEach(card => {
                                                                        card.style.transform = 'none';
                                                                        card.style.transition = 'none';
                                                                    });

                                                                    // REMOVE MARGIN AND CENTER - with !important to prevent override
                                                                    document.querySelectorAll('#portfolioPage .artwork-image').forEach(container => {
                                                                        container.style.setProperty('margin-bottom', '0', 'important');
                                                                        container.style.setProperty('display', 'flex', 'important');
                                                                        container.style.setProperty('justify-content', 'center', 'important');
                                                                    });

                                                                    // CENTER IMAGES - FIXED (removed nested loop)
                                                                    document.querySelectorAll('#portfolioPage .artwork-image img').forEach(img => {
                                                                        img.style.setProperty('width', 'auto', 'important');
                                                                        img.style.setProperty('max-width', '80%', 'important');
                                                                        img.style.setProperty('height', 'auto', 'important');
                                                                    });
                                                                }


                                                                // ==================== EVENT LISTENERS ====================
                                                                document.addEventListener('DOMContentLoaded', function() {
                                                                initializeApp();
                                                                initPopupHandlers();

                                                                //  FIX STYLE BROWSER AUTO-CLOSE - KEEP ONLY THIS (REMOVE THE DUPLICATE)
                                                                const styleBrowserModal = document.getElementById('styleBrowserModal');
                                                                if (styleBrowserModal) {
                                                                    styleBrowserModal.addEventListener('click', function(e) {
                                                                        if (e.target === this) {
                                                                            hideStyleBrowser();
                                                                        }
                                                                    });
                                                                }

                                                                    // Form switching
                                                                    document.getElementById('switchToSignUp').addEventListener('click', showSignUpForm);
                                                                    document.getElementById('switchToSignIn').addEventListener('click', showSignInForm);

                                                                    // Artwork form
                                                                    document.getElementById('artworkUploadForm').addEventListener('submit', function(e) {
                                                                        e.preventDefault();
                                                                        uploadArtwork();
                                                                    });

                                                                // Image upload
                                                                document.getElementById('uploadZone').addEventListener('click', function() {
                                                                document.getElementById('imageInput').click();
                                                                });
                                                                document.getElementById('imageInput').addEventListener('change', handleImageSelect);

                                                                // Profile form
                                                                    document.getElementById('profileSettingsForm').addEventListener('submit', async function(e) {
                                                                        e.preventDefault();
                                                                        const submitBtn = document.getElementById('profileSubmitBtn');
                                                                        const submitText = document.getElementById('profileSubmitText');

                                                                        submitBtn.disabled = true;
                                                                        submitText.innerHTML = '<span class="loading-spinner"></span> Saving...';

                                                                        try {
                                                                            const { data: { user } } = await supabaseClient.auth.getUser();
                                                                            if (!user) throw new Error('Not authenticated');

                                                                            const cvFileInput = document.getElementById('cvUpload');
                                                                            const cvFile = cvFileInput.files[0];
                                                                            let cvUrl = null;
                                                                            let hasCV = false;

                                                                            // Handle CV file upload if a new file is selected
                                                                            if (cvFile) {
                                                                                cvUrl = await handleCVUpload(cvFile);
                                                                                if (cvUrl) {
                                                                                    hasCV = true;
                                                                                }
                                                                            } else {
                                                                                // No new CV file - check existing CV status
                                                                                const { data: currentProfile } = await supabaseClient
                                                                                    .from('profiles')
                                                                                    .select('has_cv, cv_url')
                                                                                    .eq('id', user.id)
                                                                                    .single();

                                                                                hasCV = currentProfile?.has_cv || false;
                                                                                cvUrl = currentProfile?.cv_url || null;
                                                                            }

                                                                            const updateData = {
                                                                                username: document.getElementById('username').value,
                                                                                full_name: document.getElementById('profileFullName').value,
                                                                                bio: document.getElementById('bio').value,
                                                                                website: document.getElementById('website').value,
                                                                                contact_email: document.getElementById('contactEmail').value,
                                                                                social_links: getSocialPlatformsData(),
                                                                                has_cv: hasCV,
                                                                                cv_url: cvUrl,
                                                                                portfolio_layout: 'grid-classic',
                                                                                is_public: true
                                                                            };

                                                                            console.log(' updateData being saved:', JSON.stringify(updateData, null, 2));

                                                                            const { error } = await supabaseClient
                                                                                .from('profiles')
                                                                                .update(updateData)
                                                                                .eq('id', user.id);

                                                                            if (error) throw error;

                                                                            showToast('Profile saved' + (cvFile ? ' + CV uploaded' : ''));

                                                                            //  KEEP THIS LINE ONLY:
                                                                            updateCVStatusDisplay(hasCV, cvUrl);

                                                                        } catch (error) {
                                                                            console.error('Save error:', error);
                                                                            showToast('Error saving: ' + error.message, 'error');
                                                                        } finally {
                                                                            submitBtn.disabled = false;
                                                                            submitText.textContent = 'Save Profile';
                                                                        }
                                                                    });

                                                                // Event form
                                                                document.getElementById('eventForm').addEventListener('submit', function(e) {
                                                                createEvent(e);
                                                                e.preventDefault();
                                                                const formData = new FormData(this);
                                                                createEvent({
                                                                title: formData.get('title'),
                                                                eventType: formData.get('eventType'),
                                                                eventDate: formData.get('eventDate'),
                                                                location: formData.get('location'),
                                                                description: formData.get('description')
                                                                });
                                                                });

                                                                    // Add profile photo upload handler
                                                                    document.getElementById('profilePhoto').addEventListener('change', async function(e) {
                                                                        const file = e.target.files[0];
                                                                        if (!file) return;

                                                                        console.log('Uploading profile photo:', file.name);

                                                                        try {
                                                                            const { data: { user } } = await supabaseClient.auth.getUser();
                                                                            if (!user) return;

                                                                            // Upload to Supabase Storage
                                                                            const fileName = `${user.id}/profile_photo_${Date.now()}_${file.name}`;
                                                                            const { data, error } = await supabaseClient.storage
                                                                                .from('artwork-images')
                                                                                .upload(fileName, file);

                                                                            if (error) throw error;

                                                                            // Get public URL
                                                                            const { data: { publicUrl } } = supabaseClient.storage
                                                                                .from('artwork-images')
                                                                                .getPublicUrl(data.path);

                                                                            // Update profile with new photo URL
                                                                            const { error: updateError } = await supabaseClient
                                                                                .from('profiles')
                                                                                .update({ 
                                                                                    profile_photo_url: publicUrl,
                                                                                    has_profile_photo: true 
                                                                                })
                                                                                .eq('id', user.id);

                                                                            if (updateError) throw updateError;

                                                                            // Show preview
                                                                            document.getElementById('profilePhotoPreview').innerHTML = `
                                                                                <img src="${publicUrl}" alt="Profile Photo" style="max-width: 200px; border-radius: 8px;">
                                                                                <div style="margin-top: 0.5rem; color: green;"> Profile photo updated</div>
                                                                            `;

                                                                            showToast('Profile photo updated!');

                                                                        } catch (error) {
                                                                            console.error('Profile photo upload error:', error);
                                                                            showToast('Error uploading profile photo', 'error');
                                                                        }
                                                                    });

                                                                // Collection form
                                                                    document.getElementById('collectionForm').addEventListener('submit', async function(e) {
                                                                        e.preventDefault();
                                                                        const submitBtn = document.getElementById('collectionSubmitBtn');
                                                                        const submitText = document.getElementById('collectionSubmitText');

                                                                        try {
                                                                            const { data: { user } } = await supabaseClient.auth.getUser();
                                                                            if (!user) throw new Error('Not authenticated');

                                                                            const formData = new FormData(this);
                                                                            const title = formData.get('name');
                                                                            const statement = formData.get('statement');
                                                                            const artworkIds = formData.getAll('artworkIds');
                                                                            const isEdit = this.dataset.mode === 'edit';
                                                                            const collectionId = this.dataset.collectionId;

                                                                            if (!title) {
                                                                                showToast('Please enter a collection title', 'error');
                                                                                return;
                                                                            }

                                                                            // Set loading state
                                                                            submitBtn.disabled = true;
                                                                            submitText.innerHTML = '<span class="loading-spinner"></span> Saving...';

                                                                            if (isEdit && collectionId) {
                                                                                // UPDATE EXISTING COLLECTION
                                                                                const { error: updateError } = await supabaseClient
                                                                                    .from('collections')
                                                                                    .update({
                                                                                        name: title,
                                                                                        description: statement
                                                                                    })
                                                                                    .eq('id', collectionId)
                                                                                    .eq('artist_id', user.id);

                                                                                if (updateError) throw updateError;

                                                                                // Update artwork connections
                                                                                await updateCollectionArtworks(collectionId, artworkIds);

                                                                                showToast('Collection updated');

                                                                            } else {
                                                                                // CREATE NEW COLLECTION
                                                                                const { data: collection, error: createError } = await supabaseClient
                                                                                    .from('collections')
                                                                                    .insert([{
                                                                                        name: title,
                                                                                        description: statement,
                                                                                        artist_id: user.id,
                                                                                        is_public: true
                                                                                    }])
                                                                                    .select()
                                                                                    .single();

                                                                                if (createError) throw createError;

                                                                                // Add artworks to collection
                                                                                if (artworkIds.length > 0) {
                                                                                    await updateCollectionArtworks(collection.id, artworkIds);
                                                                                }

                                                                                showToast('Collection created');
                                                                            }

                                                                            hideCreateCollectionForm();
                                                                            loadProfileCollections();
                                                                            clearPortfolioCache();

                                                                        } catch (error) {
                                                                            console.error('Error saving collection:', error);
                                                                            showToast('Error saving collection: ' + error.message, 'error');
                                                                        } finally {
                                                                            submitBtn.disabled = false;
                                                                            submitText.textContent = isEdit ? 'Update Collection' : 'Create Collection';
                                                                        }
                                                                    });

                                                                    async function updateCollectionArtworks(collectionId, artworkIds) {
                                                                        try {
                                                                            // First, remove all existing artwork connections
                                                                            const { error: deleteError } = await supabaseClient
                                                                                .from('artwork_collections')
                                                                                .delete()
                                                                                .eq('collection_id', collectionId);

                                                                            if (deleteError) throw deleteError;

                                                                            // Then add the selected artworks
                                                                            if (artworkIds.length > 0) {
                                                                                const collectionArtworks = artworkIds.map(artworkId => ({
                                                                                    collection_id: collectionId,
                                                                                    artwork_id: artworkId
                                                                                }));

                                                                                const { error: insertError } = await supabaseClient
                                                                                    .from('artwork_collections')
                                                                                    .insert(collectionArtworks);

                                                                                if (insertError) throw insertError;
                                                                            }

                                                                        } catch (error) {
                                                                            console.error('Error updating collection artworks:', error);
                                                                            throw error;
                                                                        }
                                                                    }

                                                                // CV Request Form
                                                                document.getElementById('cvRequestForm').addEventListener('submit', submitCVRequest);

                                                                    // Event upload zone click handler
                                                                    const eventUploadZone = document.getElementById('eventUploadZone');
                                                                    if (eventUploadZone) {
                                                                        eventUploadZone.addEventListener('click', function() {
                                                                            document.getElementById('eventImageInput').click();
                                                                        });

                                                                        // Drag and drop for event upload zone
                                                                        eventUploadZone.addEventListener('dragover', handleEventDragOver);
                                                                        eventUploadZone.addEventListener('dragleave', function(e) {
                                                                            e.preventDefault();
                                                                            this.classList.remove('dragover');
                                                                        });
                                                                        eventUploadZone.addEventListener('drop', handleEventDrop);
                                                                    }

                                                                    // Event image input change handler
                                                                    const eventImageInput = document.getElementById('eventImageInput');
                                                                    if (eventImageInput) {
                                                                        eventImageInput.addEventListener('change', handleEventImageSelect);
                                                                    }

                                                                // WIP Project Form
                                                                document.getElementById('wipProjectForm').addEventListener('submit', async function(e) {
                                                                        e.preventDefault();
                                                                        await createWipProject();
                                                                    });

                                                                // Event image upload
                                                                    const eventImageUpload = document.getElementById('eventImageUpload');
                                                                    if (eventImageUpload) {
                                                                        eventImageUpload.addEventListener('change', handleEventImageSelect);
                                                                    }

                                                                // Close popup on background click
                                                                document.getElementById('artworkPopup').addEventListener('click', function(e) {
                                                                if (e.target === this) closeArtworkPopup();
                                                                });

                                                                // Close portfolio popup on background click  
                                                                document.getElementById('artworkPopup').addEventListener('click', function(e) {
                                                                if (e.target === this) {
                                                                closePopup();
                                                                }
                                                                });

                                                                // Close CV modal on background click
                                                                document.getElementById('cvRequestModal').addEventListener('click', function(e) {
                                                                if (e.target === this) hideCVRequestForm();
                                                                });

                                                                // ESC key to close popups
                                                                document.addEventListener('keydown', function(e) {
                                                                if (e.key === 'Escape') {
                                                                closeArtworkPopup();
                                                                hideUploadForm();
                                                                hideStyleBrowser();
                                                                hideAddEventForm();
                                                                hideCreateCollectionForm();
                                                                hideCVRequestForm();
                                                                }
                                                                });

                                                                                                        // Close on ESC key
                                                                                                        document.addEventListener('keydown', function(e) {
                                                                                                            if (e.key === 'Escape') {
                                                                                                                closePopup();
                                                                                                            }
                                                                                                        });

                                                                                                        // Close on background click  
                                                                                                        document.addEventListener('click', function(e) {
                                                                                                            if (e.target.id === 'artworkPopup') {
                                                                                                                closePopup();
                                                                                                            }
                                                                                                        });

                                                                                                        // Initialize when page loads
                                                                                                        setTimeout(() => {
                                                                                                            initPopupSystem();
                                                                                                            initPortfolioClickHandlers();
                                                                                                        }, 1000);

                                                                // Drag and drop for upload zone
                                                                const uploadZone = document.getElementById('uploadZone');
                                                                if (uploadZone) {
                                                                uploadZone.addEventListener('dragover', function(e) {
                                                                e.preventDefault();
                                                                this.classList.add('dragover');
                                                                });

                                                                uploadZone.addEventListener('dragleave', function(e) {
                                                                e.preventDefault();
                                                                this.classList.remove('dragover');
                                                                });

                                                                uploadZone.addEventListener('drop', function(e) {
                                                                e.preventDefault();
                                                                this.classList.remove('dragover');
                                                                if (e.dataTransfer.files.length > 0) {
                                                                handleImageFile(e.dataTransfer.files[0]);
                                                                }
                                                                });
                                                                }
                                                                });

                                                                // ==================== CSS ANIMATIONS FOR TRAC BRAND ====================
                                                                const tracAnimations = document.createElement('style');
                                                                tracAnimations.textContent = `
                                                                @keyframes slideInRight {
                                                                from { transform: translateX(100%); opacity: 0; }
                                                                to { transform: translateX(0); opacity: 1; }
                                                                }
                                                                @keyframes slideOutRight {
                                                                from { transform: translateX(0); opacity: 1; }
                                                                to { transform: translateX(100%); opacity: 0; }
                                                                }
                                                                @keyframes fadeIn {
                                                                from { opacity: 0; }
                                                                to { opacity: 1; }
                                                                }
                                                                @keyframes scaleIn {
                                                                from { transform: scale(0.9); opacity: 0; }
                                                                to { transform: scale(1); opacity: 1; }
                                                                }
                                                                `;
                                                                document.head.appendChild(tracAnimations);

                                                                </script>